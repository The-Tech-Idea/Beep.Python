{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="bi bi-people me-2"></i>User Management</h1>
        <p class="text-muted mb-0">Manage users and their API tokens for middleware access</p>
    </div>
    <div>
        <button class="btn btn-primary" onclick="showCreateUserModal()">
            <i class="bi bi-person-plus me-2"></i>Create User
        </button>
        <a href="{{ url_for('ai_middleware.api_manage_services') }}" class="btn btn-outline-light ms-2">
            <i class="bi bi-arrow-left me-2"></i>Back to Services
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Users</h5>
                <button class="btn btn-sm btn-outline-light" onclick="loadUsers()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="users-container">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="userModalLabel">Create User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="user-id" name="id">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="user-username" class="form-label">Username *</label>
                            <input type="text" class="form-control bg-secondary border-secondary text-light" id="user-username" name="username" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="user-email" class="form-label">Email</label>
                            <input type="email" class="form-control bg-secondary border-secondary text-light" id="user-email" name="email">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="user-display-name" class="form-label">Display Name</label>
                            <input type="text" class="form-control bg-secondary border-secondary text-light" id="user-display-name" name="display_name">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="user-password" class="form-label">Password <span id="password-required" class="text-danger">*</span></label>
                            <input type="password" class="form-control bg-secondary border-secondary text-light" id="user-password" name="password">
                            <small class="text-muted">Leave empty when editing to keep current password</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="user-role" class="form-label">Role</label>
                            <select class="form-select bg-secondary border-secondary text-light" id="user-role" name="role_id">
                                <option value="">No Role</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="user-is-admin" name="is_admin">
                                <label class="form-check-label" for="user-is-admin">Admin</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="user-is-active" name="is_active" checked>
                                <label class="form-check-label" for="user-is-active">Active</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>
</div>

<!-- Token Display Modal -->
<div class="modal fade" id="tokenModal" tabindex="-1" aria-labelledby="tokenModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="tokenModalLabel">API Token Created</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Save this token now! It will not be shown again.
                </div>
                <div class="mb-3">
                    <label class="form-label">API Token:</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-secondary border-secondary text-light" id="token-display" readonly>
                        <button class="btn btn-outline-light" onclick="copyToken()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="alert alert-info small mb-0">
                    <strong>Usage:</strong> Include this token in requests:<br>
                    <code>Authorization: Bearer YOUR_TOKEN</code><br>
                    or<br>
                    <code>X-API-Token: YOUR_TOKEN</code>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I've Saved It</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Token Modal -->
<div class="modal fade" id="createTokenModal" tabindex="-1" aria-labelledby="createTokenModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="createTokenModalLabel">Create API Token</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="tokenForm">
                    <input type="hidden" id="token-user-id" name="user_id">
                    
                    <div class="mb-3">
                        <label for="token-name" class="form-label">Token Name</label>
                        <input type="text" class="form-control bg-secondary border-secondary text-light" id="token-name" name="name" placeholder="e.g., Production API Key">
                        <small class="text-muted">Optional: A descriptive name for this token</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="token-expires" class="form-label">Expires In (Days)</label>
                        <input type="number" class="form-control bg-secondary border-secondary text-light" id="token-expires" name="expires_in_days" min="1" placeholder="Leave empty for no expiration">
                        <small class="text-muted">Optional: Token will expire after this many days</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createToken()">Create Token</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let users = [];
let currentUserTokens = {};

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

function loadUsers() {
    fetch('/ai-middleware/api/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                users = data.users;
                renderUsers();
            } else {
                showError('Failed to load users: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            showError('Error loading users: ' + error.message);
        });
}

function renderUsers() {
    const container = document.getElementById('users-container');
    
    if (users.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox display-4 text-muted"></i>
                <p class="text-muted mt-3">No users found</p>
                <button class="btn btn-primary" onclick="showCreateUserModal()">
                    <i class="bi bi-person-plus me-2"></i>Create First User
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = users.map(user => `
        <div class="card bg-secondary border-${user.is_active ? 'success' : 'danger'} mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 me-2">${escapeHtml(user.display_name || user.username)}</h6>
                            ${user.is_admin ? '<span class="badge bg-danger me-1">Admin</span>' : ''}
                            <span class="badge bg-${user.is_active ? 'success' : 'secondary'}">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <p class="text-muted small mb-2">
                            <i class="bi bi-person me-1"></i>${escapeHtml(user.username)}
                            ${user.email ? `<br><i class="bi bi-envelope me-1"></i>${escapeHtml(user.email)}` : ''}
                            ${user.role ? `<br><i class="bi bi-shield me-1"></i>Role: ${escapeHtml(user.role.name)}` : ''}
                        </p>
                        <div id="tokens-${user.id}" class="mt-2">
                            <button class="btn btn-sm btn-outline-info" onclick="loadUserTokens(${user.id})">
                                <i class="bi bi-key me-1"></i>View Tokens
                            </button>
                            <button class="btn btn-sm btn-outline-success ms-1" onclick="showCreateTokenModal(${user.id}, '${escapeHtml(user.username)}')">
                                <i class="bi bi-plus-circle me-1"></i>Create Token
                            </button>
                        </div>
                    </div>
                    <div class="ms-3">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showCreateUserModal() {
    document.getElementById('userForm').reset();
    document.getElementById('user-id').value = '';
    document.getElementById('user-is-active').checked = true;
    document.getElementById('password-required').style.display = 'inline';
    document.getElementById('userModalLabel').textContent = 'Create User';
    
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function editUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    
    document.getElementById('user-id').value = user.id;
    document.getElementById('user-username').value = user.username;
    document.getElementById('user-email').value = user.email || '';
    document.getElementById('user-display-name').value = user.display_name || '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-is-admin').checked = user.is_admin;
    document.getElementById('user-is-active').checked = user.is_active;
    document.getElementById('user-role').value = user.role ? user.role.id : '';
    document.getElementById('password-required').style.display = 'none';
    document.getElementById('userModalLabel').textContent = 'Edit User';
    
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function saveUser() {
    const form = document.getElementById('userForm');
    const userId = document.getElementById('user-id').value;
    const isNew = !userId;
    
    if (isNew && !document.getElementById('user-password').value) {
        alert('Password is required for new users');
        return;
    }
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const userData = {
        username: document.getElementById('user-username').value,
        email: document.getElementById('user-email').value || null,
        display_name: document.getElementById('user-display-name').value || null,
        is_admin: document.getElementById('user-is-admin').checked,
        is_active: document.getElementById('user-is-active').checked,
        role_id: document.getElementById('user-role').value || null
    };
    
    const password = document.getElementById('user-password').value;
    if (password) {
        userData.password = password;
    }
    
    const url = userId ? `/ai-middleware/api/users/${userId}` : '/ai-middleware/api/users';
    const method = userId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                loadUsers();
                showSuccess(userId ? 'User updated successfully' : 'User created successfully');
            } else {
                showError('Failed to save user: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving user:', error);
            showError('Error saving user: ' + error.message);
        });
}

function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? All their API tokens will be revoked.')) {
        return;
    }
    
    fetch(`/ai-middleware/api/users/${userId}`, {
        method: 'DELETE'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUsers();
                showSuccess('User deleted successfully');
            } else {
                showError('Failed to delete user: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showError('Error deleting user: ' + error.message);
        });
}

function loadUserTokens(userId) {
    fetch(`/ai-middleware/api/users/${userId}/tokens`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentUserTokens[userId] = data.tokens;
                renderUserTokens(userId);
            } else {
                showError('Failed to load tokens: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading tokens:', error);
            showError('Error loading tokens: ' + error.message);
        });
}

function renderUserTokens(userId) {
    const container = document.getElementById(`tokens-${userId}`);
    const tokens = currentUserTokens[userId] || [];
    
    if (tokens.length === 0) {
        container.innerHTML = `
            <div class="mt-2">
                <small class="text-muted">No API tokens</small>
                <button class="btn btn-sm btn-outline-success ms-2" onclick="showCreateTokenModal(${userId}, '${users.find(u => u.id === userId)?.username || ''}')">
                    <i class="bi bi-plus-circle me-1"></i>Create Token
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="mt-2">
            <small class="text-muted d-block mb-2">API Tokens:</small>
            ${tokens.map(token => `
                <div class="d-flex align-items-center mb-1">
                    <code class="bg-dark px-2 py-1 rounded me-2">${token.token}</code>
                    <span class="badge bg-${token.is_active ? 'success' : 'secondary'} me-1">${token.is_active ? 'Active' : 'Revoked'}</span>
                    ${token.is_expired ? '<span class="badge bg-warning me-1">Expired</span>' : ''}
                    ${token.name ? `<small class="text-muted me-2">${escapeHtml(token.name)}</small>` : ''}
                    ${token.is_active && !token.is_expired ? `
                        <button class="btn btn-sm btn-outline-danger ms-auto" onclick="revokeToken(${token.id}, ${userId})">
                            <i class="bi bi-x-circle"></i> Revoke
                        </button>
                    ` : ''}
                </div>
            `).join('')}
            <button class="btn btn-sm btn-outline-success mt-2" onclick="showCreateTokenModal(${userId}, '${users.find(u => u.id === userId)?.username || ''}')">
                <i class="bi bi-plus-circle me-1"></i>Create New Token
            </button>
        </div>
    `;
}

function showCreateTokenModal(userId, username) {
    document.getElementById('tokenForm').reset();
    document.getElementById('token-user-id').value = userId;
    document.getElementById('createTokenModalLabel').textContent = `Create API Token for ${username}`;
    
    const modal = new bootstrap.Modal(document.getElementById('createTokenModal'));
    modal.show();
}

function createToken() {
    const userId = document.getElementById('token-user-id').value;
    const name = document.getElementById('token-name').value || null;
    const expiresInDays = document.getElementById('token-expires').value ? parseInt(document.getElementById('token-expires').value) : null;
    
    fetch(`/ai-middleware/api/users/${userId}/tokens`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            expires_in_days: expiresInDays
        })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('createTokenModal')).hide();
                
                // Show token in modal
                document.getElementById('token-display').value = data.token;
                const tokenModal = new bootstrap.Modal(document.getElementById('tokenModal'));
                tokenModal.show();
                
                // Reload tokens
                loadUserTokens(parseInt(userId));
            } else {
                showError('Failed to create token: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating token:', error);
            showError('Error creating token: ' + error.message);
        });
}

function revokeToken(tokenId, userId) {
    if (!confirm('Are you sure you want to revoke this token? It will no longer work.')) {
        return;
    }
    
    fetch(`/ai-middleware/api/tokens/${tokenId}`, {
        method: 'DELETE'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUserTokens(userId);
                showSuccess('Token revoked successfully');
            } else {
                showError('Failed to revoke token: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error revoking token:', error);
            showError('Error revoking token: ' + error.message);
        });
}

function copyToken() {
    const tokenInput = document.getElementById('token-display');
    tokenInput.select();
    document.execCommand('copy');
    showSuccess('Token copied to clipboard!');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showSuccess(message) {
    // Use Bootstrap toast or alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}
</script>
{% endblock %}
