{% extends "base.html" %}

{% block title %}Middleware Routing Rules{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="bi bi-diagram-3 me-2"></i>Routing Rules</h1>
        <p class="text-muted mb-0">Configure rules to automatically route, filter, or block requests based on keywords, patterns, or context</p>
    </div>
    <div>
        <button class="btn btn-primary" onclick="showCreateRuleModal()">
            <i class="bi bi-plus-circle me-2"></i>Create Rule
        </button>
        <a href="{{ url_for('ai_middleware.api_manage_services') }}" class="btn btn-outline-light ms-2">
            <i class="bi bi-arrow-left me-2"></i>Back to Services
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Routing Rules</h5>
                <button class="btn btn-sm btn-outline-light" onclick="loadRules()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="rules-container">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading rules...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Rule Modal -->
<div class="modal fade" id="ruleModal" tabindex="-1" aria-labelledby="ruleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="ruleModalLabel">Create Routing Rule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="rule-id" name="id">
                    
                    <div class="mb-3">
                        <label for="rule-name" class="form-label">Rule Name *</label>
                        <input type="text" class="form-control bg-secondary border-secondary text-light" id="rule-name" name="name" required>
                        <small class="text-muted">A descriptive name for this rule</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rule-description" class="form-label">Description</label>
                        <textarea class="form-control bg-secondary border-secondary text-light" id="rule-description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rule-type" class="form-label">Rule Type *</label>
                            <select class="form-select bg-secondary border-secondary text-light" id="rule-type" name="rule_type" required>
                                <option value="keyword">Keyword</option>
                                <option value="pattern">Pattern (Regex)</option>
                                <option value="question">Question</option>
                                <option value="user">User/Role</option>
                                <option value="context">Context</option>
                            </select>
                            <small class="text-muted">How to match the request</small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="rule-pattern" class="form-label">Pattern *</label>
                            <input type="text" class="form-control bg-secondary border-secondary text-light" id="rule-pattern" name="pattern" required>
                            <small class="text-muted" id="pattern-help">Keywords (comma-separated), regex, or question text</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rule-action" class="form-label">Action *</label>
                            <select class="form-select bg-secondary border-secondary text-light" id="rule-action" name="action" required>
                                <option value="route">Route</option>
                                <option value="block">Block</option>
                                <option value="filter">Filter</option>
                                <option value="chain">Chain Services</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="rule-priority" class="form-label">Priority</label>
                            <input type="number" class="form-control bg-secondary border-secondary text-light" id="rule-priority" name="priority" value="0" min="0" max="100">
                            <small class="text-muted">Higher priority rules execute first</small>
                        </div>
                    </div>
                    
                    <div id="route-options" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rule-target-service" class="form-label">Target Service</label>
                                <select class="form-select bg-secondary border-secondary text-light" id="rule-target-service" name="target_service">
                                    <option value="">Default</option>
                                    <option value="llm">LLM</option>
                                    <option value="text_to_image">Text to Image</option>
                                    <option value="text_to_speech">Text to Speech</option>
                                    <option value="speech_to_text">Speech to Text</option>
                                    <option value="rag">RAG</option>
                                    <option value="document_extraction">Document Extraction</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="rule-target-api" class="form-label">Target API/Method</label>
                                <input type="text" class="form-control bg-secondary border-secondary text-light" id="rule-target-api" name="target_api" placeholder="e.g., generate_image, chat">
                            </div>
                        </div>
                    </div>
                    
                    <div id="block-options" style="display: none;">
                        <div class="mb-3">
                            <label for="block-message" class="form-label">Block Message</label>
                            <input type="text" class="form-control bg-secondary border-secondary text-light" id="block-message" name="block_message" placeholder="Message to show when blocked">
                        </div>
                    </div>
                    
                    <div id="filter-options" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Filter Options</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="filter-remove-keywords">
                                <label class="form-check-label" for="filter-remove-keywords">Remove Keywords</label>
                            </div>
                            <small class="text-muted">Configure filters in conditions JSON</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="rule-enabled" name="enabled" checked>
                            <label class="form-check-label" for="rule-enabled">Enabled</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">Save Rule</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let rules = [];

document.addEventListener('DOMContentLoaded', function() {
    loadRules();
    
    // Update form based on action type
    document.getElementById('rule-action').addEventListener('change', function() {
        const action = this.value;
        document.getElementById('route-options').style.display = action === 'route' ? 'block' : 'none';
        document.getElementById('block-options').style.display = action === 'block' ? 'block' : 'none';
        document.getElementById('filter-options').style.display = action === 'filter' ? 'block' : 'none';
    });
    
    // Update pattern help text based on rule type
    document.getElementById('rule-type').addEventListener('change', function() {
        const type = this.value;
        const help = document.getElementById('pattern-help');
        const examples = {
            'keyword': 'Example: generate image, create image, draw',
            'pattern': 'Example: ^(generate|create|draw)\\s+image',
            'question': 'Example: What is the weather today?',
            'user': 'Example: user123 or role:admin',
            'context': 'Example: domain or context_key'
        };
        help.textContent = examples[type] || 'Enter pattern value';
    });
});

function loadRules() {
    fetch('/ai-middleware/api/middleware/rules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                rules = data.rules;
                renderRules();
            } else {
                showError('Failed to load rules: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading rules:', error);
            showError('Error loading rules: ' + error.message);
        });
}

function renderRules() {
    const container = document.getElementById('rules-container');
    
    if (rules.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox display-4 text-muted"></i>
                <p class="text-muted mt-3">No routing rules configured</p>
                <button class="btn btn-primary" onclick="showCreateRuleModal()">
                    <i class="bi bi-plus-circle me-2"></i>Create First Rule
                </button>
            </div>
        `;
        return;
    }
    
    // Sort by priority (higher first)
    const sortedRules = [...rules].sort((a, b) => (b.priority || 0) - (a.priority || 0));
    
    container.innerHTML = sortedRules.map(rule => `
        <div class="card bg-secondary border-${rule.enabled ? 'primary' : 'secondary'} mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 me-2">${escapeHtml(rule.name)}</h6>
                            ${rule.enabled 
                                ? '<span class="badge bg-success me-2">Enabled</span>' 
                                : '<span class="badge bg-secondary me-2">Disabled</span>'}
                            <span class="badge bg-info">Priority: ${rule.priority || 0}</span>
                        </div>
                        <p class="text-muted small mb-2">${escapeHtml(rule.description || 'No description')}</p>
                        <div class="mb-2">
                            <span class="badge bg-dark me-1">Type: ${rule.rule_type}</span>
                            <span class="badge bg-dark me-1">Action: ${rule.action}</span>
                            <code class="text-light small">${escapeHtml(rule.pattern)}</code>
                        </div>
                        ${rule.target_service 
                            ? `<div class="small text-muted">Routes to: <strong>${rule.target_service}</strong>${rule.target_api ? ` â†’ ${rule.target_api}` : ''}</div>` 
                            : ''}
                    </div>
                    <div class="ms-3">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editRule('${rule.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRule('${rule.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showCreateRuleModal() {
    document.getElementById('ruleForm').reset();
    document.getElementById('rule-id').value = '';
    document.getElementById('rule-enabled').checked = true;
    document.getElementById('rule-priority').value = '0';
    document.getElementById('ruleModalLabel').textContent = 'Create Routing Rule';
    document.getElementById('route-options').style.display = 'none';
    document.getElementById('block-options').style.display = 'none';
    document.getElementById('filter-options').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('ruleModal'));
    modal.show();
}

function editRule(ruleId) {
    const rule = rules.find(r => r.id === ruleId);
    if (!rule) return;
    
    document.getElementById('rule-id').value = rule.id;
    document.getElementById('rule-name').value = rule.name;
    document.getElementById('rule-description').value = rule.description || '';
    document.getElementById('rule-type').value = rule.rule_type;
    document.getElementById('rule-pattern').value = rule.pattern;
    document.getElementById('rule-action').value = rule.action;
    document.getElementById('rule-priority').value = rule.priority || 0;
    document.getElementById('rule-enabled').checked = rule.enabled;
    
    if (rule.target_service) {
        document.getElementById('rule-target-service').value = rule.target_service;
    }
    if (rule.target_api) {
        document.getElementById('rule-target-api').value = rule.target_api;
    }
    
    if (rule.conditions && rule.conditions.message) {
        document.getElementById('block-message').value = rule.conditions.message;
    }
    
    // Update form visibility
    document.getElementById('rule-action').dispatchEvent(new Event('change'));
    document.getElementById('rule-type').dispatchEvent(new Event('change'));
    
    document.getElementById('ruleModalLabel').textContent = 'Edit Routing Rule';
    
    const modal = new bootstrap.Modal(document.getElementById('ruleModal'));
    modal.show();
}

function saveRule() {
    const form = document.getElementById('ruleForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const ruleId = document.getElementById('rule-id').value;
    const action = document.getElementById('rule-action').value;
    
    const ruleData = {
        name: document.getElementById('rule-name').value,
        description: document.getElementById('rule-description').value,
        rule_type: document.getElementById('rule-type').value,
        pattern: document.getElementById('rule-pattern').value,
        action: action,
        priority: parseInt(document.getElementById('rule-priority').value) || 0,
        enabled: document.getElementById('rule-enabled').checked,
        conditions: {}
    };
    
    if (action === 'route') {
        ruleData.target_service = document.getElementById('rule-target-service').value || null;
        ruleData.target_api = document.getElementById('rule-target-api').value || null;
    } else if (action === 'block') {
        const blockMessage = document.getElementById('block-message').value;
        if (blockMessage) {
            ruleData.conditions.message = blockMessage;
        }
    } else if (action === 'filter') {
        ruleData.conditions.filters = {
            remove_keywords: []
        };
    }
    
    const url = ruleId 
        ? `/ai-middleware/api/middleware/rules/${ruleId}`
        : '/ai-middleware/api/middleware/rules';
    const method = ruleId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(ruleData)
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();
                loadRules();
                showSuccess(ruleId ? 'Rule updated successfully' : 'Rule created successfully');
            } else {
                showError('Failed to save rule: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving rule:', error);
            showError('Error saving rule: ' + error.message);
        });
}

function deleteRule(ruleId) {
    if (!confirm('Are you sure you want to delete this rule?')) {
        return;
    }
    
    fetch(`/ai-middleware/api/middleware/rules/${ruleId}`, {
        method: 'DELETE'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadRules();
                showSuccess('Rule deleted successfully');
            } else {
                showError('Failed to delete rule: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting rule:', error);
            showError('Error deleting rule: ' + error.message);
        });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showSuccess(message) {
    // You can use Bootstrap toast or alert
    alert(message); // Simple for now
}

function showError(message) {
    alert('Error: ' + message); // Simple for now
}
</script>
{% endblock %}

