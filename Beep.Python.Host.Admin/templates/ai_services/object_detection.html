{% extends "ai_services/base_service.html" %}

{% block service_content %}
<!-- Object Detection Service Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-bounding-box me-2"></i>Detect Objects in Image</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="model-select" class="form-label">Detection Model</label>
                    <select class="form-select" id="model-select">
                        <!-- Models will be loaded dynamically -->
                    </select>
                    <small class="text-muted">Select the object detection model to use (YOLO, DETR, etc.)</small>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="confidence-threshold" class="form-label">Confidence Threshold</label>
                        <input type="number" class="form-control" id="confidence-threshold" min="0" max="1" step="0.05" value="0.5">
                        <small class="text-muted">Minimum confidence score (0.0-1.0). Lower values detect more objects but may include false positives.</small>
                    </div>
                    <div class="col-md-6">
                        <label for="max-detections" class="form-label">Max Detections</label>
                        <input type="number" class="form-control" id="max-detections" min="1" max="500" value="100">
                        <small class="text-muted">Maximum number of objects to detect (1-500)</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="image-upload" class="form-label">Upload Image</label>
                    <input type="file" class="form-control" id="image-upload" accept="image/*">
                    <small class="text-muted">Upload an image to detect objects (JPG, PNG, etc.)</small>
                </div>
                
                <div class="mb-3" id="image-preview-container" style="display: none;">
                    <label class="form-label">Image Preview</label>
                    <div class="border rounded p-2 bg-secondary bg-opacity-25">
                        <img id="image-preview" src="" alt="Preview" class="img-fluid" style="max-height: 400px;">
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary" id="btn-detect" disabled>
                    <i class="bi bi-search me-2"></i>Detect Objects
                </button>
                
                <!-- Detection Progress -->
                <div id="detection-progress" class="mt-4" style="display: none;">
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="detection-progress-bar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <p class="text-muted small mb-0" id="detection-status">Initializing detection...</p>
                </div>
                
                <!-- Detection Results -->
                <div id="detection-results" class="mt-4" style="display: none;">
                    <h6 class="mb-3"><i class="bi bi-list-check me-2"></i>Detection Results</h6>
                    <div id="results-summary" class="alert alert-info mb-3">
                        <!-- Summary will be shown here -->
                    </div>
                    <div id="detections-list" class="list-group">
                        <!-- Detections will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('model-select');
    const imageUpload = document.getElementById('image-upload');
    const imagePreview = document.getElementById('image-preview');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const btnDetect = document.getElementById('btn-detect');
    const confidenceThreshold = document.getElementById('confidence-threshold');
    const maxDetections = document.getElementById('max-detections');
    const detectionProgress = document.getElementById('detection-progress');
    const detectionProgressBar = document.getElementById('detection-progress-bar');
    const detectionStatus = document.getElementById('detection-status');
    const detectionResults = document.getElementById('detection-results');
    const resultsSummary = document.getElementById('results-summary');
    const detectionsList = document.getElementById('detections-list');
    
    let currentImageFile = null;
    let currentTaskId = null;
    
    // Load models
    function loadModels() {
        fetch('/llm/models?type=object_detection')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.models) {
                    modelSelect.innerHTML = '<option value="">Select a model...</option>';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.model_id;
                        option.textContent = `${model.model_id} ${model.selected ? '(Selected)' : ''}`;
                        if (model.selected) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                    
                    // Enable detect button if image is uploaded
                    if (currentImageFile) {
                        btnDetect.disabled = false;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading models:', error);
            });
    }
    
    // Handle image upload
    imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreviewContainer.style.display = 'block';
                btnDetect.disabled = !modelSelect.value;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Handle model selection
    modelSelect.addEventListener('change', function() {
        btnDetect.disabled = !currentImageFile || !this.value;
    });
    
    // Detect objects
    btnDetect.addEventListener('click', function() {
        if (!currentImageFile || !modelSelect.value) {
            alert('Please select a model and upload an image');
            return;
        }
        
        const formData = new FormData();
        formData.append('image', currentImageFile);
        formData.append('model_id', modelSelect.value);
        formData.append('confidence_threshold', confidenceThreshold.value);
        formData.append('max_detections', maxDetections.value);
        
        // Show progress
        detectionProgress.style.display = 'block';
        detectionProgressBar.style.width = '10%';
        detectionStatus.textContent = 'Starting detection...';
        detectionResults.style.display = 'none';
        btnDetect.disabled = true;
        
        fetch('/ai-services/api/object-detection/detect', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.task_id) {
                currentTaskId = data.task_id;
                pollDetectionStatus();
            } else {
                throw new Error(data.error || 'Failed to start detection');
            }
        })
        .catch(error => {
            console.error('Error starting detection:', error);
            detectionStatus.textContent = `Error: ${error.message}`;
            detectionProgressBar.style.width = '0%';
            btnDetect.disabled = false;
        });
    });
    
    // Poll detection status
    function pollDetectionStatus() {
        if (!currentTaskId) return;
        
        fetch(`/api/tasks/${currentTaskId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const task = data.task;
                    
                    // Update progress
                    if (task.progress !== undefined) {
                        detectionProgressBar.style.width = `${task.progress}%`;
                    }
                    
                    if (task.current_step_message) {
                        detectionStatus.textContent = task.current_step_message;
                    }
                    
                    // Check if complete
                    if (task.status === 'completed') {
                        detectionProgressBar.style.width = '100%';
                        detectionStatus.textContent = 'Detection complete!';
                        
                        // Show results
                        if (task.result && task.result.success) {
                            displayResults(task.result);
                        } else {
                            throw new Error(task.result?.error || 'Detection failed');
                        }
                        
                        btnDetect.disabled = false;
                        currentTaskId = null;
                    } else if (task.status === 'failed') {
                        throw new Error(task.error || 'Detection failed');
                    } else {
                        // Continue polling
                        setTimeout(pollDetectionStatus, 1000);
                    }
                } else {
                    throw new Error(data.error || 'Failed to get task status');
                }
            })
            .catch(error => {
                console.error('Error polling detection status:', error);
                detectionStatus.textContent = `Error: ${error.message}`;
                detectionProgressBar.style.width = '0%';
                btnDetect.disabled = false;
                currentTaskId = null;
            });
    }
    
    // Display results
    function displayResults(result) {
        const detections = result.detections || [];
        const metadata = result.metadata || {};
        
        // Show summary
        resultsSummary.innerHTML = `
            <strong>Found ${detections.length} object(s)</strong>
            <br>
            <small>Model: ${metadata.model || 'Unknown'} | 
                   Confidence Threshold: ${metadata.confidence_threshold || 0.5} | 
                   Device: ${metadata.device || 'Unknown'}</small>
        `;
        
        // Show detections list
        detectionsList.innerHTML = '';
        if (detections.length === 0) {
            detectionsList.innerHTML = '<div class="alert alert-warning">No objects detected. Try lowering the confidence threshold.</div>';
        } else {
            detections.forEach((detection, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item bg-dark border-secondary';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${detection.label || 'Unknown'}</h6>
                            <p class="mb-1 small text-muted">
                                Confidence: ${(detection.score * 100).toFixed(1)}%<br>
                                Bounding Box: (${detection.box.xmin.toFixed(0)}, ${detection.box.ymin.toFixed(0)}) 
                                to (${detection.box.xmax.toFixed(0)}, ${detection.box.ymax.toFixed(0)})
                            </p>
                        </div>
                        <span class="badge bg-primary">#${index + 1}</span>
                    </div>
                `;
                detectionsList.appendChild(item);
            });
        }
        
        detectionResults.style.display = 'block';
    }
    
    // Initial load
    loadModels();
});
</script>
{% endblock %}
