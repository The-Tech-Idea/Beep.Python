{% extends "ai_services/base_service.html" %}

{% block service_content %}
<!-- Tabular & Time Series Service Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Time Series Forecasting & Tabular Prediction</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="model-select" class="form-label">Model</label>
                    <select class="form-select" id="model-select">
                        <!-- Models will be loaded dynamically -->
                    </select>
                    <small class="text-muted">Select a time series forecasting or tabular model (TimesFM, TTM, Chronos, Mitra, etc.)</small>
                </div>
                
                <div class="mb-3">
                    <label for="task-type-select" class="form-label">Task Type</label>
                    <select class="form-select" id="task-type-select">
                        <option value="time_series_forecasting" selected>Time Series Forecasting</option>
                        <option value="tabular_classification">Tabular Classification</option>
                        <option value="tabular_regression">Tabular Regression</option>
                    </select>
                    <small class="text-muted">Select the type of prediction task</small>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="forecast-horizon" class="form-label">Forecast Horizon</label>
                        <input type="number" class="form-control" id="forecast-horizon" min="1" max="1000" value="12">
                        <small class="text-muted">Number of time steps to forecast ahead</small>
                    </div>
                    <div class="col-md-6">
                        <label for="context-length" class="form-label">Context Length (Optional)</label>
                        <input type="number" class="form-control" id="context-length" min="1" max="2048" placeholder="Auto">
                        <small class="text-muted">Historical context length (auto-determined if not set)</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="frequency-select" class="form-label">Time Series Frequency (Optional)</label>
                    <select class="form-select" id="frequency-select">
                        <option value="">Auto-detect</option>
                        <option value="T">Minutely</option>
                        <option value="H">Hourly</option>
                        <option value="D">Daily</option>
                        <option value="W">Weekly</option>
                        <option value="M">Monthly</option>
                        <option value="Q">Quarterly</option>
                        <option value="Y">Yearly</option>
                    </select>
                    <small class="text-muted">Time series frequency (for TimesFM and similar models)</small>
                </div>
                
                <div class="mb-3">
                    <label for="data-input" class="form-label">Time Series Data</label>
                    <textarea class="form-control font-monospace" id="data-input" rows="8" 
                              placeholder='Enter time series data as JSON array:
[
  [1.2, 1.5, 1.8, 2.1, 2.4, 2.7, 3.0],
  [10.5, 11.2, 12.1, 13.0, 13.8, 14.5, 15.2]
]

Or CSV format:
1.2,1.5,1.8,2.1,2.4,2.7,3.0
10.5,11.2,12.1,13.0,13.8,14.5,15.2'></textarea>
                    <small class="text-muted">Enter time series data as JSON array or CSV. Each row represents a time series.</small>
                </div>
                
                <div class="mb-3">
                    <label for="data-file-input" class="form-label">Or Upload Data File</label>
                    <input type="file" class="form-control" id="data-file-input" accept=".csv,.json,.txt">
                    <small class="text-muted">Upload CSV or JSON file with time series data</small>
                </div>
                
                <button type="button" class="btn btn-primary" id="btn-forecast" disabled>
                    <i class="bi bi-graph-up-arrow me-2"></i>Generate Forecast
                </button>
                
                <!-- Forecast Progress -->
                <div id="forecast-progress" class="mt-4" style="display: none;">
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="forecast-progress-bar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <p class="text-muted small mb-0" id="forecast-status">Initializing forecast...</p>
                </div>
                
                <!-- Forecast Results -->
                <div id="forecast-results" class="mt-4" style="display: none;">
                    <h6 class="mb-3"><i class="bi bi-list-check me-2"></i>Forecast Results</h6>
                    <div id="results-summary" class="alert alert-info mb-3">
                        <!-- Summary will be shown here -->
                    </div>
                    <div id="forecasts-list" class="list-group">
                        <!-- Forecasts will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('model-select');
    const taskTypeSelect = document.getElementById('task-type-select');
    const dataInput = document.getElementById('data-input');
    const dataFileInput = document.getElementById('data-file-input');
    const btnForecast = document.getElementById('btn-forecast');
    const forecastHorizon = document.getElementById('forecast-horizon');
    const contextLength = document.getElementById('context-length');
    const frequencySelect = document.getElementById('frequency-select');
    const forecastProgress = document.getElementById('forecast-progress');
    const forecastProgressBar = document.getElementById('forecast-progress-bar');
    const forecastStatus = document.getElementById('forecast-status');
    const forecastResults = document.getElementById('forecast-results');
    const resultsSummary = document.getElementById('results-summary');
    const forecastsList = document.getElementById('forecasts-list');
    
    let currentTaskId = null;
    
    // Load models
    function loadModels() {
        fetch('/llm/models?type=tabular_time_series')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.models) {
                    modelSelect.innerHTML = '<option value="">Select a model...</option>';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.model_id;
                        option.textContent = `${model.model_id} ${model.selected ? '(Selected)' : ''}`;
                        if (model.selected) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                    
                    // Enable forecast button if data is provided
                    if (dataInput.value.trim() || dataFileInput.files.length > 0) {
                        btnForecast.disabled = !modelSelect.value;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading models:', error);
            });
    }
    
    // Handle file upload
    dataFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                // Try to parse as JSON first, then CSV
                try {
                    const jsonData = JSON.parse(content);
                    dataInput.value = JSON.stringify(jsonData, null, 2);
                } catch {
                    // Assume CSV
                    dataInput.value = content;
                }
                btnForecast.disabled = !modelSelect.value;
            };
            reader.readAsText(file);
        }
    });
    
    // Handle data input
    dataInput.addEventListener('input', function() {
        btnForecast.disabled = !this.value.trim() || !modelSelect.value;
    });
    
    // Handle model selection
    modelSelect.addEventListener('change', function() {
        btnForecast.disabled = !dataInput.value.trim() || !this.value;
    });
    
    // Parse data input
    function parseDataInput() {
        const input = dataInput.value.trim();
        if (!input) return null;
        
        try {
            // Try JSON first
            return JSON.parse(input);
        } catch {
            // Try CSV
            const lines = input.split('\\n').filter(line => line.trim());
            return lines.map(line => {
                const values = line.split(',').map(v => parseFloat(v.trim()));
                return values.filter(v => !isNaN(v));
            });
        }
    }
    
    // Forecast
    btnForecast.addEventListener('click', function() {
        const data = parseDataInput();
        if (!data || !Array.isArray(data) || data.length === 0) {
            alert('Please enter valid time series data');
            return;
        }
        
        if (!modelSelect.value) {
            alert('Please select a model');
            return;
        }
        
        const requestData = {
            data: data,
            model_id: modelSelect.value,
            forecast_horizon: parseInt(forecastHorizon.value) || 12,
            context_length: contextLength.value ? parseInt(contextLength.value) : null,
            frequency: frequencySelect.value || null,
            task_type: taskTypeSelect.value
        };
        
        // Show progress
        forecastProgress.style.display = 'block';
        forecastProgressBar.style.width = '10%';
        forecastStatus.textContent = 'Starting forecast...';
        forecastResults.style.display = 'none';
        btnForecast.disabled = true;
        
        fetch('/ai-services/api/tabular-time-series/forecast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.task_id) {
                currentTaskId = data.task_id;
                pollForecastStatus();
            } else {
                throw new Error(data.error || 'Failed to start forecast');
            }
        })
        .catch(error => {
            console.error('Error starting forecast:', error);
            forecastStatus.textContent = `Error: ${error.message}`;
            forecastProgressBar.style.width = '0%';
            btnForecast.disabled = false;
        });
    });
    
    // Poll forecast status
    function pollForecastStatus() {
        if (!currentTaskId) return;
        
        fetch(`/api/tasks/${currentTaskId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const task = data.task;
                    
                    // Update progress
                    if (task.progress !== undefined) {
                        forecastProgressBar.style.width = `${task.progress}%`;
                    }
                    
                    if (task.current_step_message) {
                        forecastStatus.textContent = task.current_step_message;
                    }
                    
                    // Check if complete
                    if (task.status === 'completed') {
                        forecastProgressBar.style.width = '100%';
                        forecastStatus.textContent = 'Forecast complete!';
                        
                        // Show results
                        if (task.result && task.result.success) {
                            displayResults(task.result);
                        } else {
                            throw new Error(task.result?.error || 'Forecast failed');
                        }
                        
                        btnForecast.disabled = false;
                        currentTaskId = null;
                    } else if (task.status === 'failed') {
                        throw new Error(task.error || 'Forecast failed');
                    } else {
                        // Continue polling
                        setTimeout(pollForecastStatus, 1000);
                    }
                } else {
                    throw new Error(data.error || 'Failed to get task status');
                }
            })
            .catch(error => {
                console.error('Error polling forecast status:', error);
                forecastStatus.textContent = `Error: ${error.message}`;
                forecastProgressBar.style.width = '0%';
                btnForecast.disabled = false;
                currentTaskId = null;
            });
    }
    
    // Display results
    function displayResults(result) {
        const forecasts = result.forecasts || [];
        const metadata = result.metadata || {};
        
        // Show summary
        resultsSummary.innerHTML = `
            <strong>Forecasted ${forecasts.length} time series</strong>
            <br>
            <small>Model: ${metadata.model || 'Unknown'} | 
                   Horizon: ${metadata.forecast_horizon || 'Unknown'} | 
                   Task: ${metadata.task_type || 'Unknown'}</small>
        `;
        
        // Show forecasts
        forecastsList.innerHTML = '';
        forecasts.forEach((forecast, index) => {
            const item = document.createElement('div');
            item.className = 'list-group-item bg-dark border-secondary';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-2">Time Series #${index + 1}</h6>
                        <p class="mb-1 small text-muted font-monospace">
                            ${forecast.slice(0, 10).map(v => v.toFixed(2)).join(', ')}${forecast.length > 10 ? '...' : ''}
                        </p>
                        <small class="text-muted">${forecast.length} forecasted values</small>
                    </div>
                    <span class="badge bg-primary">#${index + 1}</span>
                </div>
            `;
            forecastsList.appendChild(item);
        });
        
        forecastResults.style.display = 'block';
    }
    
    // Initial load
    loadModels();
});
</script>
{% endblock %}
