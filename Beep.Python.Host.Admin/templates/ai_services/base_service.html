{% extends "base.html" %}

{% block title %}{{ service_info.name }}{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="{{ service_info.icon }} me-2"></i>{{ service_info.name }}</h1>
        <p class="text-muted mb-0">{{ service_info.description }}</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Environment Status -->
    <div class="col-lg-4 mb-4">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Environment Status</h5>
            </div>
            <div class="card-body">
                <div id="env-status-content">
                    {% if env_status and env_status.status == 'not_created' %}
                    <div class="text-center">
                        <i class="bi bi-x-circle text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">Not Created</h5>
                        <p class="text-muted small">Environment has not been set up yet</p>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Checking environment...</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Panel -->
    <div class="col-lg-8 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Environment Setup</h5>
            </div>
            <div class="card-body">
                <div id="setup-content">
                    <p class="text-muted mb-4">
                        A dedicated virtual environment isolates {{ service_info.name }} libraries 
                        from the main application to avoid dependency conflicts.
                    </p>
                    
                    <div id="env-not-created" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Environment not created</strong>
                            <p class="mb-0 mt-2">Create a virtual environment to install {{ service_info.name }} libraries.</p>
                        </div>
                        <button class="btn btn-primary" id="btn-create-env">
                            <i class="bi bi-plus-circle me-2"></i>Create Environment
                        </button>
                    </div>
                    
                    <div id="env-ready" style="display: none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Environment Ready</strong>
                            <p class="mb-0 mt-2">Virtual environment is created and ready for package installation.</p>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Install Packages</h6>
                        <div id="packages-list" class="mb-3">
                            <!-- Packages will be loaded here -->
                        </div>
                        
                        <!-- Installation Progress -->
                        <div id="install-progress" class="mt-3 mb-3" style="display: none;">
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="install-progress-bar" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <p class="text-muted small mb-0" id="install-status">Preparing installation...</p>
                        </div>
                        
                        <button class="btn btn-success" id="btn-install-all">
                            <i class="bi bi-download me-2"></i>Install All Required Packages
                        </button>
                        <button class="btn btn-outline-info ms-2" onclick="loadStatus()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Status
                        </button>
                    </div>
                    
                    <!-- Model Management Section -->
                    <div id="model-management" class="mt-4" style="display: none;">
                        <hr class="border-secondary">
                        <h6 class="mb-3"><i class="bi bi-box me-2"></i>Model Management</h6>
                        
                        <!-- Recommended Models -->
                        <div class="mb-4">
                            <h6 class="mb-3"><i class="bi bi-star-fill text-warning me-2"></i>Recommended Models</h6>
                            <div id="curated-models-list" class="mb-3">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <small class="text-muted d-block mt-2">Loading recommended models...</small>
                                </div>
                            </div>
                            <div class="alert alert-info small mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Tip:</strong> These are well-tested models that work reliably with this service. 
                                You can also download custom models using the option below.
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="mb-3">
                            <label for="model-id-input" class="form-label">Download Custom Model</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="model-id-input" 
                                       placeholder="e.g., user/model-name">
                                <button class="btn btn-primary" id="btn-download-model" type="button">
                                    <i class="bi bi-download me-1"></i>Download
                                </button>
                                <button class="btn btn-outline-secondary" id="btn-manage-models" type="button">
                                    <i class="bi bi-gear me-1"></i>Manage
                                </button>
                            </div>
                            <small class="text-muted">Enter a HuggingFace model ID to download and use</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="model-select-manage" class="form-label">Select Model</label>
                            <select class="form-select" id="model-select-manage">
                                <option value="">Loading models...</option>
                            </select>
                            <small class="text-muted">Choose a downloaded model to use</small>
                        </div>
                        
                        <!-- Download Progress -->
                        <div id="model-download-progress" class="mt-3 mb-3" style="display: none;">
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="model-download-progress-bar" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <p class="text-muted small mb-0" id="model-download-status">Preparing download...</p>
                        </div>
                    </div>
                    
                    <div id="env-error" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            <strong>Error</strong>
                            <p class="mb-0 mt-2" id="error-message"></p>
                        </div>
                        <button class="btn btn-warning" id="btn-retry">
                            <i class="bi bi-arrow-clockwise me-2"></i>Retry
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block service_content %}{% endblock %}
{% endblock %}

{% block extra_js %}
<script>
// Map route names to API service type names
const SERVICE_TYPE_MAP = {
    'text-to-image': 'text_to_image',
    'text-to-speech': 'text_to_speech',
    'speech-to-text': 'speech_to_text',
    'voice-to-voice': 'voice_to_voice'
};

const SERVICE_ROUTE = '{{ service_info.route }}';
// Convert route (text_to_image) to API format (text_to_image or text-to-image)
let SERVICE_TYPE = SERVICE_TYPE_MAP[SERVICE_ROUTE] || SERVICE_ROUTE;
// Ensure we use underscores for API calls
if (SERVICE_TYPE.includes('-')) {
    SERVICE_TYPE = SERVICE_TYPE.replace(/-/g, '_');
}
console.log('Service Route:', SERVICE_ROUTE, 'Service Type:', SERVICE_TYPE);

// Task tracking
let currentTaskId = null;
let statusCheckInterval = null;

    // Load on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we already know the status from server-side
        {% if env_status and env_status.status == 'not_created' %}
        // Environment is not created - update UI immediately without spinner
        const envStatus = {{ env_status|tojson }};
        updateEnvironmentStatus(envStatus);
        {% else %}
        // Need to check status - show spinner
        loadStatus();
        {% endif %}
    
    // Setup environment buttons
    document.getElementById('btn-create-env')?.addEventListener('click', createEnvironment);
    document.getElementById('btn-install-all')?.addEventListener('click', installAllPackages);
    document.getElementById('btn-retry')?.addEventListener('click', loadStatus);
    
    // Setup model management buttons (only for services that support model management)
    const modelManagement = document.getElementById('model-management');
    if (modelManagement) {
        document.getElementById('btn-download-model')?.addEventListener('click', downloadModel);
        document.getElementById('btn-manage-models')?.addEventListener('click', showManageModels);
        document.getElementById('model-select-manage')?.addEventListener('change', onModelSelect);
        
        // Load curated models (always available, doesn't require environment)
        loadCuratedModels();
        
        // Load models when environment is ready - check from server-side status
        {% if env_status and env_status.status == 'ready' %}
        loadModelsList();
        {% endif %}
    }
});

function loadStatus() {
    const statusContent = document.getElementById('env-status-content');
    
    // Check if status is already "not created" - no need for spinner
    const currentHtml = statusContent?.innerHTML || '';
    const isNotCreated = currentHtml.includes('Not Created') || 
                        currentHtml.includes('has not been set up') ||
                        currentHtml.includes('bi-x-circle');
    
    // Only show spinner if status is unknown or we're refreshing from a different state
    if (statusContent && !isNotCreated) {
        statusContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Checking environment...</p>
            </div>
        `;
    }
    
    const apiUrl = `/ai-services/api/${SERVICE_TYPE}/status`;
    console.log('Fetching status from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('Response status:', response.status, response.statusText);
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `HTTP ${response.status}`);
                }).catch(() => {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Status data received:', data);
            if (data.success && data.environment) {
                updateEnvironmentStatus(data.environment);
            } else {
                // Show error state
                if (statusContent) {
                    statusContent.innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-warning">Error</h5>
                            <p class="text-muted small">${data.error || 'Failed to load status'}</p>
                            <button class="btn btn-sm btn-outline-light mt-2" onclick="loadStatus()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Retry
                            </button>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Failed to load status:', error);
            // Show error state with more details
            if (statusContent) {
                statusContent.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-warning">Error Loading Status</h5>
                        <p class="text-muted small">${error.message}</p>
                        <p class="text-muted small mt-2">URL: ${apiUrl}</p>
                        <button class="btn btn-sm btn-outline-light mt-2" onclick="loadStatus()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Retry
                        </button>
                    </div>
                `;
            }
        });
}

function updateEnvironmentStatus(env) {
    console.log('Updating environment status:', env);
    
    const notCreated = document.getElementById('env-not-created');
    const ready = document.getElementById('env-ready');
    const error = document.getElementById('env-error');
    const statusContent = document.getElementById('env-status-content');
    
    if (!env) {
        console.error('Environment data is null or undefined');
        if (statusContent) {
            statusContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-warning">Error</h5>
                    <p class="text-muted small">No environment data received</p>
                </div>
            `;
        }
        return;
    }
    
    if (env.status === 'not_created') {
        if (notCreated) notCreated.style.display = 'block';
        if (ready) ready.style.display = 'none';
        if (error) error.style.display = 'none';
        
        // Update status card - no spinner needed, just show status
        if (statusContent) {
            statusContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-x-circle text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">Not Created</h5>
                    <p class="text-muted small">Environment has not been set up yet</p>
                </div>
            `;
        }
    } else if (env.status === 'ready') {
        if (notCreated) notCreated.style.display = 'none';
        if (ready) ready.style.display = 'block';
        if (error) error.style.display = 'none';
        
        if (env.packages) {
            updatePackagesList(env.packages);
        }
        
        // Show model management if environment is ready (only for services that support it)
        const modelManagement = document.getElementById('model-management');
        if (modelManagement) {
            // Show for text-to-image and speech-to-text services
            const supportedServices = ['text_to_image', 'speech_to_text'];
            if (supportedServices.includes(SERVICE_TYPE)) {
                modelManagement.style.display = 'block';
                loadModelsList();
            }
        }
        
        // Update status card
        if (statusContent) {
            const installedCount = env.installed_count || 0;
            const requiredCount = env.required_count || 0;
            statusContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-success">Environment Ready</h5>
                    <p class="text-muted small">Packages: ${installedCount}/${requiredCount} installed</p>
                </div>
            `;
        }
    } else if (env.status === 'error') {
        if (notCreated) notCreated.style.display = 'none';
        if (ready) ready.style.display = 'none';
        if (error) error.style.display = 'block';
        const errorMsg = document.getElementById('error-message');
        if (errorMsg) errorMsg.textContent = env.error || 'Environment creation failed';
        
        if (statusContent) {
            statusContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-danger">Error</h5>
                    <p class="text-muted small">${env.error || 'Environment error'}</p>
                </div>
            `;
        }
    } else {
        // Unknown status
        console.warn('Unknown environment status:', env.status);
        if (statusContent) {
            statusContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-question-circle text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-warning">Unknown Status</h5>
                    <p class="text-muted small">Status: ${env.status || 'unknown'}</p>
                </div>
            `;
        }
    }
}

function updatePackagesList(packages) {
    const packagesList = document.getElementById('packages-list');
    if (!packagesList) return;
    
    packagesList.innerHTML = Object.entries(packages).map(([key, pkg]) => {
        const checked = pkg.installed ? 'checked' : '';
        const badge = pkg.installed 
            ? '<span class="badge bg-success ms-2">Installed</span>'
            : '<span class="badge bg-secondary ms-2">Not Installed</span>';
        
        return `
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="${key}" id="pkg-${key}" ${checked} ${pkg.required ? 'disabled' : ''}>
                <label class="form-check-label" for="pkg-${key}">
                    <strong>${pkg.name}</strong> ${badge}
                    ${pkg.required ? '<span class="badge bg-primary ms-1">Required</span>' : ''}
                    <br>
                    <small class="text-muted">${pkg.description}</small>
                </label>
            </div>
        `;
    }).join('');
}

function showInstallProgress() {
    const progressDiv = document.getElementById('install-progress');
    if (progressDiv) {
        progressDiv.style.display = 'block';
    }
    const progressBar = document.getElementById('install-progress-bar');
    const statusText = document.getElementById('install-status');
    if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
    }
    if (statusText) {
        statusText.textContent = 'Starting...';
    }
}

function hideInstallProgress() {
    const progressDiv = document.getElementById('install-progress');
    if (progressDiv) {
        progressDiv.style.display = 'none';
    }
}

function createEnvironment() {
    if (!confirm('Create environment? This may take a few minutes.')) return;
    
    const btn = document.getElementById('btn-create-env');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
    }
    
    fetch(`/ai-services/api/${SERVICE_TYPE}/create-env`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            // Add to global task panel
            if (window.addGlobalTask) {
                window.addGlobalTask(data.task_id, 'Create Environment: ' + SERVICE_TYPE, 'environment_creation');
            }
            showInstallProgress();
            startStatusPolling(data.task_id);
        } else {
            alert('Failed to start environment creation: ' + (data.error || 'Unknown error'));
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Create Environment';
            }
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Create Environment';
        }
    });
}

function installAllPackages() {
    if (!confirm('Install all required packages? This may take several minutes.')) return;
    
    const btn = document.getElementById('btn-install-all');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Installing...';
    }
    
    fetch(`/ai-services/api/${SERVICE_TYPE}/install-packages`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({packages: null}) // null = install all required
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Installation response:', data);
        if (data.success) {
            currentTaskId = data.task_id;
            console.log('Task ID:', currentTaskId);
            showInstallProgress();
            startStatusPolling(data.task_id);
        } else {
            alert('Failed to start installation: ' + (data.error || 'Unknown error'));
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download me-2"></i>Install All Required Packages';
            }
        }
    })
    .catch(error => {
        console.error('Installation error:', error);
        alert('Error starting installation: ' + error.message);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download me-2"></i>Install All Required Packages';
        }
    });
}

function startStatusPolling(taskId) {
    if (statusCheckInterval) clearInterval(statusCheckInterval);
    
    let pollCount = 0;
    const maxPolls = 300; // 10 minutes max (300 * 2 seconds)
    let lastProgress = 0;
    let stuckCount = 0;
    
    statusCheckInterval = setInterval(() => {
        pollCount++;
        loadStatus();
        
        // Check if task is complete
        if (taskId) {
            fetch(`/tasks/${taskId}/status`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if task is complete first
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                        currentTaskId = null;
                        
                        // Re-enable buttons
                        const btnCreate = document.getElementById('btn-create-env');
                        const btnInstall = document.getElementById('btn-install-all');
                        if (btnCreate) btnCreate.disabled = false;
                        if (btnInstall) {
                            btnInstall.disabled = false;
                            btnInstall.innerHTML = '<i class="bi bi-download me-2"></i>Install All Required Packages';
                        }
                        
                        // Show error message if failed
                        if (data.status === 'failed') {
                            const errorMsg = data.error || data.message || 'Task failed';
                            console.error('Task failed:', errorMsg);
                            alert('Task Failed:\n' + errorMsg);
                            hideInstallProgress();
                        } else if (data.status === 'completed' && data.result) {
                            // Show success message with details
                            const result = data.result;
                            console.log('Task completed:', result);
                            if (result.failed && result.failed.length > 0) {
                                const failedPkgs = result.failed.map(f => (typeof f === 'string' ? f : f.package || f)).join(', ');
                                const failedErrors = result.failed.map(f => {
                                    if (typeof f === 'string') return f;
                                    return `${f.package || 'unknown'}: ${f.error || 'unknown error'}`;
                                }).join('\n');
                                console.error('Failed packages:', failedErrors);
                                alert(`Installation completed with errors:\n\nFailed packages: ${failedPkgs}\n\nCheck browser console for details.`);
                            } else {
                                console.log('All packages installed successfully');
                            }
                            hideInstallProgress();
                        }
                        
                        // Force refresh status multiple times to ensure it updates
                        loadStatus(); // Immediate refresh
                        setTimeout(() => loadStatus(), 1000); // Refresh after 1 second
                        setTimeout(() => loadStatus(), 3000); // Refresh after 3 seconds
                        return;
                    }
                    
                    // Update progress bar
                    const progressBar = document.getElementById('install-progress-bar');
                    const progressText = document.getElementById('install-status');
                    
                    if (data.progress !== undefined && data.progress !== null) {
                        if (progressBar) {
                            progressBar.style.width = data.progress + '%';
                            progressBar.textContent = Math.round(data.progress) + '%';
                        }
                        // Check if progress is stuck
                        if (data.progress === lastProgress) {
                            stuckCount++;
                        } else {
                            stuckCount = 0;
                        }
                        lastProgress = data.progress;
                    }
                    
                    if (progressText) {
                        if (data.current_step) {
                            progressText.textContent = data.current_step;
                        } else if (data.status) {
                            progressText.textContent = `Status: ${data.status}`;
                        }
                    }
                    
                    // If stuck for too long (30 seconds), check environment status directly
                    if (stuckCount > 15) {
                        // Check environment status to see if packages are actually installed
                        fetch(`/ai-services/api/${SERVICE_TYPE}/status`)
                            .then(response => response.json())
                            .then(statusData => {
                                if (statusData.success && statusData.environment) {
                                    const envStatus = statusData.environment.status;
                                    // If environment is ready, assume installation completed
                                    if (envStatus === 'ready') {
                                        clearInterval(statusCheckInterval);
                                        statusCheckInterval = null;
                                        currentTaskId = null;
                                        hideInstallProgress();
                                        loadStatus();
                                    }
                                }
                            })
                            .catch(() => {});
                    }
                })
                .catch(error => {
                    console.error('Task polling error:', error);
                    // If task API fails, check environment status directly after a few attempts
                    if (pollCount > 10) {
                        fetch(`/ai-services/api/${SERVICE_TYPE}/status`)
                            .then(response => response.json())
                            .then(statusData => {
                                if (statusData.success && statusData.environment) {
                                    const envStatus = statusData.environment.status;
                                    if (envStatus === 'ready') {
                                        clearInterval(statusCheckInterval);
                                        statusCheckInterval = null;
                                        currentTaskId = null;
                                        hideInstallProgress();
                                        loadStatus();
                                    }
                                }
                            })
                            .catch(() => {});
                    }
                });
        } else {
            // No task ID, just check environment status
            fetch(`/ai-services/api/${SERVICE_TYPE}/status`)
                .then(response => response.json())
                .then(statusData => {
                    if (statusData.success && statusData.environment) {
                        const envStatus = statusData.environment.status;
                        if (envStatus === 'ready' || envStatus === 'error') {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                        }
                    }
                })
                .catch(() => {});
        }
        
        // Safety timeout - stop polling after max polls
        if (pollCount >= maxPolls) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
            currentTaskId = null;
            hideInstallProgress();
            alert('Installation monitoring timed out. Please check the environment status manually.');
        }
    }, 2000);
}

// Model Management Functions
function loadModelsList() {
    const select = document.getElementById('model-select-manage');
    if (!select) return;
    
    fetch(`/ai-services/api/${SERVICE_TYPE}/models`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                select.innerHTML = '<option value="">-- Select Model --</option>';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.name}${model.selected ? ' (Active)' : ''}`;
                    if (model.selected) option.selected = true;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Failed to load models:', error);
            select.innerHTML = '<option value="">Error loading models</option>';
        });
}

function loadCuratedModels() {
    const container = document.getElementById('curated-models-list');
    if (!container) return;
    
    fetch(`/ai-services/api/${SERVICE_TYPE}/curated-models`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.models && data.models.length > 0) {
                container.innerHTML = data.models.map(model => {
                    const sizeText = model.size_gb < 1 ? `${(model.size_gb * 1024).toFixed(0)} MB` : `${model.size_gb.toFixed(1)} GB`;
                    const tagsHtml = model.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('');
                    const recommendedBadge = model.recommended ? '<span class="badge bg-warning text-dark ms-2"><i class="bi bi-star-fill me-1"></i>Recommended</span>' : '';
                    const isGated = model.tags && model.tags.includes('gated');
                    const gatedWarning = isGated ? '<div class="alert alert-warning small mt-2 mb-0"><i class="bi bi-exclamation-triangle me-1"></i><strong>Gated Model:</strong> Requires accepting license on HuggingFace and API token. <a href="https://huggingface.co/' + model.model_id + '" target="_blank">Request access</a></div>' : '';
                    
                    return `
                        <div class="card bg-dark border-secondary mb-2 curated-model-card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            ${model.name}
                                            ${recommendedBadge}
                                        </h6>
                                        <p class="text-muted small mb-2">${model.description}</p>
                                        ${gatedWarning}
                                        <div class="mb-2 mt-2">
                                            ${tagsHtml}
                                            <span class="badge bg-info ms-1">${sizeText}</span>
                                        </div>
                                        <code class="text-muted small">${model.model_id}</code>
                                    </div>
                                    <div class="ms-3">
                                        <button class="btn btn-sm btn-primary" onclick="downloadCuratedModel('${model.model_id}', '${model.name.replace(/'/g, "\\'")}', ${isGated})">
                                            <i class="bi bi-download me-1"></i>Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="text-muted text-center py-3"><small>No recommended models available</small></div>';
            }
        })
        .catch(error => {
            console.error('Error loading curated models:', error);
            container.innerHTML = '<div class="text-danger text-center py-3"><small>Error loading recommended models</small></div>';
        });
}

function downloadCuratedModel(modelId, modelName, isGated = false) {
    let confirmMessage = `Download model: ${modelName}?\n\nModel ID: ${modelId}\n\nThis will download the model to your local cache for offline use.`;
    
    if (isGated) {
        confirmMessage += `\n\n⚠️ WARNING: This is a gated model!\n\nYou need to:\n1. Accept the license on HuggingFace\n2. Have a valid HuggingFace API token configured\n3. Be authorized to access this model\n\nVisit https://huggingface.co/${modelId} to request access.`;
    }
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Use the existing downloadModel function but set the input value
    const modelIdInput = document.getElementById('model-id-input');
    if (modelIdInput) {
        modelIdInput.value = modelId;
    }
    
    // Trigger download
    downloadModel();
}

function downloadModel() {
    const modelIdInput = document.getElementById('model-id-input');
    const modelId = modelIdInput?.value.trim();
    
    if (!modelId) {
        alert('Please enter a model ID (e.g., runwayml/stable-diffusion-v1-5)');
        return;
    }
    
    const btn = document.getElementById('btn-download-model');
    const progressDiv = document.getElementById('model-download-progress');
    const progressBar = document.getElementById('model-download-progress-bar');
    const statusText = document.getElementById('model-download-status');
    
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Downloading...';
    }
    
    if (progressDiv) progressDiv.style.display = 'block';
    if (progressBar) progressBar.style.width = '0%';
    if (statusText) statusText.textContent = 'Starting download...';
    
    fetch(`/ai-services/api/${SERVICE_TYPE}/models/download`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({model_id: modelId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.task_id) {
                // Add to global task panel
                if (window.addGlobalTask) {
                    window.addGlobalTask(data.task_id, 'Download Model: ' + modelId, 'model_download');
                }
                // Poll for progress
                pollModelDownload(data.task_id);
            } else {
                alert('Model download started');
                loadModelsList();
            }
        } else {
            alert('Failed to start download: ' + (data.error || 'Unknown error'));
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download me-1"></i>Download';
            }
            if (progressDiv) progressDiv.style.display = 'none';
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download me-1"></i>Download';
        }
        if (progressDiv) progressDiv.style.display = 'none';
    });
}

function pollModelDownload(taskId) {
    const progressBar = document.getElementById('model-download-progress-bar');
    const statusText = document.getElementById('model-download-status');
    const btn = document.getElementById('btn-download-model');
    
    const poll = setInterval(() => {
        fetch(`/tasks/${taskId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.progress !== undefined && progressBar) {
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = Math.round(data.progress) + '%';
                }
                if (data.current_step && statusText) {
                    statusText.textContent = data.current_step;
                }
                
                if (data.status === 'completed') {
                    clearInterval(poll);
                    if (progressBar) progressBar.style.width = '100%';
                    if (statusText) statusText.textContent = 'Download complete!';
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-download me-1"></i>Download';
                    }
                    setTimeout(() => {
                        document.getElementById('model-download-progress').style.display = 'none';
                        loadModelsList();
                    }, 2000);
                } else if (data.status === 'failed') {
                    clearInterval(poll);
                    alert('Download failed: ' + (data.error || 'Unknown error'));
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-download me-1"></i>Download';
                    }
                    document.getElementById('model-download-progress').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
            });
    }, 2000);
}

function showManageModels() {
    // Open a modal or page to manage models
    window.location.href = `/ai-services/${SERVICE_TYPE.replace('_', '-')}/models`;
}

function onModelSelect() {
    const select = document.getElementById('model-select-manage');
    const modelId = select?.value;
    
    if (!modelId) return;
    
    fetch(`/ai-services/api/${SERVICE_TYPE}/models/select`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({model_id: modelId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI to show selected model
            loadModelsList();
            // Also update the service-specific model select if it exists
            const serviceModelSelect = document.getElementById('model-select');
            if (serviceModelSelect) {
                loadModelsList(); // This will update both selects
            }
        } else {
            alert('Failed to select model: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock %}
