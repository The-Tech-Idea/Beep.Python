{% extends "ai_services/base_service.html" %}

{% block service_content %}
<!-- Text to Speech Service Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-volume-up me-2"></i>Convert Text to Speech</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="tts-text-input" class="form-label">Text to Convert</label>
                    <textarea class="form-control" id="tts-text-input" rows="5" placeholder="Enter the text you want to convert to speech..."></textarea>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="tts-voice" class="form-label">Voice</label>
                        <select class="form-select" id="tts-voice">
                            <option value="default">Default Voice</option>
                            <option value="male">Male Voice</option>
                            <option value="female">Female Voice</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="tts-engine" class="form-label">TTS Engine</label>
                        <select class="form-select" id="tts-engine">
                            <option value="edge-tts" selected>Edge TTS (Recommended)</option>
                            <option value="gtts">Google TTS</option>
                            <option value="pyttsx3">System TTS (Offline)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="tts-speed" class="form-label">Speed</label>
                        <input type="range" class="form-range" id="tts-speed" min="0.5" max="2" step="0.1" value="1">
                        <small class="text-muted"><span id="speed-value">1.0</span>x</small>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary" id="btn-generate-speech" disabled>
                    <i class="bi bi-play-circle me-2"></i>Generate Speech
                </button>
                
                <!-- Audio Player -->
                <div id="audio-container" class="mt-4" style="display: none;">
                    <h6>Generated Audio:</h6>
                    <audio id="generated-audio" controls class="w-100"></audio>
                    <div class="mt-3 text-center">
                        <button class="btn btn-sm btn-outline-primary" id="btn-download-audio">
                            <i class="bi bi-download me-1"></i>Download Audio
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnGenerate = document.getElementById('btn-generate-speech');
    const textInput = document.getElementById('tts-text-input');
    const speedSlider = document.getElementById('tts-speed');
    
    textInput.addEventListener('input', function() {
        btnGenerate.disabled = !this.value.trim();
    });
    
    speedSlider.addEventListener('input', function() {
        document.getElementById('speed-value').textContent = parseFloat(this.value).toFixed(1);
    });
    
    btnGenerate.addEventListener('click', generateSpeech);
    document.getElementById('btn-download-audio')?.addEventListener('click', downloadAudio);
});

function generateSpeech() {
    const text = document.getElementById('tts-text-input').value.trim();
    if (!text) {
        alert('Please enter text to convert');
        return;
    }
    
    const voice = document.getElementById('tts-voice').value;
    const speed = parseFloat(document.getElementById('tts-speed').value);
    const engine = document.getElementById('tts-engine').value;
    const btnGenerate = document.getElementById('btn-generate-speech');
    
    btnGenerate.disabled = true;
    btnGenerate.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    
    fetch('/ai-services/api/text-to-speech/generate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            text: text,
            voice: voice,
            speed: speed,
            engine: engine
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Convert base64 to audio blob
            const audioBase64 = data.audio;
            const byteCharacters = atob(audioBase64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(blob);
            
            const audioElement = document.getElementById('generated-audio');
            audioElement.src = audioUrl;
            audioElement.dataset.audioData = audioBase64;
            document.getElementById('audio-container').style.display = 'block';
        } else {
            alert('Failed to generate speech: ' + (data.error || 'Unknown error'));
        }
        
        btnGenerate.disabled = false;
        btnGenerate.innerHTML = '<i class="bi bi-play-circle me-2"></i>Generate Speech';
    })
    .catch(error => {
        alert('Error generating speech: ' + error.message);
        btnGenerate.disabled = false;
        btnGenerate.innerHTML = '<i class="bi bi-play-circle me-2"></i>Generate Speech';
    });
}

function downloadAudio() {
    const audio = document.getElementById('generated-audio');
    const audioData = audio.dataset.audioData;
    
    if (!audioData) {
        alert('No audio to download');
        return;
    }
    
    // Convert base64 to blob
    const byteCharacters = atob(audioData);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: 'audio/mpeg' });
    
    const link = document.createElement('a');
    link.download = 'generated-speech.mp3';
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
}
</script>
{% endblock %}
