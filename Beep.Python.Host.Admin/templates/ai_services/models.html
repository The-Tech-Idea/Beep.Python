{% extends "base.html" %}

{% block title %}My {{ service_info.name }} Models{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-collection me-3"></i>My {{ service_info.name }} Models</h1>
            <p class="text-muted mb-0">Manage your downloaded models</p>
        </div>
        <div>
            <a href="{{ url_for('ai_services.service_discover', service_type=service_type) }}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-2"></i>Download More
            </a>
        </div>
    </div>
</div>

<!-- Storage Stats -->
<div class="row g-4 mb-4">
    <div class="col-md-6 animate-fade-in">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Total Models</h6>
                        <h2 class="mb-0">{{ models|length }}</h2>
                    </div>
                    <div class="stat-icon bg-primary bg-opacity-20 text-primary">
                        <i class="bi bi-box"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 animate-fade-in" style="animation-delay: 0.1s;">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Storage Used</h6>
                        <h2 class="mb-0">{{ storage_stats.total_size_gb }} GB</h2>
                    </div>
                    <div class="stat-icon bg-info bg-opacity-20 text-info">
                        <i class="bi bi-hdd"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Models List -->
{% if models %}
<div class="card animate-fade-in">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Downloaded Models</h5>
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm bg-dark border-secondary"
                placeholder="Filter models..." id="modelFilter" style="width: 200px;">
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0" id="modelsTable">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Size</th>
                        <th>Source</th>
                        <th>Downloaded</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for model in models %}
                    <tr data-model-name="{{ model.name|lower }}" data-model-id="{{ model.model_id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="model-icon-sm me-3">
                                    <i class="bi bi-box text-primary"></i>
                                </div>
                                <div>
                                    <strong>{{ model.name }}</strong>
                                    <br>
                                    <small class="text-muted text-truncate d-block" style="max-width: 300px;"
                                        title="{{ model.model_id }}">
                                        {{ model.model_id }}
                                    </small>
                                </div>
                            </div>
                        </td>
                        <td>{{ (model.size / 1073741824)|round(2) }} GB</td>
                        <td>
                            <span class="badge bg-info">{{ model.source }}</span>
                        </td>
                        <td>
                            <small class="text-muted">{{ model.downloaded_at[:10] if model.downloaded_at else 'N/A' }}</small>
                        </td>
                        <td>
                            {% if model.status == 'available' %}
                            <span class="badge bg-success">Available</span>
                            {% elif model.status == 'missing' %}
                            <span class="badge bg-warning">Missing</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ model.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="selectModel('{{ model.model_id }}')">
                                <i class="bi bi-check-circle me-1"></i>Use
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('{{ model.id }}')">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card animate-fade-in">
    <div class="card-body text-center py-5">
        <i class="bi bi-box fs-1 text-muted mb-3"></i>
        <h5>No models downloaded</h5>
        <p class="text-muted">Start by discovering and downloading models</p>
        <a href="{{ url_for('ai_services.service_discover', service_type=service_type) }}" class="btn btn-primary mt-3">
            <i class="bi bi-search me-2"></i>Discover Models
        </a>
    </div>
</div>
{% endif %}

<script>
function selectModel(modelId) {
    // modelId can be either local model ID (hash) or HuggingFace model_id
    fetch(`/ai-services/api/${SERVICE_TYPE}/models/select`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({model_id: modelId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Model selected successfully. It will be used for future generations.');
            // Optionally reload to show selected status
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Failed to select model: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function deleteModel(modelId) {
    if (!confirm('Are you sure you want to delete this model?')) return;
    
    fetch(`/ai-services/api/${SERVICE_TYPE}/models/${modelId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Model deleted successfully');
            location.reload();
        } else {
            alert('Failed to delete model: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

const SERVICE_TYPE = '{{ service_type_normalized }}';

// Filter models
document.getElementById('modelFilter')?.addEventListener('input', function(e) {
    const filter = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#modelsTable tbody tr');
    rows.forEach(row => {
        const modelName = row.getAttribute('data-model-name') || '';
        const modelId = row.getAttribute('data-model-id') || '';
        const matches = modelName.includes(filter) || modelId.toLowerCase().includes(filter);
        row.style.display = matches ? '' : 'none';
    });
});
</script>
{% endblock %}
