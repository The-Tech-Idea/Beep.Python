{% extends "ai_services/base_service.html" %}

{% block service_content %}
<!-- Voice to Voice Service Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-arrow-left-right me-2"></i>Voice Conversion</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="source-audio-input" class="form-label">Source Audio File</label>
                    <input type="file" class="form-control" id="source-audio-input" accept="audio/*,.wav,.mp3,.m4a">
                    <small class="text-muted">Upload the audio file you want to convert</small>
                </div>
                
                <div class="mb-3">
                    <label for="target-voice-select" class="form-label">Target Voice</label>
                    <select class="form-select" id="target-voice-select">
                        <option value="clone">Clone from Sample</option>
                        <option value="preset">Use Preset Voice</option>
                    </select>
                </div>
                
                <div id="voice-sample-group" class="mb-3" style="display: none;">
                    <label for="voice-sample-input" class="form-label">Voice Sample (for cloning)</label>
                    <input type="file" class="form-control" id="voice-sample-input" accept="audio/*,.wav,.mp3">
                    <small class="text-muted">Upload a sample of the target voice</small>
                </div>
                
                <div id="preset-voice-group" class="mb-3">
                    <label for="preset-voice-select" class="form-label">Preset Voice</label>
                    <select class="form-select" id="preset-voice-select">
                        <option value="male1">Male Voice 1</option>
                        <option value="male2">Male Voice 2</option>
                        <option value="female1">Female Voice 1</option>
                        <option value="female2">Female Voice 2</option>
                    </select>
                </div>
                
                <button type="button" class="btn btn-primary" id="btn-convert-voice" disabled>
                    <i class="bi bi-arrow-repeat me-2"></i>Convert Voice
                </button>
                
                <!-- Converted Audio -->
                <div id="converted-audio-container" class="mt-4" style="display: none;">
                    <h6>Converted Audio:</h6>
                    <audio id="converted-audio" controls class="w-100"></audio>
                    <div class="mt-3 text-center">
                        <button class="btn btn-sm btn-outline-primary" id="btn-download-converted">
                            <i class="bi bi-download me-1"></i>Download Converted Audio
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnConvert = document.getElementById('btn-convert-voice');
    const sourceInput = document.getElementById('source-audio-input');
    const voiceTypeSelect = document.getElementById('target-voice-select');
    
    sourceInput.addEventListener('change', function() {
        btnConvert.disabled = !this.files || this.files.length === 0;
    });
    
    voiceTypeSelect.addEventListener('change', function() {
        const isClone = this.value === 'clone';
        document.getElementById('voice-sample-group').style.display = isClone ? 'block' : 'none';
        document.getElementById('preset-voice-group').style.display = isClone ? 'none' : 'block';
    });
    
    btnConvert.addEventListener('click', convertVoice);
    document.getElementById('btn-download-converted')?.addEventListener('click', downloadConverted);
});

function convertVoice() {
    const sourceInput = document.getElementById('source-audio-input');
    if (!sourceInput.files || sourceInput.files.length === 0) {
        alert('Please select a source audio file');
        return;
    }
    
    const voiceType = document.getElementById('target-voice-select').value;
    const presetVoice = document.getElementById('preset-voice-select').value;
    const voiceSampleInput = document.getElementById('voice-sample-input');
    
    const formData = new FormData();
    formData.append('source_audio', sourceInput.files[0]);
    formData.append('target_voice_type', voiceType);
    formData.append('preset_voice', presetVoice);
    
    if (voiceType === 'clone' && voiceSampleInput.files && voiceSampleInput.files.length > 0) {
        formData.append('voice_sample', voiceSampleInput.files[0]);
    }
    
    const btnConvert = document.getElementById('btn-convert-voice');
    btnConvert.disabled = true;
    btnConvert.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Converting...';
    
    fetch('/ai-services/api/voice-to-voice/convert', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Convert base64 to audio blob
            const audioBase64 = data.audio;
            const byteCharacters = atob(audioBase64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(blob);
            
            const audioElement = document.getElementById('converted-audio');
            audioElement.src = audioUrl;
            audioElement.dataset.audioData = audioBase64;
            document.getElementById('converted-audio-container').style.display = 'block';
        } else {
            alert('Failed to convert voice: ' + (data.error || 'Unknown error'));
        }
        
        btnConvert.disabled = false;
        btnConvert.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Convert Voice';
    })
    .catch(error => {
        alert('Error converting voice: ' + error.message);
        btnConvert.disabled = false;
        btnConvert.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Convert Voice';
    });
}

function downloadConverted() {
    const audio = document.getElementById('converted-audio');
    const audioData = audio.dataset.audioData;
    
    if (!audioData) {
        alert('No audio to download');
        return;
    }
    
    // Convert base64 to blob
    const byteCharacters = atob(audioData);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: 'audio/wav' });
    
    const link = document.createElement('a');
    link.download = 'converted-voice.wav';
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
}
</script>
{% endblock %}
