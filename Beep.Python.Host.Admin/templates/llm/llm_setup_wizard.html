{% extends "base.html" %}

{% block title %}LLM Setup Wizard - Beep AI Server{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-card">
        <!-- Wizard Header -->
        <div class="wizard-header text-center mb-4">
            <h2><i class="bi bi-magic me-2"></i>LLM Setup Wizard</h2>
            <p class="text-muted">Let's find the perfect AI model for you</p>
        </div>

        <!-- Progress Steps -->
        <div class="wizard-steps mb-5">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Hardware</div>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Use Case</div>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Recommendations</div>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Configure</div>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="5">
                <div class="step-number">5</div>
                <div class="step-label">Setup</div>
            </div>
        </div>

        <!-- Step 1: Hardware Detection -->
        <div class="wizard-step-content" id="step1" style="display: block;">
            <h4 class="mb-4"><i class="bi bi-cpu me-2"></i>Your Hardware</h4>

            {% if hardware_data %}
            <!-- Hardware already detected on server-side -->
            <div id="hardware-results">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="hardware-card">
                            <div class="hardware-icon"><i class="bi bi-gpu-card"></i></div>
                            <div class="hardware-info">
                                <div class="hardware-label">GPU</div>
                                <div class="hardware-value" id="gpu-name">{{ hardware_data.gpu_name or 'No GPU detected' }}</div>
                                <div class="hardware-detail" id="gpu-vram">{% if hardware_data.vram_gb > 0 %}{{ "%.1f"|format(hardware_data.vram_gb) }} GB VRAM{% endif %}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="hardware-card">
                            <div class="hardware-icon"><i class="bi bi-memory"></i></div>
                            <div class="hardware-info">
                                <div class="hardware-label">RAM</div>
                                <div class="hardware-value" id="ram-size">{{ "%.1f"|format(hardware_data.ram_gb) }} GB</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="hardware-card">
                            <div class="hardware-icon"><i class="bi bi-hdd"></i></div>
                            <div class="hardware-info">
                                <div class="hardware-label">Disk Space</div>
                                <div class="hardware-value" id="disk-space">{{ "%.1f"|format(hardware_data.disk_free_gb) }} GB Free</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="hardware-card">
                            <div class="hardware-icon"><i class="bi bi-cpu"></i></div>
                            <div class="hardware-info">
                                <div class="hardware-label">CPU</div>
                                <div class="hardware-value" id="cpu-name">{{ hardware_data.cpu_name or 'Unknown CPU' }}</div>
                                <div class="hardware-detail" id="cpu-cores">{{ hardware_data.cpu_cores }} cores</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4" id="hardware-recommendation">
                    <i class="bi bi-lightbulb me-2"></i>
                    <span id="hardware-rec-text">
                        {% if hardware_data.vram_gb >= 10 %}
                        ‚ö° Excellent! You can run large models with GPU acceleration.
                        {% elif hardware_data.vram_gb >= 6 %}
                        ‚úÖ Good! You can run medium-sized models with GPU acceleration.
                        {% elif hardware_data.ram_gb >= 16 %}
                        üí° You can run small to medium models using CPU/RAM.
                        {% else %}
                        üìù We recommend lightweight models for your system.
                        {% endif %}
                    </span>
                </div>
            </div>
            {% else %}
            <!-- Fallback if no hardware data (should not happen) -->
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Hardware detection unavailable. Using default settings.
            </div>
            {% endif %}

            <div class="wizard-actions mt-4">
                <button class="btn btn-lg btn-primary" onclick="goToStep(2)" id="step1-next">
                    Next <i class="bi bi-arrow-right ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Use Case Selection -->
        <div class="wizard-step-content" id="step2" style="display: none;">
            <h4 class="mb-4"><i class="bi bi-bullseye me-2"></i>What will you use the AI for?</h4>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="use-case-card" data-usecase="coding" onclick="selectUseCase('coding')">
                        <div class="use-case-icon">üíª</div>
                        <h5>Coding</h5>
                        <p>Code generation, debugging, and programming assistance</p>
                        <div class="use-case-examples">
                            <small>Python ‚Ä¢ JavaScript ‚Ä¢ Code Review</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="use-case-card" data-usecase="chat" onclick="selectUseCase('chat')">
                        <div class="use-case-icon">üí¨</div>
                        <h5>Chat</h5>
                        <p>Natural conversation, Q&A, and dialogue</p>
                        <div class="use-case-examples">
                            <small>Customer Service ‚Ä¢ Personal Assistant</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="use-case-card" data-usecase="reasoning" onclick="selectUseCase('reasoning')">
                        <div class="use-case-icon">üß†</div>
                        <h5>Reasoning</h5>
                        <p>Complex problem solving, math, and logic</p>
                        <div class="use-case-examples">
                            <small>Math ‚Ä¢ Analysis ‚Ä¢ Problem Solving</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="use-case-card" data-usecase="creative" onclick="selectUseCase('creative')">
                        <div class="use-case-icon">üé®</div>
                        <h5>Creative</h5>
                        <p>Writing, storytelling, and content creation</p>
                        <div class="use-case-examples">
                            <small>Stories ‚Ä¢ Articles ‚Ä¢ Creative Writing</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="use-case-card" data-usecase="general" onclick="selectUseCase('general')">
                        <div class="use-case-icon">üìö</div>
                        <h5>General Purpose</h5>
                        <p>All-around assistant for various tasks</p>
                        <div class="use-case-examples">
                            <small>Multi-purpose ‚Ä¢ Versatile ‚Ä¢ Beginner-friendly</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wizard-actions mt-4">
                <button class="btn btn-lg btn-outline-secondary" onclick="goToStep(1)">
                    <i class="bi bi-arrow-left me-2"></i> Back
                </button>
                <button class="btn btn-lg btn-primary" onclick="getRecommendations()" id="step2-next" disabled>
                    Next <i class="bi bi-arrow-right ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: Model Recommendations -->
        <div class="wizard-step-content" id="step3" style="display: none;">
            <h4 class="mb-4"><i class="bi bi-stars me-2"></i>Recommended Models for You</h4>

            <div id="recommendations-loading" class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p class="text-muted">Finding the best models for your needs...</p>
            </div>

            <div id="recommendations-list" style="display: none;">
                <!-- Model cards will be inserted here -->
            </div>

            <div class="wizard-actions mt-4">
                <button class="btn btn-lg btn-outline-secondary" onclick="goToStep(2)">
                    <i class="bi bi-arrow-left me-2"></i> Back
                </button>
                <button class="btn btn-lg btn-primary" onclick="goToStep(4)" id="step3-next" disabled>
                    Next <i class="bi bi-arrow-right ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 4: Configuration -->
        <div class="wizard-step-content" id="step4" style="display: none;">
            <h4 class="mb-4"><i class="bi bi-gear me-2"></i>Configure Your Setup</h4>

            <div class="config-section">
                <h6>Selected Model</h6>
                <div class="selected-model-card" id="selected-model-display">
                    <div class="model-name">No model selected</div>
                </div>
            </div>

            <div class="config-section mt-4">
                <h6>GPU Backend</h6>
                <select class="form-select" id="gpu-backend" onchange="updateBackendToolkitStatus()">
                    <option value="auto">Auto-detect (Recommended)</option>
                    <option value="cuda">CUDA (NVIDIA)</option>
                    <option value="rocm">ROCm (AMD)</option>
                    <option value="metal">Metal (Apple Silicon)</option>
                    <option value="vulkan">Vulkan (AMD/Intel)</option>
                    <option value="cpu">CPU Only</option>
                </select>
                <small class="text-muted">Backend will be automatically selected based on your hardware</small>
                
                <!-- Toolkit Status Alert -->
                <div id="toolkit-status-alert" class="mt-3" style="display: none;"></div>
                <div id="toolkit-install-button" class="mt-3" style="display: none;">
                    <button class="btn btn-primary" onclick="installToolkit()">
                        <i class="bi bi-download me-2"></i><span id="toolkit-install-button-text">Install Toolkit Automatically</span>
                    </button>
                </div>
            </div>

            <div class="wizard-actions mt-4">
                <button class="btn btn-lg btn-outline-secondary" onclick="goToStep(3)">
                    <i class="bi bi-arrow-left me-2"></i> Back
                </button>
                <button class="btn btn-lg btn-success" onclick="startSetup()">
                    Start Setup <i class="bi bi-rocket-takeoff ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 5: Download & Setup -->
        <div class="wizard-step-content" id="step5" style="display: none;">
            <h4 class="mb-4"><i class="bi bi-download me-2"></i>Setting Up Your AI Model</h4>

            <div class="setup-progress">
                <div class="setup-step" id="setup-step-1">
                    <div class="setup-step-icon"><i class="bi bi-search"></i></div>
                    <div class="setup-step-info">
                        <div class="setup-step-title">Checking for Existing Model</div>
                        <div class="setup-step-status">Waiting...</div>
                    </div>
                </div>

                <div class="setup-step" id="setup-step-2">
                    <div class="setup-step-icon"><i class="bi bi-download"></i></div>
                    <div class="setup-step-info">
                        <div class="setup-step-title">Downloading Model</div>
                        <div class="setup-step-status">Waiting...</div>
                        <div class="progress mt-2" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" id="setup-step-3">
                    <div class="setup-step-icon"><i class="bi bi-box"></i></div>
                    <div class="setup-step-info">
                        <div class="setup-step-title">Creating Virtual Environment</div>
                        <div class="setup-step-status">Waiting...</div>
                    </div>
                </div>

                <div class="setup-step" id="setup-step-4">
                    <div class="setup-step-icon"><i class="bi bi-gear"></i></div>
                    <div class="setup-step-info">
                        <div class="setup-step-title">Installing Dependencies</div>
                        <div class="setup-step-status">Waiting...</div>
                    </div>
                </div>

                <div class="setup-step" id="setup-step-5">
                    <div class="setup-step-icon"><i class="bi bi-check-circle"></i></div>
                    <div class="setup-step-info">
                        <div class="setup-step-title">Finalizing Setup</div>
                        <div class="setup-step-status">Waiting...</div>
                    </div>
                </div>
            </div>

            <div class="alert alert-success mt-4" id="setup-complete" style="display: none;">
                <h5><i class="bi bi-check-circle-fill me-2"></i>Setup Complete!</h5>
                <p class="mb-0">Your AI model is ready to use. You can now start chatting or coding with AI assistance.
                </p>
            </div>

            <div class="wizard-actions mt-4" id="setup-actions" style="display: none;">
                <a href="{{ url_for('llm.index') }}" class="btn btn-lg btn-primary">
                    Go to LLM Dashboard <i class="bi bi-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .wizard-container {
        min-height: 80vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 0;
    }

    .wizard-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 16px;
        padding: 3rem;
        max-width: 900px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .wizard-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        z-index: 2;
    }

    .step-number {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--bs-secondary-bg);
        border: 2px solid var(--bs-border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--bs-secondary-color);
        transition: all 0.3s;
    }

    .step.active .step-number {
        background: var(--bs-primary);
        border-color: var(--bs-primary);
        color: white;
        transform: scale(1.1);
    }

    .step.completed .step-number {
        background: var(--bs-success);
        border-color: var(--bs-success);
        color: white;
    }

    .step-label {
        font-size: 0.875rem;
        color: var(--bs-secondary-color);
        font-weight: 500;
    }

    .step.active .step-label {
        color: var(--bs-primary);
    }

    .step-line {
        flex: 1;
        height: 2px;
        background: var(--bs-border-color);
        position: relative;
        z-index: 1;
    }

    .hardware-card {
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        transition: all 0.3s;
    }

    .hardware-card:hover {
        border-color: var(--bs-primary);
        transform: translateY(-2px);
    }

    .hardware-icon {
        font-size: 2rem;
        color: var(--bs-primary);
    }

    .hardware-label {
        font-size: 0.875rem;
        color: var(--bs-secondary-color);
        margin-bottom: 0.25rem;
    }

    .hardware-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--bs-body-color);
    }

    .hardware-detail {
        font-size: 0.875rem;
        color: var(--bs-secondary-color);
    }

    .use-case-card {
        background: var(--bs-secondary-bg);
        border: 2px solid var(--bs-border-color);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        height: 100%;
    }

    .use-case-card:hover {
        border-color: var(--bs-primary);
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(var(--bs-primary-rgb), 0.2);
    }

    .use-case-card.selected {
        border-color: var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.1);
    }

    .use-case-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .use-case-card h5 {
        margin-bottom: 0.5rem;
        color: var(--bs-body-color);
    }

    .use-case-card p {
        font-size: 0.875rem;
        color: var(--bs-secondary-color);
        margin-bottom: 1rem;
    }

    .use-case-examples {
        padding-top: 0.75rem;
        border-top: 1px solid var(--bs-border-color);
    }

    .use-case-examples small {
        color: var(--bs-secondary-color);
    }

    .model-recommendation-card {
        background: var(--bs-secondary-bg);
        border: 2px solid var(--bs-border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .model-recommendation-card:hover {
        border-color: var(--bs-primary);
        transform: translateX(4px);
    }

    .model-recommendation-card.selected {
        border-color: var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.1);
    }

    .wizard-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .setup-step {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: var(--bs-secondary-bg);
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .setup-step-icon {
        font-size: 1.5rem;
        color: var(--bs-secondary-color);
        transition: all 0.3s ease;
    }

    .setup-step.active {
        background: rgba(var(--bs-primary-rgb), 0.1);
        border-left: 3px solid var(--bs-primary);
    }

    .setup-step.active .setup-step-icon {
        color: var(--bs-primary);
        animation: pulse 1.5s infinite;
    }

    .setup-step.completed {
        background: rgba(var(--bs-success-rgb), 0.1);
        border-left: 3px solid var(--bs-success);
    }

    .setup-step.completed .setup-step-icon {
        color: var(--bs-success);
    }

    .setup-step.error {
        background: rgba(var(--bs-danger-rgb), 0.1);
        border-left: 3px solid var(--bs-danger);
    }

    .setup-step.error .setup-step-icon {
        color: var(--bs-danger);
    }

    .setup-step-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .setup-step-status {
        font-size: 0.875rem;
        color: var(--bs-secondary-color);
    }

    .setup-step.active .setup-step-status {
        color: var(--bs-primary);
        font-weight: 500;
    }

    .setup-step.completed .setup-step-status {
        color: var(--bs-success);
    }

    .setup-step.error .setup-step-status {
        color: var(--bs-danger);
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Fix for select options visibility in dark mode */
    select option {
        background-color: #1a1a2e;
        color: #fff;
    }
</style>

<script>
    console.log('LLM Wizard script loading...');
    
    let hardwareProfile = null;
    let selectedUseCase = null;
    let selectedModel = null;
    let recommendations = [];
    let backendToolkitStatus = {};

    // Initialize with server-side data (no API calls needed)
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOMContentLoaded fired');
        {% if hardware_data %}
        hardwareProfile = {{ hardware_data | tojson }};
        backendToolkitStatus = {{ backend_toolkit_status | tojson }};
        hardwareProfile.recommended_backend = '{{ recommended_backend }}';
        console.log('Hardware loaded from server:', hardwareProfile.gpu_name || 'No GPU', hardwareProfile.ram_gb + 'GB RAM');
        {% else %}
        hardwareProfile = {
            gpu_type: 'none',
            gpu_name: null,
            vram_gb: 0,
            ram_gb: 8.0,
            disk_free_gb: 10.0,
            cpu_cores: 4,
            cpu_name: 'Unknown',
            platform: 'Unknown',
            recommended_backend: 'cpu'
        };
        backendToolkitStatus = {'cpu': {'available': true, 'toolkit_name': 'CPU', 'details': 'No toolkit required'}};
        {% endif %}
        console.log('Wizard initialized. goToStep function available:', typeof goToStep);
    });

    // Refresh hardware data if needed (not called on page load)
    async function refreshHardware() {
        try {
            const response = await fetch('/llm/api/wizard/hardware');
            if (response.ok) {
                const data = await response.json();
                if (!data.error) {
                    hardwareProfile = data;
                    backendToolkitStatus = data.backend_toolkit_status || {};
                }
            }
        } catch (error) {
            console.log('Hardware refresh failed:', error);
        }
    }
    
    // Legacy function - no longer used on page load
    async function detectHardwareNonStreaming() {
        try {
            const response = await fetch('/llm/api/wizard/hardware');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Handle error in response
            if (data.error) {
                console.error('Hardware detection error:', data.error);
                if (!data.gpu_type) {
                    throw new Error(data.error);
                }
            }
            
            updateHardwareUI(data);
        } catch (error) {
            handleHardwareError(error);
        }
    }
    
    function updateHardwareUI(data) {
        hardwareProfile = data;
        backendToolkitStatus = data.backend_toolkit_status || {};

        // Update UI
        document.getElementById('hardware-loading').style.display = 'none';
        document.getElementById('hardware-results').style.display = 'block';

        document.getElementById('gpu-name').textContent = data.gpu_name || 'No GPU detected';
        document.getElementById('gpu-vram').textContent = data.vram_gb > 0 ? `${data.vram_gb} GB VRAM` : '';
        document.getElementById('ram-size').textContent = `${data.ram_gb} GB`;
        document.getElementById('disk-space').textContent = `${data.disk_free_gb} GB Free`;
        document.getElementById('cpu-name').textContent = data.cpu_name || 'Unknown CPU';
        document.getElementById('cpu-cores').textContent = `${data.cpu_cores} cores`;

        // Recommendation
        let recText = '';
        if (data.vram_gb >= 10) {
            recText = '‚ö° Excellent! You can run large models with GPU acceleration.';
        } else if (data.vram_gb >= 6) {
            recText = '‚úÖ Good! You can run medium-sized models with GPU acceleration.';
        } else if (data.ram_gb >= 16) {
            recText = 'üí° You can run small to medium models using CPU/RAM.';
        } else {
            recText = 'üìù We recommend lightweight models for your system.';
        }
        document.getElementById('hardware-rec-text').textContent = recText;

        // Enable next button
        document.getElementById('step1-next').disabled = false;
    }
    
    function handleHardwareError(error) {
        console.error('Hardware detection failed:', error);
        
        // Show fallback UI with default values instead of blocking
        const loadingEl = document.getElementById('hardware-loading');
        const resultsEl = document.getElementById('hardware-results');
        if (loadingEl) loadingEl.style.display = 'none';
        if (resultsEl) resultsEl.style.display = 'block';
        
        // Use fallback/default values
        hardwareProfile = {
            gpu_type: 'none',
            gpu_name: null,
            vram_gb: 0,
            ram_gb: 8.0,
            disk_free_gb: 10.0,
            cpu_cores: 4,
            cpu_name: 'Unknown',
            platform: 'Unknown',
            recommended_backend: 'cpu'
        };
        backendToolkitStatus = {'cpu': {'available': true, 'toolkit_name': 'CPU', 'details': 'No toolkit required'}};
        
        // Enable next button so user can continue
        const nextBtn = document.getElementById('step1-next');
        if (nextBtn) nextBtn.disabled = false;
    }

    function goToStep(stepNum) {
        console.log('goToStep called with:', stepNum);
        try {
            // Hide all steps
            for (let i = 1; i <= 5; i++) {
                const stepContent = document.getElementById(`step${i}`);
                if (stepContent) stepContent.style.display = 'none';
                
                const stepEl = document.querySelector(`.step[data-step="${i}"]`);
                if (stepEl) {
                    stepEl.classList.remove('active', 'completed');
                    if (i < stepNum) {
                        stepEl.classList.add('completed');
                        const stepNumEl = stepEl.querySelector('.step-number');
                        if (stepNumEl) stepNumEl.innerHTML = '<i class="bi bi-check-lg"></i>';
                    } else {
                        const stepNumEl = stepEl.querySelector('.step-number');
                        if (stepNumEl) stepNumEl.textContent = i;
                    }
                }
            }

            // Show current step
            const currentStep = document.getElementById(`step${stepNum}`);
            if (currentStep) {
                currentStep.style.display = 'block';
                console.log('Showing step', stepNum);
            } else {
                console.error('Step element not found:', `step${stepNum}`);
            }
            
            const currentStepIndicator = document.querySelector(`.step[data-step="${stepNum}"]`);
            if (currentStepIndicator) currentStepIndicator.classList.add('active');
            
            // Update backend status when entering step 4 (Configure)
            if (stepNum === 4) {
                updateBackendToolkitStatus();
            }
        } catch (error) {
            console.error('goToStep error:', error);
        }
    }

    function selectUseCase(useCase) {
        selectedUseCase = useCase;

        // Update UI
        document.querySelectorAll('.use-case-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-usecase="${useCase}"]`).classList.add('selected');

        // Enable next button
        document.getElementById('step2-next').disabled = false;
    }

    async function getRecommendations() {
        goToStep(3);

        document.getElementById('recommendations-loading').style.display = 'block';
        document.getElementById('recommendations-list').style.display = 'none';

        try {
            const response = await fetch('/llm/api/wizard/recommend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ use_case: selectedUseCase })
            });
            const data = await response.json();

            recommendations = data.recommendations;

            // Build recommendations UI
            const listEl = document.getElementById('recommendations-list');
            listEl.innerHTML = '';

            recommendations.forEach((model, index) => {
                const card = document.createElement('div');
                card.className = 'model-recommendation-card';
                if (index === 0) {
                    card.classList.add('selected');
                    selectedModel = model;
                    document.getElementById('step3-next').disabled = false;
                }
                card.onclick = () => selectModel(model, card);

                const speedStars = '‚ö°'.repeat(model.speed_rating);
                const qualityStars = '‚≠ê'.repeat(model.quality_rating);

                card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h5 class="mb-1">${index === 0 ? 'ü•á ' : ''}${model.model_name}</h5>
                        <span class="badge bg-secondary">${model.quantization}</span>
                        <span class="badge bg-info ms-1">${model.size_gb} GB</span>
                    </div>
                    <div class="text-end">
                        <div class="small">Speed: ${speedStars}</div>
                        <div class="small">Quality: ${qualityStars}</div>
                    </div>
                </div>
                <p class="mb-2 small">${model.description}</p>
                <div class="d-flex gap-2">
                    ${model.fits_vram ? '<span class="badge bg-success">‚úì Fits in VRAM</span>' : ''}
                    ${model.fits_ram ? '<span class="badge bg-success">‚úì Fits in RAM</span>' : ''}
                </div>
            `;

                listEl.appendChild(card);
            });

            document.getElementById('recommendations-loading').style.display = 'none';
            document.getElementById('recommendations-list').style.display = 'block';
        } catch (error) {
            console.error('Failed to get recommendations:', error);
            alert('Failed to get recommendations. Please try again.');
        }
    }

    function selectModel(model, cardEl) {
        selectedModel = model;

        document.querySelectorAll('.model-recommendation-card').forEach(card => {
            card.classList.remove('selected');
        });
        cardEl.classList.add('selected');

        // Update step 4
        document.getElementById('selected-model-display').innerHTML = `
        <div class="model-name">${model.model_name}</div>
        <div class="small text-muted">${model.size_gb} GB ‚Ä¢ ${model.quantization}</div>
    `;
        
        // Update backend toolkit status when model is selected
        updateBackendToolkitStatus();

        document.getElementById('step3-next').disabled = false;
    }

    function updateBackendToolkitStatus() {
        const backendSelect = document.getElementById('gpu-backend');
        let backend = backendSelect.value === 'auto' ? hardwareProfile?.recommended_backend || 'cpu' : backendSelect.value;
        const alertDiv = document.getElementById('toolkit-status-alert');
        const installButtonDiv = document.getElementById('toolkit-install-button');
        const installButtonText = document.getElementById('toolkit-install-button-text');
        
        // Map to actual backend IDs (LM Studio style)
        const backendMapping = {
            'cuda': 'cuda',
            'nvidia': 'cuda',
            'rocm': 'hip',
            'amd': 'hip',
            'metal': 'metal',
            'vulkan': 'vulkan',
            'intel': 'sycl',
            'cpu': 'cpu'
        };
        const backendId = backendMapping[backend.toLowerCase()] || backend.toLowerCase();
        
        // Store current backend for install function
        window.currentBackend = backendId;
        
        // Check both the generic and specific backend IDs
        let status = backendToolkitStatus[backend] || backendToolkitStatus[backendId];
        
        if (!status && backend === 'cpu') {
            // CPU is always available
            status = { available: true, toolkit_name: 'CPU', details: 'No GPU backend required' };
        }
        
        if (!status) {
            alertDiv.style.display = 'none';
            if (installButtonDiv) installButtonDiv.style.display = 'none';
            return;
        }
        
        alertDiv.style.display = 'block';
        
        if (status.available) {
            alertDiv.className = 'mt-3 alert alert-success';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                <strong>${status.toolkit_name} Ready</strong>
                <p class="mb-0 small">${status.details || 'Pre-built backend is installed and ready to use.'}</p>
            `;
            if (installButtonDiv) installButtonDiv.style.display = 'none';
        } else {
            alertDiv.className = 'mt-3 alert alert-warning';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>${status.toolkit_name} Not Installed</strong>
                <p class="mb-2 small">${status.details || 'This backend needs to be installed.'}</p>
                <p class="mb-0 small">Go to Backend Extensions to download the pre-built backend (no SDK required).</p>
            `;
            
            // Show install button - redirects to backend extensions page
            if (installButtonDiv) {
                installButtonDiv.style.display = 'block';
                if (installButtonText) {
                    installButtonText.textContent = `Go to Backend Extensions ‚Üí`;
                }
                // Update button to redirect to backend extensions page
                const installBtn = installButtonDiv.querySelector('button');
                if (installBtn) {
                    installBtn.onclick = () => {
                        window.location.href = `/llm/backend-extensions/?install=${encodeURIComponent(backendId)}`;
                    };
                }
            }
        }
    }
    
    async function installToolkit() {
        // Redirect to backend extensions page for toolkit installation
        const backend = window.currentBackend || 'cuda';
        window.location.href = `/llm/backend-extensions/?install=${encodeURIComponent(backend)}`;
        return;
        
        // OLD CODE - kept for reference but not used
        /*
        const backend = window.currentBackend || 'cuda';
        const backendLower = backend.toLowerCase();
        
        // Get toolkit name
        const toolkitNames = {
            'cuda': 'CUDA Toolkit',
            'nvidia': 'CUDA Toolkit',
            'cuda12': 'CUDA Toolkit',
            'vulkan': 'Vulkan SDK',
            'rocm': 'ROCm SDK',
            'amd': 'ROCm SDK'
        };
        const toolkitName = toolkitNames[backendLower] || 'Toolkit';
        
        // ROCm shows instructions instead of installing
        if (backendLower === 'rocm' || backendLower === 'amd') {
            const instructions = [
                'ROCm requires manual installation on Linux:',
                '',
                '1. Follow AMD ROCm installation guide',
                '2. Install ROCm packages via package manager (apt/yum)',
                '3. Set ROCM_PATH environment variable (defaults to /opt/rocm)',
                '4. Verify: rocm-smi --version',
                '5. Restart the application',
                '',
                'Installation guide: https://rocm.docs.amd.com/'
            ];
            alert(instructions.join('\n'));
            window.open('https://rocm.docs.amd.com/projects/install-on-linux/en/latest/', '_blank');
            return;
        }
        
        // Confirmation message
        const confirmMsg = {
            'cuda': 'This will download and launch the CUDA Toolkit installer automatically.\n\n' +
                   'The installer will:\n' +
                   '1. Download CUDA Toolkit (~3GB)\n' +
                   '2. Launch the installation wizard\n' +
                   '3. Require administrator privileges\n' +
                   '4. May require a system restart\n\n' +
                   'Continue?',
            'vulkan': 'This will download and launch the Vulkan SDK installer automatically.\n\n' +
                     'The installer will:\n' +
                     '1. Download Vulkan SDK (~200MB)\n' +
                     '2. Launch the installation wizard\n' +
                     '3. May require administrator privileges\n\n' +
                     'Continue?'
        };
        
        const message = confirmMsg[backendLower] || `Install ${toolkitName} automatically?`;
        if (!confirm(message)) {
            return;
        }
        
        try {
            const response = await fetch('/llm/api/toolkit/install', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    backend: backend,
                    version: backendLower.includes('12') ? '12.x' : undefined
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Redirect to task page
                window.location.href = data.redirect_url || `/tasks/${data.task_id}`;
            } else {
                alert('Failed to start installation: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
        */
    }
    
    // Backward compatibility
    async function installCUDAToolkit() {
        window.currentBackend = 'cuda';
        return installToolkit();
    }
    
    async function startSetup() {
        const backendSelect = document.getElementById('gpu-backend');
        let backend = backendSelect.value === 'auto' ? hardwareProfile?.recommended_backend || 'cpu' : backendSelect.value;
        
        console.log('startSetup called with backend:', backend);
        console.log('backendToolkitStatus:', backendToolkitStatus);
        
        // Map to embedded backend IDs (LM Studio style - we use pre-built llama.cpp binaries)
        const backendMapping = {
            'cuda': 'cuda',
            'nvidia': 'cuda', 
            'rocm': 'hip',
            'amd': 'hip',
            'metal': 'metal',
            'vulkan': 'vulkan',
            'cpu': 'cpu'
        };
        const backendId = backendMapping[backend.toLowerCase()] || backend;
        console.log('Mapped backend ID:', backendId);
        
        // Check if embedded backend is installed (only for GPU backends)
        if (backend !== 'cpu' && backendId !== 'cpu') {
            const backendStatus = backendToolkitStatus[backendId] || backendToolkitStatus[backend];
            console.log('Backend status:', backendStatus);
            
            if (backendStatus && !backendStatus.available) {
                const backendName = backendStatus.toolkit_name || backendId;
                let message = `‚ö†Ô∏è GPU Backend '${backendName}' is not installed.\n\n`;
                message += `This is a pre-built llama.cpp binary that enables GPU acceleration.\n\n`;
                message += `To install it:\n`;
                message += `1. Go to Backend Extensions page\n`;
                message += `2. Find and install '${backendName}'\n`;
                message += `3. Return here and try again\n\n`;
                message += `Would you like to go to the Backend Extensions page now?`;
                
                if (confirm(message)) {
                    window.location.href = '/llm/backend-extensions';
                }
                return;
            }
        }
        
        goToStep(5);

        // Reset all steps to waiting
        for (let i = 1; i <= 5; i++) {
            const step = document.getElementById(`setup-step-${i}`);
            step.classList.remove('active', 'completed', 'error');
            step.querySelector('.setup-step-status').textContent = 'Waiting...';
            const progress = step.querySelector('.progress');
            if (progress) progress.style.display = 'none';
        }
        document.getElementById('setup-complete').style.display = 'none';
        document.getElementById('setup-actions').style.display = 'none';

        try {
            const response = await fetch('/llm/api/wizard/setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model_id: selectedModel.model_id,
                    model_name: selectedModel.model_name,
                    backend: backend === 'auto' ? hardwareProfile.gpu_type : backend
                })
            });

            const data = await response.json();

            if (data.success) {
                // Poll for progress
                pollSetupProgress(data.task_id);
            } else {
                // Check if it's a toolkit requirement error
                if (data.toolkit_required) {
                    let errorMsg = data.error || 'Toolkit required';
                    
                    if (data.auto_install_available) {
                        errorMsg += '\n\nWould you like to install it now?';
                        if (confirm(errorMsg)) {
                            // Install toolkit
                            window.currentBackend = backend;
                            installToolkit();
                            return;
                        }
                    } else {
                        alert(errorMsg);
                        // Go back to step 4 to show toolkit status
                        goToStep(4);
                        updateBackendToolkitStatus();
                    }
                } else {
                    alert('Setup failed: ' + (data.message || data.error || 'Unknown error'));
                }
            }
        } catch (error) {
            console.error('Setup failed:', error);
            alert('Setup failed. Please try again.');
        }
    }

    async function pollSetupProgress(taskId) {
        // Map task steps to UI steps (1-indexed for UI)
        const stepMapping = {
            0: 1,  // Checking for existing model -> step 1
            1: 2,  // Downloading model -> step 2
            2: 3,  // Creating venv -> step 3
            3: 4,  // Installing deps -> step 4
            4: 5   // Finalizing -> step 5
        };

        const poll = async () => {
            try {
                const response = await fetch(`/tasks/${taskId}/status`);
                const task = await response.json();

                if (task.error) {
                    console.error('Task error:', task.error);
                    return;
                }

                // Update steps based on task progress
                if (task.steps) {
                    task.steps.forEach((step, index) => {
                        const uiStepNum = stepMapping[index];
                        if (!uiStepNum) return;
                        
                        const uiStep = document.getElementById(`setup-step-${uiStepNum}`);
                        if (!uiStep) return;

                        const statusEl = uiStep.querySelector('.setup-step-status');
                        const progressBar = uiStep.querySelector('.progress');
                        const progressBarInner = uiStep.querySelector('.progress-bar');

                        // Update status text
                        statusEl.textContent = step.message || step.status;

                        // Update step styling
                        uiStep.classList.remove('active', 'completed', 'error');
                        if (step.status === 'completed') {
                            uiStep.classList.add('completed');
                            if (progressBar) progressBar.style.display = 'none';
                        } else if (step.status === 'running') {
                            uiStep.classList.add('active');
                            // Show progress for download step (step 2 in UI, index 1 in task)
                            if (index === 1 && progressBar && task.progress) {
                                progressBar.style.display = 'block';
                                const downloadPercent = Math.max(0, Math.min(100, (task.progress - 10) * 2.5)); // 10-50% maps to 0-100%
                                progressBarInner.style.width = `${downloadPercent}%`;
                                progressBarInner.textContent = `${downloadPercent.toFixed(0)}%`;
                            }
                        } else if (step.status === 'failed') {
                            uiStep.classList.add('error');
                            statusEl.textContent = step.message || 'Failed';
                        }
                    });
                }

                // Check if completed or failed
                if (task.status === 'completed') {
                    document.getElementById('setup-complete').style.display = 'block';
                    document.getElementById('setup-actions').style.display = 'block';
                    return; // Stop polling
                } else if (task.status === 'failed') {
                    const errorAlert = document.getElementById('setup-complete');
                    errorAlert.className = 'alert alert-danger mt-4';
                    errorAlert.innerHTML = `<h5><i class="bi bi-x-circle-fill me-2"></i>Setup Failed</h5><p class="mb-0">${task.error || 'Unknown error occurred'}</p>`;
                    errorAlert.style.display = 'block';
                    document.getElementById('setup-actions').style.display = 'block';
                    return; // Stop polling
                }

                // Continue polling
                setTimeout(poll, 1000);
            } catch (error) {
                console.error('Poll error:', error);
                setTimeout(poll, 2000); // Retry with longer delay
            }
        };

        poll();
    }
</script>
{% endblock %}