{% extends "base.html" %}

{% block title %}Settings - LLM Management{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-gear me-3"></i>LLM Settings</h1>
            <p class="text-muted mb-0">Configure API tokens, storage, and inference settings</p>
        </div>
        <a href="{{ url_for('llm.index') }}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left me-2"></i>Back
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- API Tokens -->
    <div class="col-lg-6">
        <div class="card animate-fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-key me-2"></i>API Tokens</h5>
            </div>
            <div class="card-body">
                <form id="tokenForm">
                    <!-- HuggingFace Token -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-box-arrow-up-right me-1"></i>HuggingFace Token
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control bg-dark border-secondary text-light" 
                                   id="hfToken" placeholder="hf_xxxxxxxxxxxx"
                                   value="{{ settings.huggingface_token or '' }}">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleTokenVisibility('hfToken')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            Required for downloading gated models. 
                            <a href="https://huggingface.co/settings/tokens" target="_blank">Get token</a>
                        </small>
                        
                        {% if settings.huggingface_token_masked %}
                        <div class="mt-2">
                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Token configured</span>
                            <small class="text-muted ms-2">{{ settings.huggingface_token_masked }}</small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Save Token
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Download Settings -->
        <div class="card mt-4 animate-fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-download me-2"></i>Download Settings</h5>
            </div>
            <div class="card-body">
                <form id="downloadSettingsForm">
                    <div class="mb-3">
                        <label class="form-label">Default Model Format</label>
                        <select class="form-select bg-dark border-secondary text-light" id="defaultFormat">
                            <option value="gguf" {% if settings.default_format == 'gguf' %}selected{% endif %}>GGUF (Recommended)</option>
                            <option value="ggml" {% if settings.default_format == 'ggml' %}selected{% endif %}>GGML (Legacy)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Max Concurrent Downloads</label>
                        <select class="form-select bg-dark border-secondary text-light" id="maxConcurrent">
                            <option value="1" {% if settings.max_concurrent_downloads == 1 %}selected{% endif %}>1</option>
                            <option value="2" {% if settings.max_concurrent_downloads == 2 %}selected{% endif %}>2 (Default)</option>
                            <option value="3" {% if settings.max_concurrent_downloads == 3 %}selected{% endif %}>3</option>
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="autoDeleteIncomplete"
                               {% if settings.auto_delete_incomplete %}checked{% endif %}>
                        <label class="form-check-label" for="autoDeleteIncomplete">
                            Auto-delete incomplete downloads
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Save Settings
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Repositories & Directories -->
    <div class="col-lg-12 mt-4">
        <div class="row g-4">
            <!-- Model Repositories -->
            <div class="col-lg-6">
                <div class="card animate-fade-in">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-box-arrow-up-right me-2"></i>Model Repositories</h5>
                        <button class="btn btn-sm btn-success" onclick="showAddRepositoryModal()">
                            <i class="bi bi-plus me-1"></i>Add Repository
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="repositoriesList">
                            {% for repo in repositories %}
                            <div class="repository-item mb-3 p-3 rounded border {% if repo.enabled %}border-success{% else %}border-secondary{% endif %}" data-repo-id="{{ repo.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            {{ repo.name }}
                                            {% if repo.enabled %}
                                            <span class="badge bg-success">Enabled</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                            {% if repo.requires_auth %}
                                                {% if repo.api_key %}
                                                <span class="badge bg-info" title="Token configured"><i class="bi bi-key-fill"></i> Token</span>
                                                {% else %}
                                                <span class="badge bg-warning" title="Token required"><i class="bi bi-key"></i> Token Required</span>
                                                {% endif %}
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted d-block">{{ repo.type|title }}</small>
                                        {% if repo.description %}
                                        <small class="text-muted d-block mt-1">{{ repo.description }}</small>
                                        {% endif %}
                                        {% if repo.url %}
                                        <small class="text-muted d-block mt-1"><i class="bi bi-link-45deg"></i> {{ repo.url }}</small>
                                        {% endif %}
                                        {% if repo.requires_auth and not repo.api_key %}
                                        <div class="alert alert-warning mt-2 mb-0 py-2">
                                            <small>
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                <strong>Token Required:</strong> {{ repo.auth_required_for or 'Authentication required' }}
                                                <br>
                                                <a href="#" onclick="editRepositoryApiKey('{{ repo.id }}'); return false;" class="alert-link">
                                                    <i class="bi bi-key me-1"></i>Set API Key
                                                </a>
                                            </small>
                                        </div>
                                        {% elif repo.requires_auth and repo.api_key %}
                                        <div class="alert alert-success mt-2 mb-0 py-2">
                                            <small>
                                                <i class="bi bi-check-circle me-1"></i>
                                                <strong>Token Configured</strong> - Can access {{ repo.auth_required_for or 'protected content' }}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="toggleRepository('{{ repo.id }}')" title="Toggle">
                                            <i class="bi bi-{% if repo.enabled %}eye-slash{% else %}eye{% endif %}"></i>
                                        </button>
                                        {% if repo.requires_auth or repo.type == 'huggingface' or repo.type == 'custom' %}
                                        <button class="btn btn-outline-info {% if repo.requires_auth and not repo.api_key %}btn-warning{% endif %}" 
                                                onclick="editRepositoryApiKey('{{ repo.id }}')" 
                                                title="{% if repo.requires_auth and not repo.api_key %}Token Required!{% else %}API Key{% endif %}">
                                            <i class="bi bi-key{% if repo.requires_auth and not repo.api_key %}-fill{% endif %}"></i>
                                        </button>
                                        {% endif %}
                                        {% if repo.id != 'hf_default' %}
                                        <button class="btn btn-outline-danger" onclick="deleteRepository('{{ repo.id }}')" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Model Storage (Combined Directories & Storage Stats) -->
            <div class="col-lg-6">
                <div class="card animate-fade-in">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-hdd me-2"></i>Model Storage</h5>
                        <button class="btn btn-sm btn-success" onclick="showAddDirectoryModal()">
                            <i class="bi bi-plus me-1"></i>Add Directory
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Overall Storage Stats -->
                        <div class="mb-4 p-3 rounded" style="background: rgba(255,255,255,0.05);">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="bi bi-pie-chart me-1"></i> Total Models Storage</span>
                                <span class="fw-bold">{{ storage_stats.total_size_gb }} GB used</span>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                {% set usage_percent = (storage_stats.total_size / storage_stats.disk_total * 100) if storage_stats.disk_total > 0 else 0 %}
                                <div class="progress-bar {% if usage_percent > 80 %}bg-danger{% elif usage_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                     style="width: {{ usage_percent }}%"></div>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-hdd-fill me-1"></i>{{ storage_stats.disk_free_gb }} GB free of {{ storage_stats.disk_total_gb }} GB total
                            </small>
                        </div>
                        
                        <!-- Storage Directories -->
                        <h6 class="text-muted mb-3"><i class="bi bi-folder me-1"></i> Storage Directories</h6>
                        <div id="directoriesList">
                            {% for dir_obj in directories %}
                            <div class="directory-item mb-3 p-3 rounded border {% if dir_obj.enabled %}border-success{% else %}border-secondary{% endif %}" data-dir-id="{{ dir_obj.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            {{ dir_obj.name }}
                                            {% if dir_obj.id == 'default' %}
                                            <span class="badge bg-primary">Default</span>
                                            {% endif %}
                                            {% if dir_obj.enabled %}
                                            <span class="badge bg-success">Active</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted d-block text-truncate" style="max-width: 300px;" title="{{ dir_obj.path }}">
                                            <i class="bi bi-folder2"></i> {{ dir_obj.path }}
                                        </small>
                                        <!-- Storage bar for this directory -->
                                        <div class="mt-2">
                                            {% set dir_usage_percent = (dir_obj.used_space_gb / dir_obj.total_space_gb * 100) if dir_obj.total_space_gb > 0 else 0 %}
                                            <div class="progress mb-1" style="height: 4px;">
                                                <div class="progress-bar {% if dir_usage_percent > 80 %}bg-danger{% elif dir_usage_percent > 60 %}bg-warning{% else %}bg-info{% endif %}" 
                                                     style="width: {{ dir_usage_percent }}%"></div>
                                            </div>
                                            <small class="text-muted">
                                                {{ "%.1f"|format(dir_obj.used_space_gb) }} GB used
                                                {% if dir_obj.max_size_gb %}
                                                / {{ "%.0f"|format(dir_obj.max_size_gb) }} GB limit
                                                {% endif %}
                                                <span class="ms-2">{{ "%.1f"|format(dir_obj.available_space_gb) }} GB free</span>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="toggleDirectory('{{ dir_obj.id }}')" title="Toggle">
                                            <i class="bi bi-{% if dir_obj.enabled %}eye-slash{% else %}eye{% endif %}"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="editDirectory('{{ dir_obj.id }}')" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="openFolder('{{ dir_obj.path }}')" title="Open Folder">
                                            <i class="bi bi-folder2-open"></i>
                                        </button>
                                        {% if dir_obj.id != 'default' %}
                                        <button class="btn btn-outline-danger" onclick="deleteDirectory('{{ dir_obj.id }}')" title="Remove">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="mt-3 pt-3 border-top border-secondary">
                            <button class="btn btn-outline-warning btn-sm" onclick="clearCache()">
                                <i class="bi bi-trash me-1"></i>Clear Download Cache
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hardware & Backend Info -->
    <div class="col-lg-6 mt-4">
        <!-- GPU/Hardware Info -->
        <div class="card mt-4 animate-fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gpu-card me-2"></i>Hardware & Backend</h5>
            </div>
            <div class="card-body">
                <!-- Inference Mode -->
                <div class="mb-3">
                    <strong>Inference Mode</strong>
                    <div class="mt-2">
                        {% if hardware_info.server_available %}
                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Native Server (LM Studio style)</span>
                        {% elif hardware_info.llama_cpp_available %}
                        <span class="badge bg-info"><i class="bi bi-info-circle me-1"></i>Legacy Python Mode</span>
                        {% else %}
                        <span class="badge bg-warning"><i class="bi bi-exclamation-triangle me-1"></i>No Backend Installed</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Active Backend -->
                <div class="mb-3">
                    <strong>Active Backend</strong>
                    <div class="mt-2">
                        {% if hardware_info.server_backend %}
                        <span class="badge bg-primary"><i class="bi bi-lightning-fill me-1"></i>{{ hardware_info.server_backend|upper }}</span>
                        {% elif hardware_info.current_backend %}
                        <span class="badge bg-secondary">{{ hardware_info.current_backend|upper }}</span>
                        {% else %}
                        <span class="badge bg-secondary">CPU</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Installed Backends -->
                {% if hardware_info.installed_backends %}
                <div class="mb-3">
                    <strong>Installed Backends</strong>
                    <div class="mt-2">
                        {% for backend in hardware_info.installed_backends %}
                        <span class="badge bg-success me-1 mb-1">
                            <i class="bi bi-check me-1"></i>{{ backend.name or backend.id }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- GPUs -->
                {% if hardware_info.gpus %}
                <div class="mb-3">
                    <strong>Detected GPUs</strong>
                    <ul class="list-unstyled mt-2 mb-0">
                        {% for gpu in hardware_info.gpus %}
                        <li class="mb-1">
                            <i class="bi bi-gpu-card me-2 text-success"></i>
                            {{ gpu.name }}
                            {% if gpu.memory_gb %}
                            <small class="text-muted">({{ gpu.memory_gb|round(1) }} GB)</small>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Inference Engine Status -->
        <div class="card mt-4 animate-fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cpu me-2"></i>Inference Engine</h5>
            </div>
            <div class="card-body">
                {% if hardware_info.server_available %}
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Native llama.cpp Server</strong> is ready
                    {% if hardware_info.server_backend %}
                    <br><small class="text-muted">Using {{ hardware_info.server_backend|upper }} backend</small>
                    {% endif %}
                </div>
                <p class="small text-muted">
                    This uses pre-built llama.cpp binaries for maximum performance. 
                    No Python compilation required.
                </p>
                <a href="{{ url_for('backend_extensions.index') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-puzzle me-1"></i>Manage Backends
                </a>
                {% elif hardware_info.llama_cpp_available %}
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <strong>llama-cpp-python</strong> is installed (legacy mode)
                </div>
                <p class="small text-muted mb-2">
                    Consider installing a native backend for better performance:
                </p>
                <a href="{{ url_for('backend_extensions.index') }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-download me-1"></i>Install Native Backend
                </a>
                {% else %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>No inference backend installed</strong>
                </div>
                <p class="small text-muted mb-2">
                    Install a backend to enable local model inference:
                </p>
                <a href="{{ url_for('backend_extensions.index') }}" class="btn btn-primary">
                    <i class="bi bi-download me-1"></i>Install Backend
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function toggleTokenVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

function copyText(text) {
    navigator.clipboard.writeText(text);
    // Could add toast notification here
}

function openFolder(path) {
    // This would need OS-specific handling
    alert('Models are stored at:\n' + path);
}

async function clearCache() {
    if (!confirm('Clear download cache? This will not affect downloaded models.')) return;
    // Implement cache clearing
    alert('Cache cleared!');
}

// Token form
document.getElementById('tokenForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const token = document.getElementById('hfToken').value.trim();
    
    try {
        const response = await fetch('/llm/settings/token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: token})
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to save token');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Download settings form
document.getElementById('downloadSettingsForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const response = await fetch('/llm/settings/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                default_format: document.getElementById('defaultFormat').value,
                max_concurrent_downloads: document.getElementById('maxConcurrent').value,
                auto_delete_incomplete: document.getElementById('autoDeleteIncomplete').checked
            })
        });
        
        if (response.ok) {
            alert('Settings saved!');
        } else {
            alert('Failed to save settings');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Repository Management
async function toggleRepository(repoId) {
    try {
        const repos = await fetch('/llm/api/repositories').then(r => r.json());
        const repo = repos.repositories.find(r => r.id === repoId);
        if (!repo) return;
        
        // Warn if enabling a repository that requires auth but has no token
        if (!repo.enabled && repo.requires_auth && !repo.has_api_key) {
            const proceed = confirm(
                `Warning: ${repo.name} requires an API key for ${repo.auth_required_for || 'authentication'}.\n\n` +
                `You can enable it now and set the token later, but some features may not work.\n\n` +
                `Continue?`
            );
            if (!proceed) return;
        }
        
        const response = await fetch(`/llm/api/repositories/${repoId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: !repo.enabled})
        });
        
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function editRepositoryApiKey(repoId) {
    // Get repository info to show helpful message
    const repos = await fetch('/llm/api/repositories').then(r => r.json());
    const repo = repos.repositories.find(r => r.id === repoId);
    
    let message = 'Enter API Key:';
    if (repo && repo.requires_auth) {
        message = `This repository requires an API key for ${repo.auth_required_for || 'authentication'}.\n\n` +
                 `Enter API Key (leave empty to remove):`;
        if (repo.type === 'huggingface') {
            message += '\n\nGet your token at: https://huggingface.co/settings/tokens';
        }
    }
    
    const apiKey = prompt(message);
    if (apiKey === null) return;
    
    try {
        const response = await fetch(`/llm/api/repositories/${repoId}/api-key`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({api_key: apiKey})
        });
        
        if (response.ok) {
            alert('API key saved!');
            location.reload();
        } else {
            alert('Failed to save API key');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteRepository(repoId) {
    if (!confirm('Delete this repository? This will not delete downloaded models.')) return;
    
    try {
        const response = await fetch(`/llm/api/repositories/${repoId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to delete repository');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function showAddRepositoryModal() {
    const name = prompt('Repository Name:');
    if (!name) return;
    
    const type = prompt('Type (huggingface/ollama/local/custom):', 'custom');
    if (!type) return;
    
    const url = type === 'custom' ? prompt('Repository URL:') : null;
    
    fetch('/llm/api/repositories', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            type: type,
            url: url,
            enabled: true
        })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to add repository');
        }
    });
}

// Directory Management
async function toggleDirectory(dirId) {
    try {
        const dirs = await fetch('/llm/api/directories').then(r => r.json());
        const dir = dirs.directories.find(d => d.id === dirId);
        if (!dir) return;
        
        const response = await fetch(`/llm/api/directories/${dirId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: !dir.enabled})
        });
        
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function editDirectory(dirId) {
    const dirs = await fetch('/llm/api/directories').then(r => r.json());
    const dir = dirs.directories.find(d => d.id === dirId);
    if (!dir) return;
    
    const name = prompt('Directory Name:', dir.name);
    if (!name) return;
    
    const path = prompt('Directory Path:', dir.path);
    if (!path) return;
    
    const maxSize = prompt('Max Size (GB, leave empty for unlimited):', dir.max_size_gb || '');
    
    try {
        const response = await fetch(`/llm/api/directories/${dirId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                path: path,
                max_size_gb: maxSize ? parseFloat(maxSize) : null
            })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to update directory');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteDirectory(dirId) {
    if (!confirm('Remove this directory from configuration? This will NOT delete the files.')) return;
    
    try {
        const response = await fetch(`/llm/api/directories/${dirId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to delete directory');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function showAddDirectoryModal() {
    const name = prompt('Directory Name:');
    if (!name) return;
    
    const path = prompt('Directory Path (full path):');
    if (!path) return;
    
    const maxSize = prompt('Max Size (GB, leave empty for unlimited):', '');
    
    fetch('/llm/api/directories', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            path: path,
            max_size_gb: maxSize ? parseFloat(maxSize) : null,
            enabled: true
        })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to add directory');
        }
    });
}
</script>
{% endblock %}
