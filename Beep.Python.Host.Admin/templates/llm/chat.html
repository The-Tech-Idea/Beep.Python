{% extends "base.html" %}

{% block title %}Chat - LLM Management{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-chat-dots me-3"></i>Chat with AI</h1>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('llm.local_models') }}" class="btn btn-outline-light">
            <i class="bi bi-box me-2"></i>Manage Models
        </a>
    </div>
</div>

{% if not has_model_environments %}
<!-- No Models With Environments -->
<div class="card animate-fade-in">
    <div class="card-body text-center py-5">
        <i class="bi bi-box display-1 text-warning mb-3"></i>
        <h4>No Model Environments Set Up</h4>
        <p class="text-muted mb-4">Set up an environment for a model to enable AI chat</p>
        
        {% if local_models %}
        <p class="text-muted">You have {{ local_models|length }} model(s) downloaded. Set up an environment for one to start chatting.</p>
        {% endif %}
        
        <a href="{{ url_for('llm.local_models') }}" class="btn btn-primary">
            <i class="bi bi-gear me-2"></i>Set Up Model Environment
        </a>
    </div>
</div>

{% elif not loaded_models %}
<!-- No Models Loaded -->
<div class="card animate-fade-in">
    <div class="card-body text-center py-5">
        <i class="bi bi-play-circle display-1 text-muted mb-3"></i>
        <h4>No Models Loaded</h4>
        <p class="text-muted mb-4">Load a model to start chatting</p>
        
        {% if models_with_env %}
        <div class="mb-4">
            <h6>Models Ready to Load:</h6>
            <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                {% for model in models_with_env[:5] %}
                <button class="btn btn-outline-success" onclick="quickLoadModel('{{ model.id }}', '{{ model.name }}')">
                    <i class="bi bi-play me-1"></i>{{ model.name[:30] }}{% if model.name|length > 30 %}...{% endif %}
                    <span class="badge bg-success ms-1">{{ model.venv_name }}</span>
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <a href="{{ url_for('llm.local_models') }}" class="btn btn-primary">
            <i class="bi bi-box me-2"></i>Manage Models
        </a>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-4" style="width: 4rem; height: 4rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 id="loadingModelName">Loading Model...</h4>
                <p class="text-muted mb-3" id="loadingStatus">Initializing inference engine</p>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="loadingProgress" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="loadingDetail">This may take a minute for large models...</small>
            </div>
        </div>
    </div>
</div>

<script>
let loadingModal = null;

function showLoadingModal(modelName) {
    document.getElementById('loadingModelName').textContent = `Loading ${modelName}...`;
    document.getElementById('loadingStatus').textContent = 'Initializing inference engine';
    document.getElementById('loadingProgress').style.width = '10%';
    document.getElementById('loadingDetail').textContent = 'This may take a minute for large models...';
    
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Simulate progress
    let progress = 10;
    const stages = [
        { progress: 30, status: 'Loading model file...', detail: 'Reading GGUF format' },
        { progress: 50, status: 'Initializing tensors...', detail: 'Allocating memory' },
        { progress: 70, status: 'Building context...', detail: 'Setting up inference' },
        { progress: 90, status: 'Warming up...', detail: 'Almost ready!' }
    ];
    
    let stageIndex = 0;
    const progressInterval = setInterval(() => {
        if (stageIndex < stages.length) {
            const stage = stages[stageIndex];
            document.getElementById('loadingProgress').style.width = stage.progress + '%';
            document.getElementById('loadingStatus').textContent = stage.status;
            document.getElementById('loadingDetail').textContent = stage.detail;
            stageIndex++;
        }
    }, 2000);
    
    return progressInterval;
}

function hideLoadingModal(progressInterval) {
    if (progressInterval) clearInterval(progressInterval);
    document.getElementById('loadingProgress').style.width = '100%';
    document.getElementById('loadingStatus').textContent = 'Model loaded successfully!';
    document.getElementById('loadingDetail').textContent = 'Redirecting...';
    
    setTimeout(() => {
        if (loadingModal) loadingModal.hide();
    }, 500);
}

function showLoadingError(progressInterval, error) {
    if (progressInterval) clearInterval(progressInterval);
    document.getElementById('loadingProgress').classList.remove('progress-bar-animated');
    document.getElementById('loadingProgress').classList.add('bg-danger');
    document.getElementById('loadingStatus').textContent = 'Failed to load model';
    document.getElementById('loadingDetail').innerHTML = `<span class="text-danger">${error}</span>`;
    
    setTimeout(() => {
        if (loadingModal) loadingModal.hide();
    }, 3000);
}

async function quickLoadModel(modelId, modelName) {
    // Show loading modal
    const progressInterval = showLoadingModal(modelName);
    
    // Disable buttons
    const buttons = document.querySelectorAll('.btn-outline-success');
    buttons.forEach(btn => btn.disabled = true);
    
    try {
        const response = await fetch(`/llm/models/${modelId}/load`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({n_ctx: 4096})
        });
        
        if (response.ok) {
            hideLoadingModal(progressInterval);
            setTimeout(() => location.reload(), 600);
        } else {
            const data = await response.json();
            showLoadingError(progressInterval, data.error || 'Failed to load model');
            buttons.forEach(btn => btn.disabled = false);
        }
    } catch (error) {
        showLoadingError(progressInterval, error.message);
        buttons.forEach(btn => btn.disabled = false);
    }
}
</script>

{% else %}
<!-- Chat Interface -->
<div class="row g-4" style="height: calc(100vh - 200px); min-height: 500px;">
    <!-- Chat Area -->
    <div class="col-lg-9 d-flex flex-column" style="height: 100%;">
        <div class="card flex-grow-1 d-flex flex-column animate-fade-in" style="height: 100%;">
            <!-- Chat Header -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <select class="form-select bg-dark border-secondary text-light me-3" 
                            id="modelSelect" style="width: auto;">
                        {% for model in loaded_models %}
                        <option value="{{ model.model_id }}" 
                                {% if current_session and current_session.model_id == model.model_id %}selected{% endif %}>
                            {{ model.model_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <span class="badge bg-success">
                        <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>Connected
                    </span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()" title="New Chat">
                        <i class="bi bi-plus-lg me-1"></i>New Chat
                    </button>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div class="card-body flex-grow-1 overflow-auto" id="messagesArea" style="height: 0;">
                <div id="messagesContainer">
                    {% if current_session and current_session.messages %}
                        {% for msg in current_session.messages %}
                        <div class="message {{ msg.role }}">
                            <div class="message-avatar">
                                {% if msg.role == 'user' %}
                                <i class="bi bi-person-fill"></i>
                                {% elif msg.role == 'assistant' %}
                                <i class="bi bi-robot"></i>
                                {% else %}
                                <i class="bi bi-gear"></i>
                                {% endif %}
                            </div>
                            <div class="message-content">
                                <div class="message-role">{{ msg.role|capitalize }}</div>
                                <div class="message-text">{{ msg.content }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center text-muted py-5" id="welcomeMessage">
                        <i class="bi bi-chat-dots display-4 mb-3 d-block"></i>
                        <h5>Start a Conversation</h5>
                        <p class="small">Type a message below to begin chatting with the AI</p>
                    </div>
                    {% endif %}
                </div>
                <div id="typingIndicator" class="message assistant" style="display: none;">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-role">Assistant</div>
                        <div class="message-text">
                            <span class="typing-dots">
                                <span></span><span></span><span></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="card-footer border-secondary">
                <form id="chatForm" class="d-flex gap-2">
                    <textarea class="form-control bg-dark border-secondary text-light" 
                              id="messageInput" 
                              placeholder="Type your message..." 
                              rows="1"
                              style="resize: none;"></textarea>
                    <button type="submit" class="btn btn-primary" id="sendBtn">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">Press Enter to send, Shift+Enter for new line</small>
                    <small class="text-muted" id="tokenCount"></small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-3 d-flex flex-column" style="height: 100%;">
        <!-- Settings -->
        <div class="card animate-fade-in mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>Settings</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small">System Prompt</label>
                    <textarea class="form-control form-control-sm bg-dark border-secondary text-light" 
                              id="systemPrompt" rows="3" 
                              placeholder="You are a helpful assistant...">{{ current_session.system_prompt if current_session and current_session.system_prompt else '' }}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label small">Temperature: <span id="tempDisplay">0.7</span></label>
                    <input type="range" class="form-range" id="tempSlider" 
                           min="0" max="2" step="0.1" value="0.7">
                </div>
                <div class="mb-3">
                    <label class="form-label small">Max Tokens</label>
                    <input type="number" class="form-control form-control-sm bg-dark border-secondary text-light" 
                           id="maxTokens" value="2048" min="64" max="4096">
                </div>
                
                <hr class="my-3 border-secondary">
                
                <h6 class="small mb-3"><i class="bi bi-magic me-2"></i>AI Services Integration</h6>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="enableImageGen">
                    <label class="form-check-label small" for="enableImageGen">
                        Auto-generate images
                    </label>
                    <small class="d-block text-muted ms-4">Generate images when LLM requests them</small>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="enableTTS">
                    <label class="form-check-label small" for="enableTTS">
                        Text-to-Speech
                    </label>
                    <small class="d-block text-muted ms-4">Convert responses to speech</small>
                </div>
                
                <div id="ttsOptions" class="ms-4 mb-3" style="display: none;">
                    <label class="form-label small">Voice</label>
                    <select class="form-select form-select-sm bg-dark border-secondary text-light" id="ttsVoice">
                        <option value="default">Default</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Model Info -->
        <div class="card animate-fade-in flex-grow-1">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Model Info</h6>
            </div>
            <div class="card-body" id="modelInfo">
                {% if loaded_models %}
                {% set model = loaded_models[0] %}
                <p class="mb-2"><strong>{{ model.model_name }}</strong></p>
                <small class="text-muted d-block mb-1">
                    <i class="bi bi-clock me-1"></i>Uptime: {{ (model.uptime_seconds / 60)|round(1) }} min
                </small>
                <small class="text-muted d-block mb-1">
                    <i class="bi bi-chat-dots me-1"></i>Requests: {{ model.request_count }}
                </small>
                <small class="text-muted d-block">
                    <i class="bi bi-type me-1"></i>Tokens: {{ model.total_tokens_generated }}
                </small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
#messagesContainer {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.02);
}

.message.user {
    background: rgba(102, 126, 234, 0.1);
}

.message.assistant {
    background: rgba(255, 255, 255, 0.05);
}

.message.system {
    background: rgba(255, 193, 7, 0.1);
    font-style: italic;
}

.message-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
}

.message.user .message-avatar {
    background: rgba(102, 126, 234, 0.3);
}

.message.assistant .message-avatar {
    background: rgba(40, 167, 69, 0.3);
}

.message-content {
    flex-grow: 1;
    min-width: 0;
}

.message-role {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--bs-secondary);
    margin-bottom: 0.25rem;
}

.message-text {
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.6;
}

.typing-dots {
    display: inline-flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--bs-secondary);
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
    }
    30% {
        opacity: 1;
        transform: scale(1);
    }
}

#messageInput {
    min-height: 42px;
    max-height: 120px;
}
</style>

<script>
let currentSessionId = {{ current_session.id|tojson if current_session else 'null' }};
let isStreaming = false;

// Auto-resize textarea
const messageInput = document.getElementById('messageInput');
messageInput?.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Handle Enter key
messageInput?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }
});

// Temperature slider
document.getElementById('tempSlider')?.addEventListener('input', function(e) {
    document.getElementById('tempDisplay').textContent = e.target.value;
});

// TTS toggle
document.getElementById('enableTTS')?.addEventListener('change', function() {
    document.getElementById('ttsOptions').style.display = this.checked ? 'block' : 'none';
});

// Chat form submission
document.getElementById('chatForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content || isStreaming) return;
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Remove welcome message
    document.getElementById('welcomeMessage')?.remove();
    
    // Add user message to UI
    addMessage('user', content);
    
    // Create session if needed
    if (!currentSessionId) {
        await createSession();
    }
    
    // Send message
    await sendMessage(content);
});

function addMessage(role, content, isHtml = false) {
    const container = document.getElementById('messagesContainer');
    const icons = {
        user: 'bi-person-fill',
        assistant: 'bi-robot',
        system: 'bi-gear'
    };
    
    const messageEl = document.createElement('div');
    messageEl.className = `message ${role}`;
    
    const contentHtml = isHtml ? content : escapeHtml(content);
    
    messageEl.innerHTML = `
        <div class="message-avatar">
            <i class="bi ${icons[role]}"></i>
        </div>
        <div class="message-content">
            <div class="message-role">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
            <div class="message-text">${contentHtml}</div>
        </div>
    `;
    
    container.appendChild(messageEl);
    scrollToBottom();
    
    return messageEl;
}

async function sendEnhancedMessage(content, enableImageGen, enableTTS, ttsVoice) {
    if (!currentSessionId) return;
    
    isStreaming = true;
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    // Show typing indicator
    document.getElementById('typingIndicator').style.display = 'flex';
    scrollToBottom();
    
    try {
        // Get current conversation history
        const messages = Array.from(document.querySelectorAll('.message')).map(msgEl => {
            const role = msgEl.classList.contains('user') ? 'user' : 
                        msgEl.classList.contains('assistant') ? 'assistant' : 'system';
            const content = msgEl.querySelector('.message-text').textContent;
            return { role, content };
        });
        
        // Add current user message
        messages.push({ role: 'user', content: content });
        
        // Get model ID - try multiple selectors
        const modelSelect = document.getElementById('modelSelect') || 
                           document.querySelector('[id*="model"]') ||
                           document.querySelector('select');
        const modelId = modelSelect ? modelSelect.value : null;
        
        // Call enhanced chat API
        const response = await fetch('/llm/api/chat/enhanced', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                messages: messages,
                model_id: modelId,
                options: {
                    auto_generate_images: enableImageGen,
                    auto_generate_speech: enableTTS,
                    voice: ttsVoice,
                    speed: 1.0
                }
            })
        });
        
        const data = await response.json();
        
        // Hide typing indicator
        document.getElementById('typingIndicator').style.display = 'none';
        
        if (data.success) {
            // Add LLM response
            const messageEl = addMessage('assistant', data.message);
            
            // Add images if generated
            if (data.images && data.images.length > 0) {
                data.images.forEach((imgData, idx) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'mt-2';
                    imgContainer.innerHTML = `
                        <img src="data:image/png;base64,${imgData.image}" 
                             alt="Generated image ${idx + 1}" 
                             class="img-fluid rounded" 
                             style="max-width: 512px; cursor: pointer;"
                             onclick="window.open(this.src, '_blank')">
                        <small class="text-muted d-block mt-1">Generated: ${escapeHtml(imgData.prompt)}</small>
                    `;
                    messageEl.querySelector('.message-content').appendChild(imgContainer);
                });
            }
            
            // Add audio player if TTS was generated
            if (data.audio) {
                const audioContainer = document.createElement('div');
                audioContainer.className = 'mt-2';
                
                // Convert base64 to blob URL
                const byteCharacters = atob(data.audio);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(blob);
                
                audioContainer.innerHTML = `
                    <audio controls class="w-100" style="max-width: 400px;">
                        <source src="${audioUrl}" type="audio/mpeg">
                    </audio>
                `;
                messageEl.querySelector('.message-content').appendChild(audioContainer);
            }
            
            scrollToBottom();
        } else {
            addMessage('system', 'Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        document.getElementById('typingIndicator').style.display = 'none';
        addMessage('system', 'Error: ' + error.message);
    } finally {
        isStreaming = false;
        sendBtn.disabled = false;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function scrollToBottom() {
    const area = document.getElementById('messagesArea');
    area.scrollTop = area.scrollHeight;
}

async function createSession() {
    // Try to find model select - it might be in a different location
    const modelSelect = document.getElementById('modelSelect') || 
                       document.querySelector('[id*="model"]') ||
                       document.querySelector('select');
    const modelId = modelSelect ? modelSelect.value : null;
    const systemPrompt = document.getElementById('systemPrompt')?.value.trim() || '';
    
    const response = await fetch('/llm/chat/session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            model_id: modelId,
            system_prompt: systemPrompt || null
        })
    });
    
    const data = await response.json();
    if (data.session) {
        currentSessionId = data.session.id;
    }
}

async function sendMessage(content) {
    if (!currentSessionId) return;
    
    const enableImageGen = document.getElementById('enableImageGen')?.checked || false;
    const enableTTS = document.getElementById('enableTTS')?.checked || false;
    const ttsVoice = document.getElementById('ttsVoice')?.value || 'default';
    
    // Check if enhanced features are enabled
    if (enableImageGen || enableTTS) {
        await sendEnhancedMessage(content, enableImageGen, enableTTS, ttsVoice);
        return;
    }
    
    isStreaming = true;
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    // Show typing indicator
    document.getElementById('typingIndicator').style.display = 'flex';
    scrollToBottom();
    
    try {
        const response = await fetch(`/llm/chat/session/${currentSessionId}/message`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                content: content,
                stream: true
            })
        });
        
        // Hide typing indicator
        document.getElementById('typingIndicator').style.display = 'none';
        
        // Create assistant message element
        const messageEl = addMessage('assistant', '');
        const textEl = messageEl.querySelector('.message-text');
        
        // Stream response
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        
        while (true) {
            const {value, done} = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        if (data.token) {
                            fullText += data.token;
                            textEl.textContent = fullText;
                            scrollToBottom();
                        }
                        if (data.error) {
                            textEl.innerHTML = `<span class="text-danger">Error: ${data.error}</span>`;
                        }
                    } catch (e) {}
                }
            }
        }
        
    } catch (error) {
        document.getElementById('typingIndicator').style.display = 'none';
        addMessage('assistant', `Error: ${error.message}`);
    } finally {
        isStreaming = false;
        sendBtn.disabled = false;
    }
}

function clearChat() {
    if (currentSessionId) {
        fetch(`/llm/chat/session/${currentSessionId}`, {method: 'DELETE'});
    }
    currentSessionId = null;
    document.getElementById('messagesContainer').innerHTML = `
        <div class="text-center text-muted py-5" id="welcomeMessage">
            <i class="bi bi-chat-dots display-4 mb-3 d-block"></i>
            <h5>Start a Conversation</h5>
            <p class="small">Type a message below to begin chatting with the AI</p>
        </div>
    `;
}
</script>
{% endif %}
{% endblock %}
