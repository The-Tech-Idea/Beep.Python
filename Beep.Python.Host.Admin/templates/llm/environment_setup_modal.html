<!-- Environment Setup Modal -->
<div class="modal fade" id="environmentSetupModal" tabindex="-1" aria-labelledby="environmentSetupModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="environmentSetupModalLabel">
                    <i class="bi bi-box me-2"></i>Setup Environment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Model Info -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle me-2"></i>
                        <div>
                            <strong>Model:</strong> <span id="env-model-name">-</span><br>
                            <small class="text-muted">Each model gets its own isolated virtual environment</small>
                        </div>
                    </div>
                </div>

                <!-- Environment Name -->
                <div class="mb-3">
                    <label for="env-name" class="form-label">Environment Name</label>
                    <input type="text" class="form-control" id="env-name" readonly>
                    <small class="text-muted">Auto-generated based on model name</small>
                </div>

                <!-- GPU Backend Selection -->
                <div class="mb-3">
                    <label for="env-gpu-backend" class="form-label">
                        <i class="bi bi-gpu-card me-1"></i>GPU Backend
                    </label>
                    <select class="form-select" id="env-gpu-backend">
                        <option value="cpu">CPU Only (Default)</option>
                        <option value="cuda">CUDA (NVIDIA GPU)</option>
                        <option value="rocm">ROCm (AMD GPU)</option>
                        <option value="metal">Metal (Apple Silicon)</option>
                        <option value="vulkan">Vulkan (Cross-platform GPU)</option>
                        <option value="openblas">OpenBLAS (CPU Optimized)</option>
                    </select>
                    <small class="text-muted" id="env-backend-hint">
                        <span id="detected-hardware"></span>
                    </small>
                    <div class="alert alert-warning mt-2 small py-2" id="gpu-compile-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Note:</strong> GPU builds compile from source and may take 5-15 minutes.
                        Ensure you have the required SDK installed (CUDA Toolkit, ROCm, etc.)
                    </div>
                </div>

                <!-- Progress Section (hidden initially) -->
                <div id="env-progress-section" style="display: none;">
                    <hr>
                    <h6 class="mb-3">Setup Progress</h6>

                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            id="env-progress-bar" style="width: 0%">0%</div>
                    </div>

                    <div class="setup-steps">
                        <div class="setup-step" id="step-create-venv">
                            <i class="bi bi-circle step-icon"></i>
                            <span class="step-text">Creating virtual environment...</span>
                        </div>
                        <div class="setup-step" id="step-install-deps">
                            <i class="bi bi-circle step-icon"></i>
                            <span class="step-text">Installing llama-cpp-python...</span>
                        </div>
                        <div class="setup-step" id="step-verify">
                            <i class="bi bi-circle step-icon"></i>
                            <span class="step-text">Verifying installation...</span>
                        </div>
                        <div class="setup-step" id="step-associate">
                            <i class="bi bi-circle step-icon"></i>
                            <span class="step-text">Associating with model...</span>
                        </div>
                    </div>
                </div>

                <!-- Success Message (hidden initially) -->
                <div id="env-success-message" class="alert alert-success mt-3" style="display: none;">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Environment Ready!</strong> Your model is now ready to load.
                </div>

                <!-- Error Message (hidden initially) -->
                <div id="env-error-message" class="alert alert-danger mt-3" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Setup Failed:</strong> <span id="env-error-text"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                    id="env-cancel-btn">Cancel</button>
                <button type="button" class="btn btn-primary" id="env-create-btn" onclick="createEnvironment()">
                    <i class="bi bi-rocket-takeoff me-2"></i>Create Environment
                </button>
                <button type="button" class="btn btn-success" id="env-done-btn" style="display: none;"
                    data-bs-dismiss="modal">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .setup-steps {
        margin-top: 1rem;
    }

    .setup-step {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 6px;
        background: var(--bs-secondary-bg);
    }

    .setup-step .step-icon {
        margin-right: 0.75rem;
        font-size: 1rem;
        color: var(--bs-secondary-color);
    }

    .setup-step.active .step-icon {
        color: var(--bs-primary);
    }

    .setup-step.completed .step-icon {
        color: var(--bs-success);
    }

    .setup-step.completed .step-icon::before {
        content: "\f26b";
        /* bi-check-circle-fill */
    }

    .setup-step.failed .step-icon {
        color: var(--bs-danger);
    }

    .setup-step.failed .step-icon::before {
        content: "\f659";
        /* bi-x-circle-fill */
    }

    .step-text {
        font-size: 0.875rem;
    }
</style>

<script>
    let currentModelForEnv = null;

    // Detect hardware on page load
    async function detectHardware() {
        try {
            const response = await fetch('/llm/api/hardware/detect');
            const data = await response.json();
            
            let detected = [];
            if (data.backends) {
                data.backends.forEach(b => {
                    if (b.available) {
                        if (b.type === 'cuda') detected.push('NVIDIA CUDA');
                        else if (b.type === 'rocm') detected.push('AMD ROCm');
                        else if (b.type === 'metal') detected.push('Apple Metal');
                        else if (b.type === 'vulkan') detected.push('Vulkan');
                    }
                });
            }
            
            const hint = document.getElementById('detected-hardware');
            if (detected.length > 0) {
                hint.innerHTML = `<i class="bi bi-check-circle text-success me-1"></i>Detected: ${detected.join(', ')}`;
                
                // Auto-select best backend
                const select = document.getElementById('env-gpu-backend');
                if (detected.includes('NVIDIA CUDA')) {
                    select.value = 'cuda';
                } else if (detected.includes('AMD ROCm')) {
                    select.value = 'rocm';
                } else if (detected.includes('Apple Metal')) {
                    select.value = 'metal';
                } else if (detected.includes('Vulkan')) {
                    select.value = 'vulkan';
                }
                updateGpuWarning();
            } else {
                hint.innerHTML = `<i class="bi bi-cpu text-muted me-1"></i>No GPU detected - using CPU`;
            }
        } catch (e) {
            console.error('Failed to detect hardware:', e);
        }
    }
    
    function updateGpuWarning() {
        const select = document.getElementById('env-gpu-backend');
        const warning = document.getElementById('gpu-compile-warning');
        
        if (select.value !== 'cpu' && select.value !== 'openblas') {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }
    
    document.getElementById('env-gpu-backend')?.addEventListener('change', updateGpuWarning);
    
    // Detect hardware when page loads
    detectHardware();

    function openEnvironmentSetup(modelId, modelName) {
        currentModelForEnv = modelId;

        // Reset modal state
        document.getElementById('env-model-name').textContent = modelName;
        document.getElementById('env-progress-section').style.display = 'none';
        document.getElementById('env-success-message').style.display = 'none';
        document.getElementById('env-error-message').style.display = 'none';
        document.getElementById('env-create-btn').style.display = 'inline-block';
        document.getElementById('env-done-btn').style.display = 'none';
        document.getElementById('env-cancel-btn').disabled = false;
        
        // Refresh hardware detection
        detectHardware();
        updateGpuWarning();

        // Generate environment name
        const envName = generateEnvName(modelName);
        document.getElementById('env-name').value = envName;

        // Reset progress
        document.getElementById('env-progress-bar').style.width = '0%';
        document.getElementById('env-progress-bar').textContent = '0%';

        // Reset steps
        ['step-create-venv', 'step-install-deps', 'step-verify', 'step-associate'].forEach(id => {
            const step = document.getElementById(id);
            step.classList.remove('active', 'completed', 'failed');
        });

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('environmentSetupModal'));
        modal.show();
    }

    function generateEnvName(modelName) {
        // Convert model name to valid environment name
        // e.g., "CodeLlama 13B Instruct" -> "llm-codellama-13b-instruct"
        return 'llm-' + modelName
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '')
            .substring(0, 50);
    }

    async function createEnvironment() {
        const envName = document.getElementById('env-name').value;
        const backendSelect = document.getElementById('env-gpu-backend').value;

        // Disable buttons
        document.getElementById('env-create-btn').style.display = 'none';
        document.getElementById('env-cancel-btn').disabled = true;

        // Show progress section
        document.getElementById('env-progress-section').style.display = 'block';

        try {
            const response = await fetch(`/llm/api/models/${currentModelForEnv}/create-environment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    venv_name: envName,
                    gpu_backend: backendSelect
                })
            });

            const data = await response.json();

            if (data.success) {
                // Poll for progress
                pollEnvironmentProgress(data.task_id);
            } else {
                showError(data.error || 'Failed to start environment creation');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        }
    }

    async function pollEnvironmentProgress(taskId) {
        const stepIds = ['step-create-venv', 'step-install-deps', 'step-verify', 'step-associate'];
        
        const poll = async () => {
            try {
                const response = await fetch(`/tasks/${taskId}/status`);
                const task = await response.json();

                if (task.error && !task.steps) {
                    showError(task.error);
                    return;
                }

                // Update progress bar
                const progress = task.progress || 0;
                document.getElementById('env-progress-bar').style.width = progress + '%';
                document.getElementById('env-progress-bar').textContent = Math.round(progress) + '%';

                // Update steps based on task steps
                if (task.steps) {
                    task.steps.forEach((step, index) => {
                        if (index < stepIds.length) {
                            const stepEl = document.getElementById(stepIds[index]);
                            stepEl.classList.remove('active', 'completed', 'failed');
                            
                            // Update step text with actual message
                            const stepText = stepEl.querySelector('.step-text');
                            if (stepText && step.message) {
                                stepText.textContent = step.message;
                            }
                            
                            if (step.status === 'completed') {
                                stepEl.classList.add('completed');
                            } else if (step.status === 'running') {
                                stepEl.classList.add('active');
                            } else if (step.status === 'failed') {
                                stepEl.classList.add('failed');
                            }
                        }
                    });
                }

                // Check if complete
                if (task.status === 'completed') {
                    showSuccess();
                    return; // Stop polling
                } else if (task.status === 'failed') {
                    showError(task.error || 'Environment creation failed');
                    return; // Stop polling
                }

                // Continue polling
                setTimeout(poll, 1000);
            } catch (error) {
                console.error('Poll error:', error);
                setTimeout(poll, 2000); // Retry with longer delay
            }
        };

        poll();
    }

    function updateStepStatus(stepIndex, status) {
        const stepIds = ['step-create-venv', 'step-install-deps', 'step-verify', 'step-associate'];

        stepIds.forEach((id, index) => {
            const step = document.getElementById(id);
            step.classList.remove('active', 'completed', 'failed');

            if (index < stepIndex) {
                step.classList.add('completed');
            } else if (index === stepIndex) {
                if (status === 'running') {
                    step.classList.add('active');
                } else if (status === 'completed') {
                    step.classList.add('completed');
                } else if (status === 'failed') {
                    step.classList.add('failed');
                }
            }
        });
    }

    function showSuccess() {
        document.getElementById('env-progress-bar').classList.remove('progress-bar-animated');
        document.getElementById('env-progress-bar').classList.add('bg-success');
        document.getElementById('env-success-message').style.display = 'block';
        document.getElementById('env-done-btn').style.display = 'inline-block';

        // Refresh model list
        if (typeof refreshModelList === 'function') {
            refreshModelList();
        }
    }

    function showError(message) {
        document.getElementById('env-error-text').textContent = message;
        document.getElementById('env-error-message').style.display = 'block';
        document.getElementById('env-cancel-btn').disabled = false;
        document.getElementById('env-create-btn').style.display = 'inline-block';
        document.getElementById('env-create-btn').textContent = 'Retry';
    }
</script>