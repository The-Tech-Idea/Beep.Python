{% extends "base.html" %}

{% block title %}Start Server - Beep AI Server{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Start New Server</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('servers.index') }}">Servers</a></li>
            <li class="breadcrumb-item active">Start</li>
        </ol>
    </nav>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8 animate-fade-in">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-play-fill me-2"></i>Server Configuration</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('servers.start') }}" method="post" id="startServerForm">
                    <div class="mb-4">
                        <label class="form-label">Server Name *</label>
                        <input type="text" name="name" class="form-control form-control-lg" required
                               placeholder="my-python-server" id="serverName">
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            <span>Python Environment *</span>
                            <a href="{{ url_for('environments.create') }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-plus-circle me-1"></i>Create New Environment
                            </a>
                        </label>
                        
                        {% if python_sources %}
                        <select name="venv_path" class="form-select form-select-lg" required id="venvSelect">
                            <option value="">Select a Python source...</option>
                            <optgroup label="Virtual Environments">
                            {% for source in python_sources if source.type == 'environment' %}
                            <option value="{{ source.path }}">{{ source.name }} (Python {{ source.version }})</option>
                            {% endfor %}
                            </optgroup>
                            <optgroup label="System Runtimes">
                            {% for source in python_sources if source.type == 'runtime' %}
                            <option value="{{ source.path }}">{{ source.name }}</option>
                            {% endfor %}
                            </optgroup>
                        </select>
                        <div class="form-text">Select an environment or system runtime to use for the server</div>
                        
                        {% elif environments %}
                        <select name="venv_path" class="form-select form-select-lg" required id="venvSelect">
                            <option value="">Select an environment...</option>
                            {% for env in environments %}
                            <option value="{{ env.path }}">{{ env.name }} (Python {{ env.python_version }})</option>
                            {% endfor %}
                        </select>
                        
                        {% else %}
                        <!-- No environments - show creation options -->
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>No Python environments found.</strong> You need to create a virtual environment first.
                        </div>
                        
                        <div class="card bg-dark border-primary">
                            <div class="card-body">
                                <h6 class="card-title text-primary">
                                    <i class="bi bi-lightning-fill me-2"></i>Quick Create Environment
                                </h6>
                                <p class="card-text small text-muted mb-3">
                                    Create a new virtual environment directly from here
                                </p>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small">Environment Name</label>
                                        <input type="text" id="quickEnvName" class="form-control" 
                                               placeholder="my-server-env" value="server-env">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="button" class="btn btn-primary w-100" id="quickCreateBtn"
                                                onclick="quickCreateEnvironment()">
                                            <i class="bi bi-plus-circle me-2"></i>Create & Continue
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="quickCreateStatus" class="mt-3" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Creating...</span>
                                        </div>
                                        <span class="text-muted">Creating environment, please wait...</span>
                                    </div>
                                </div>
                                
                                <div id="quickCreateError" class="alert alert-danger mt-3" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <input type="hidden" name="venv_path" id="venvPathHidden">
                        
                        <hr class="my-4 border-secondary">
                        
                        <div class="text-center">
                            <p class="text-muted mb-3">Or go to the full environment creation page:</p>
                            <a href="{{ url_for('environments.create') }}" class="btn btn-outline-light">
                                <i class="bi bi-folder-plus me-2"></i>Go to Create Environment
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label">Backend Type</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="backend_type" 
                                           id="typeHttp" value="http" checked>
                                    <label class="form-check-label" for="typeHttp">
                                        <i class="bi bi-globe me-1"></i> HTTP
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="backend_type" 
                                           id="typeRpc" value="rpc">
                                    <label class="form-check-label" for="typeRpc">
                                        <i class="bi bi-braces me-1"></i> JSON-RPC
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <label class="form-label">Port (optional)</label>
                            <input type="number" name="port" class="form-control" 
                                   placeholder="Auto-assign" min="1024" max="65535">
                            <div class="form-text">Leave empty for auto-assignment</div>
                        </div>
                    </div>
                    
                    <div class="card bg-dark mb-4">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-info-circle me-2"></i>Server Endpoints</h6>
                            <p class="card-text small text-muted mb-2">Once started, your server will expose these endpoints:</p>
                            <ul class="list-unstyled small mb-0">
                                <li><code>GET /health</code> - Health check</li>
                                <li><code>GET /info</code> - Server information</li>
                                <li><code>POST /exec</code> - Execute Python code</li>
                                <li><code>POST /eval</code> - Evaluate expression</li>
                                <li><code>POST /import</code> - Import module</li>
                            </ul>
                        </div>
                    </div>
                    
                    <hr class="my-4 border-secondary">
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('servers.index') }}" class="btn btn-outline-light">
                            <i class="bi bi-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn"
                                {% if not python_sources and not environments %}disabled{% endif %}>
                            <i class="bi bi-play-fill me-2"></i>Start Server
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
async function quickCreateEnvironment() {
    const nameInput = document.getElementById('quickEnvName');
    const statusDiv = document.getElementById('quickCreateStatus');
    const errorDiv = document.getElementById('quickCreateError');
    const btn = document.getElementById('quickCreateBtn');
    
    const envName = nameInput.value.trim();
    if (!envName) {
        errorDiv.textContent = 'Please enter an environment name';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Show loading state
    btn.disabled = true;
    statusDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch('/api/environments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: envName,
                packages: []
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Success - reload page to show the new environment
            window.location.href = '{{ url_for("servers.start") }}?env_created=' + envName;
        } else {
            throw new Error(result.error || 'Failed to create environment');
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
        btn.disabled = false;
        statusDiv.style.display = 'none';
    }
}

// Check if we just created an environment
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('env_created')) {
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show mb-4';
    alert.innerHTML = `
        <i class="bi bi-check-circle me-2"></i>
        Environment "${urlParams.get('env_created')}" created successfully! Select it below.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.card-body').prepend(alert);
}
</script>
{% endblock %}
