{% extends "base.html" %}

{% block title %}Job Scheduler{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="bi bi-calendar-event me-2"></i>Job Scheduler</h1>
        <p class="text-muted mb-0">Schedule tasks for LLM, RAG, Document Extraction, and other modules</p>
    </div>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createJobModal">
            <i class="bi bi-plus-circle me-2"></i>Create Job
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Environment Status -->
    <div class="col-lg-4 mb-4">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Environment Status</h5>
            </div>
            <div class="card-body">
                <div id="env-status-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Checking environment...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Panel -->
    <div class="col-lg-8 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Environment Setup</h5>
            </div>
            <div class="card-body">
                <div id="setup-content">
                    <p class="text-muted mb-4">
                        A dedicated virtual environment isolates scheduler libraries (APScheduler, requests, etc.) 
                        from the main application to avoid dependency conflicts.
                    </p>
                    
                    <div id="env-not-created" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Environment not created</strong>
                            <p class="mb-0 mt-2">Create a virtual environment to install scheduler libraries.</p>
                        </div>
                        <button class="btn btn-primary" id="btn-create-env">
                            <i class="bi bi-plus-circle me-2"></i>Create Environment
                        </button>
                    </div>
                    
                    <div id="env-ready" style="display: none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Environment Ready</strong>
                            <p class="mb-0 mt-2">Virtual environment is created and ready for package installation.</p>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Install Packages</h6>
                        <div id="packages-list" class="mb-3">
                            <!-- Packages will be loaded here -->
                        </div>
                        
                        <button class="btn btn-success" id="btn-install-all">
                            <i class="bi bi-download me-2"></i>Install All Required Packages
                        </button>
                        <button class="btn btn-outline-info ms-2" onclick="loadStatus()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Status
                        </button>
                    </div>
                    
                    <div id="env-error" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            <strong>Error</strong>
                            <p class="mb-0 mt-2" id="error-message"></p>
                        </div>
                        <button class="btn btn-warning" id="btn-retry">
                            <i class="bi bi-arrow-clockwise me-2"></i>Retry
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Jobs List -->
<div class="row mt-4">
    <div class="col-12 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>Scheduled Jobs</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadJobs()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="jobs-container">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading jobs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Job Modal -->
<div class="modal fade" id="createJobModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="jobModalTitle">Create Scheduled Job</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="job-form">
                    <input type="hidden" id="job-id" value="">
                    
                    <div class="mb-3">
                        <label for="job-name" class="form-label">Job Name *</label>
                        <input type="text" class="form-control" id="job-name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="job-description" class="form-label">Description</label>
                        <textarea class="form-control" id="job-description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="job-module" class="form-label">Module *</label>
                            <select class="form-select" id="job-module" required>
                                <option value="">Select Module...</option>
                                <option value="llm">LLM Management</option>
                                <option value="rag">RAG</option>
                                <option value="document_extraction">Document Extraction</option>
                                <option value="ml_models">ML Models</option>
                                <option value="system">System</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="job-type" class="form-label">Job Type *</label>
                            <select class="form-select" id="job-type" required>
                                <option value="">Select Job Type...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Execution Method</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="exec-method" id="exec-function" value="function" checked>
                            <label class="btn btn-outline-primary" for="exec-function">Python Function</label>
                            
                            <input type="radio" class="btn-check" name="exec-method" id="exec-api" value="api">
                            <label class="btn btn-outline-primary" for="exec-api">API Endpoint</label>
                            
                            <input type="radio" class="btn-check" name="exec-method" id="exec-script" value="script">
                            <label class="btn btn-outline-primary" for="exec-script">Script File</label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="function-name-group">
                        <label for="function-name" class="form-label">Function Name</label>
                        <input type="text" class="form-control" id="function-name" placeholder="module.function_name">
                        <small class="text-muted">e.g., app.services.llm_manager.process_batch</small>
                    </div>
                    
                    <div class="mb-3" id="api-endpoint-group" style="display: none;">
                        <label for="api-endpoint" class="form-label">API Endpoint</label>
                        <input type="text" class="form-control" id="api-endpoint" placeholder="/api/v1/endpoint">
                    </div>
                    
                    <div class="mb-3" id="script-path-group" style="display: none;">
                        <label for="script-path" class="form-label">Script Path</label>
                        <input type="text" class="form-control" id="script-path" placeholder="/path/to/script.py">
                    </div>
                    
                    <div class="mb-3">
                        <label for="job-parameters" class="form-label">Parameters (JSON)</label>
                        <textarea class="form-control font-monospace" id="job-parameters" rows="4" placeholder='{"key": "value"}'></textarea>
                        <small class="text-muted">JSON object with parameters to pass to the function/API</small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h6 class="mb-3">Schedule Configuration</h6>
                    
                    <div class="mb-3">
                        <label for="schedule-type" class="form-label">Schedule Type *</label>
                        <select class="form-select" id="schedule-type" required>
                            <option value="manual">Manual (Run on demand)</option>
                            <option value="once">Run Once</option>
                            <option value="interval">Interval</option>
                            <option value="cron">Cron Expression</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="schedule-once-group" style="display: none;">
                        <label for="run-date" class="form-label">Run Date & Time</label>
                        <input type="datetime-local" class="form-control" id="run-date">
                    </div>
                    
                    <div class="mb-3" id="schedule-interval-group" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="interval-value" class="form-label">Interval Value</label>
                                <input type="number" class="form-control" id="interval-value" min="1" value="1">
                            </div>
                            <div class="col-md-6">
                                <label for="interval-unit" class="form-label">Unit</label>
                                <select class="form-select" id="interval-unit">
                                    <option value="seconds">Seconds</option>
                                    <option value="minutes" selected>Minutes</option>
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="schedule-cron-group" style="display: none;">
                        <label for="cron-expression" class="form-label">Cron Expression</label>
                        <input type="text" class="form-control font-monospace" id="cron-expression" placeholder="0 * * * *">
                        <small class="text-muted">Format: minute hour day month day_of_week (e.g., "0 9 * * *" = daily at 9 AM)</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="job-active" checked>
                        <label class="form-check-label" for="job-active">
                            Active (Job will be scheduled automatically)
                        </label>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h6 class="mb-3">Retry & Failover Configuration</h6>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="retry-enabled">
                        <label class="form-check-label" for="retry-enabled">
                            Enable Retry on Failure
                        </label>
                    </div>
                    
                    <div id="retry-config" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="max-retries" class="form-label">Max Retries</label>
                                <input type="number" class="form-control" id="max-retries" min="1" max="10" value="3">
                            </div>
                            <div class="col-md-6">
                                <label for="retry-delay" class="form-label">Retry Delay (seconds)</label>
                                <input type="number" class="form-control" id="retry-delay" min="1" value="60">
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="retry-backoff" checked>
                            <label class="form-check-label" for="retry-backoff">
                                Exponential Backoff (doubles delay each retry)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="failover-enabled">
                        <label class="form-check-label" for="failover-enabled">
                            Enable Failover (use alternative endpoint on failure)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-job-btn">Save Job</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentJobId = null;
let modulesData = {};

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStatus();
    loadModules();
    loadJobs();
    
    // Setup form handlers
    setupFormHandlers();
    
    // Setup environment buttons
    document.getElementById('btn-create-env')?.addEventListener('click', createEnvironment);
    document.getElementById('btn-install-all')?.addEventListener('click', installAllPackages);
    document.getElementById('btn-retry')?.addEventListener('click', loadStatus);
});

function setupFormHandlers() {
    // Module change - update job types
    document.getElementById('job-module').addEventListener('change', function() {
        updateJobTypes(this.value);
    });
    
    // Execution method change
    document.querySelectorAll('input[name="exec-method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateExecutionMethod(this.value);
        });
    });
    
    // Schedule type change
    document.getElementById('schedule-type').addEventListener('change', function() {
        updateScheduleType(this.value);
    });
    
    // Save job button
    document.getElementById('save-job-btn').addEventListener('click', saveJob);
    
    // Retry enabled toggle
    document.getElementById('retry-enabled').addEventListener('change', function() {
        document.getElementById('retry-config').style.display = this.checked ? 'block' : 'none';
    });
}

function updateExecutionMethod(method) {
    document.getElementById('function-name-group').style.display = method === 'function' ? 'block' : 'none';
    document.getElementById('api-endpoint-group').style.display = method === 'api' ? 'block' : 'none';
    document.getElementById('script-path-group').style.display = method === 'script' ? 'block' : 'none';
}

function updateScheduleType(type) {
    document.getElementById('schedule-once-group').style.display = type === 'once' ? 'block' : 'none';
    document.getElementById('schedule-interval-group').style.display = type === 'interval' ? 'block' : 'none';
    document.getElementById('schedule-cron-group').style.display = type === 'cron' ? 'block' : 'none';
}

function updateJobTypes(module) {
    const jobTypeSelect = document.getElementById('job-type');
    jobTypeSelect.innerHTML = '<option value="">Select Job Type...</option>';
    
    if (modulesData[module]) {
        modulesData[module].job_types.forEach(jt => {
            const option = document.createElement('option');
            option.value = jt.value;
            option.textContent = jt.label;
            jobTypeSelect.appendChild(option);
        });
    }
}

function loadModules() {
    fetch('/job-scheduler/api/modules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                modulesData = data.modules;
            }
        })
        .catch(error => console.error('Failed to load modules:', error));
}

function loadStatus() {
    fetch('/job-scheduler/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const status = data.status;
                const env = data.environment;
                
                // Update environment status
                updateEnvironmentStatus(env);
                
                // Update scheduler status
                const statusContent = document.getElementById('scheduler-status-content') || document.getElementById('env-status-content');
                if (statusContent) {
                    if (status.available && status.running) {
                        statusContent.innerHTML = `
                            <div class="text-center">
                                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-success">Scheduler Running</h5>
                                <p class="text-muted small">Active Jobs: ${status.job_count}</p>
                            </div>
                        `;
                    } else {
                        statusContent.innerHTML = `
                            <div class="text-center">
                                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-warning">Scheduler Not Available</h5>
                                <p class="text-muted small">Setup environment and install APScheduler</p>
                            </div>
                        `;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Failed to load status:', error);
        });
}

function updateEnvironmentStatus(env) {
    const notCreated = document.getElementById('env-not-created');
    const ready = document.getElementById('env-ready');
    const error = document.getElementById('env-error');
    
    if (env.status === 'not_created') {
        if (notCreated) notCreated.style.display = 'block';
        if (ready) ready.style.display = 'none';
        if (error) error.style.display = 'none';
    } else if (env.status === 'ready') {
        if (notCreated) notCreated.style.display = 'none';
        if (ready) ready.style.display = 'block';
        if (error) error.style.display = 'none';
        
        // Update packages list
        updatePackagesList(env.packages);
    } else if (env.status === 'error') {
        if (notCreated) notCreated.style.display = 'none';
        if (ready) ready.style.display = 'none';
        if (error) error.style.display = 'block';
        const errorMsg = document.getElementById('error-message');
        if (errorMsg) errorMsg.textContent = 'Environment creation failed';
    }
}

function updatePackagesList(packages) {
    const packagesList = document.getElementById('packages-list');
    if (!packagesList) return;
    
    packagesList.innerHTML = Object.entries(packages).map(([key, pkg]) => {
        const checked = pkg.installed ? 'checked' : '';
        const badge = pkg.installed 
            ? '<span class="badge bg-success ms-2">Installed</span>'
            : '<span class="badge bg-secondary ms-2">Not Installed</span>';
        
        return `
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="${key}" id="pkg-${key}" ${checked} ${pkg.required ? 'disabled' : ''}>
                <label class="form-check-label" for="pkg-${key}">
                    <strong>${pkg.name}</strong> ${badge}
                    ${pkg.required ? '<span class="badge bg-primary ms-1">Required</span>' : ''}
                    <br>
                    <small class="text-muted">${pkg.description}</small>
                </label>
            </div>
        `;
    }).join('');
}

function createEnvironment() {
    if (!confirm('Create scheduler environment? This may take a few minutes.')) return;
    
    fetch('/job-scheduler/api/create-env', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Environment creation started. Please wait...');
            startStatusPolling(data.task_id);
        } else {
            alert('Failed to start environment creation: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function installAllPackages() {
    if (!confirm('Install all required packages? This may take several minutes.')) return;
    
    fetch('/job-scheduler/api/install-packages', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Package installation started. Please wait...');
            startStatusPolling(data.task_id);
        } else {
            alert('Failed to start installation: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function startStatusPolling(taskId) {
    let attempts = 0;
    const maxAttempts = 300; // 5 minutes max
    
    const poll = () => {
        attempts++;
        if (attempts > maxAttempts) {
            alert('Task is taking longer than expected. Please check manually.');
            loadStatus();
            return;
        }
        
        fetch(`/tasks/${taskId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    loadStatus();
                    setTimeout(() => loadStatus(), 1000);
                    setTimeout(() => loadStatus(), 3000);
                    setTimeout(() => loadStatus(), 5000);
                } else if (data.status === 'failed') {
                    alert('Task failed: ' + (data.error || 'Unknown error'));
                    loadStatus();
                } else {
                    setTimeout(poll, 2000);
                }
            })
            .catch(error => {
                console.error('Task polling error:', error);
                setTimeout(poll, 2000);
            });
    };
    
    poll();
}

function loadJobs() {
    fetch('/job-scheduler/api/jobs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderJobs(data.jobs);
            }
        })
        .catch(error => {
            console.error('Failed to load jobs:', error);
            document.getElementById('jobs-container').innerHTML = 
                '<div class="alert alert-danger">Failed to load jobs</div>';
        });
}

function renderJobs(jobs) {
    const container = document.getElementById('jobs-container');
    
    if (jobs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-calendar-x display-4 text-muted mb-3"></i>
                <h5>No Scheduled Jobs</h5>
                <p class="text-muted">Create your first scheduled job to get started</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createJobModal">
                    <i class="bi bi-plus-circle me-2"></i>Create Job
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = jobs.map(job => {
        const statusBadge = job.is_active 
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-secondary">Inactive</span>';
        
        const lastStatusBadge = job.last_status === 'success'
            ? '<span class="badge bg-success">Success</span>'
            : job.last_status === 'failed'
            ? '<span class="badge bg-danger">Failed</span>'
            : job.last_status === 'running'
            ? '<span class="badge bg-info">Running</span>'
            : '<span class="badge bg-secondary">Pending</span>';
        
        const nextRun = job.next_run_at 
            ? new Date(job.next_run_at).toLocaleString()
            : 'Not scheduled';
        
        return `
            <div class="card bg-secondary mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">
                            <i class="bi bi-calendar-event me-2"></i>
                            ${escapeHtml(job.name)}
                        </h6>
                        <small class="text-muted">${escapeHtml(job.module)} / ${escapeHtml(job.job_type)}</small>
                    </div>
                    <div>
                        ${statusBadge}
                        ${lastStatusBadge}
                    </div>
                </div>
                <div class="card-body">
                    ${job.description ? `<p class="text-muted small">${escapeHtml(job.description)}</p>` : ''}
                    <div class="row small text-muted">
                        <div class="col-md-6">
                            <strong>Schedule:</strong> ${job.schedule_type}<br>
                            <strong>Next Run:</strong> ${nextRun}<br>
                            <strong>Runs:</strong> ${job.run_count} (${job.success_count} success, ${job.failure_count} failed)
                        </div>
                        <div class="col-md-6">
                            ${job.last_run_at ? `<strong>Last Run:</strong> ${new Date(job.last_run_at).toLocaleString()}<br>` : ''}
                            ${job.last_error ? `<span class="text-danger"><strong>Last Error:</strong> ${escapeHtml(job.last_error.substring(0, 100))}</span>` : ''}
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="editJob(${job.id})">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                        ${job.is_running 
                            ? `<button class="btn btn-sm btn-outline-warning" onclick="stopJob(${job.id})">
                                <i class="bi bi-stop me-1"></i>Stop
                               </button>`
                            : `<button class="btn btn-sm btn-outline-success" onclick="runJob(${job.id})">
                                <i class="bi bi-play me-1"></i>Run Now
                               </button>`
                        }
                        <button class="btn btn-sm btn-outline-info" onclick="viewJobStatus(${job.id})">
                            <i class="bi bi-info-circle me-1"></i>Status
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewExecutions(${job.id})">
                            <i class="bi bi-clock-history me-1"></i>History
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteJob(${job.id})">
                            <i class="bi bi-trash me-1"></i>Delete
                        </button>
                    </div>
                    ${job.retry_enabled ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-arrow-repeat me-1"></i>
                                Retry: ${job.retry_count}/${job.max_retries} attempts
                            </small>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function editJob(jobId) {
    fetch(`/job-scheduler/api/jobs/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const job = data.job;
                currentJobId = jobId;
                
                document.getElementById('jobModalTitle').textContent = 'Edit Scheduled Job';
                document.getElementById('job-id').value = job.id;
                document.getElementById('job-name').value = job.name;
                document.getElementById('job-description').value = job.description || '';
                document.getElementById('job-module').value = job.module;
                updateJobTypes(job.module);
                setTimeout(() => {
                    document.getElementById('job-type').value = job.job_type;
                }, 100);
                
                // Set execution method
                if (job.function_name) {
                    document.getElementById('exec-function').checked = true;
                    updateExecutionMethod('function');
                    document.getElementById('function-name').value = job.function_name;
                } else if (job.api_endpoint) {
                    document.getElementById('exec-api').checked = true;
                    updateExecutionMethod('api');
                    document.getElementById('api-endpoint').value = job.api_endpoint;
                } else if (job.script_path) {
                    document.getElementById('exec-script').checked = true;
                    updateExecutionMethod('script');
                    document.getElementById('script-path').value = job.script_path;
                }
                
                document.getElementById('job-parameters').value = JSON.stringify(job.parameters || {}, null, 2);
                document.getElementById('schedule-type').value = job.schedule_type;
                updateScheduleType(job.schedule_type);
                
                const scheduleConfig = job.schedule_config || {};
                if (job.schedule_type === 'once' && scheduleConfig.run_date) {
                    const runDate = new Date(scheduleConfig.run_date);
                    document.getElementById('run-date').value = runDate.toISOString().slice(0, 16);
                } else if (job.schedule_type === 'interval') {
                    const seconds = scheduleConfig.interval_seconds || 3600;
                    if (seconds >= 86400) {
                        document.getElementById('interval-value').value = seconds / 86400;
                        document.getElementById('interval-unit').value = 'days';
                    } else if (seconds >= 3600) {
                        document.getElementById('interval-value').value = seconds / 3600;
                        document.getElementById('interval-unit').value = 'hours';
                    } else if (seconds >= 60) {
                        document.getElementById('interval-value').value = seconds / 60;
                        document.getElementById('interval-unit').value = 'minutes';
                    } else {
                        document.getElementById('interval-value').value = seconds;
                        document.getElementById('interval-unit').value = 'seconds';
                    }
                } else if (job.schedule_type === 'cron') {
                    document.getElementById('cron-expression').value = scheduleConfig.cron_expression || '';
                }
                
                document.getElementById('job-active').checked = job.is_active;
                if (document.getElementById('retry-enabled')) {
                    document.getElementById('retry-enabled').checked = job.retry_enabled || false;
                    document.getElementById('retry-config').style.display = job.retry_enabled ? 'block' : 'none';
                    document.getElementById('max-retries').value = job.max_retries || 3;
                    document.getElementById('retry-delay').value = job.retry_delay_seconds || 60;
                    document.getElementById('retry-backoff').checked = job.retry_backoff !== false;
                    document.getElementById('failover-enabled').checked = job.failover_enabled || false;
                }
                
                new bootstrap.Modal(document.getElementById('createJobModal')).show();
            }
        })
        .catch(error => {
            alert('Failed to load job: ' + error.message);
        });
}

function saveJob() {
    const form = document.getElementById('job-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const execMethod = document.querySelector('input[name="exec-method"]:checked').value;
    
    const jobData = {
        name: document.getElementById('job-name').value,
        description: document.getElementById('job-description').value,
        module: document.getElementById('job-module').value,
        job_type: document.getElementById('job-type').value,
        schedule_type: document.getElementById('schedule-type').value,
        is_active: document.getElementById('job-active').checked
    };
    
    // Set execution method
    if (execMethod === 'function') {
        jobData.function_name = document.getElementById('function-name').value;
    } else if (execMethod === 'api') {
        jobData.api_endpoint = document.getElementById('api-endpoint').value;
    } else if (execMethod === 'script') {
        jobData.script_path = document.getElementById('script-path').value;
    }
    
    // Parse parameters
    try {
        const paramsText = document.getElementById('job-parameters').value.trim();
        jobData.parameters = paramsText ? JSON.parse(paramsText) : {};
    } catch (e) {
        alert('Invalid JSON in parameters field: ' + e.message);
        return;
    }
    
    // Build schedule config
    jobData.schedule_config = {};
    if (jobData.schedule_type === 'once') {
        const runDate = document.getElementById('run-date').value;
        if (runDate) {
            jobData.schedule_config.run_date = new Date(runDate).toISOString();
        }
    } else if (jobData.schedule_type === 'interval') {
        const value = parseInt(document.getElementById('interval-value').value);
        const unit = document.getElementById('interval-unit').value;
        const multipliers = {seconds: 1, minutes: 60, hours: 3600, days: 86400};
        jobData.schedule_config.interval_seconds = value * multipliers[unit];
    } else if (jobData.schedule_type === 'cron') {
        jobData.schedule_config.cron_expression = document.getElementById('cron-expression').value;
    }
    
    // Add retry configuration
    if (document.getElementById('retry-enabled')) {
        jobData.retry_enabled = document.getElementById('retry-enabled').checked;
        jobData.max_retries = parseInt(document.getElementById('max-retries').value) || 3;
        jobData.retry_delay_seconds = parseInt(document.getElementById('retry-delay').value) || 60;
        jobData.retry_backoff = document.getElementById('retry-backoff').checked;
        jobData.failover_enabled = document.getElementById('failover-enabled').checked;
    }
    
    const jobId = document.getElementById('job-id').value;
    const url = jobId ? `/job-scheduler/api/jobs/${jobId}` : '/job-scheduler/api/jobs';
    const method = jobId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(jobData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createJobModal')).hide();
            loadJobs();
            loadStatus();
        } else {
            alert('Failed to save job: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function runJob(jobId) {
    if (!confirm('Run this job now?')) return;
    
    fetch(`/job-scheduler/api/jobs/${jobId}/run`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const msg = data.execution_id 
                ? `Job execution started (Execution ID: ${data.execution_id})`
                : 'Job execution started';
            alert(msg);
            setTimeout(() => loadJobs(), 1000);
            // Poll for status updates
            if (data.execution_id) {
                pollJobStatus(jobId, data.execution_id);
            }
        } else {
            alert('Failed to run job: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function stopJob(jobId) {
    if (!confirm('Stop this running job?')) return;
    
    fetch(`/job-scheduler/api/jobs/${jobId}/stop`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Job stop requested');
            setTimeout(() => loadJobs(), 1000);
        } else {
            alert('Failed to stop job: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function viewJobStatus(jobId) {
    fetch(`/job-scheduler/api/jobs/${jobId}/status`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let statusHtml = `
                    <h6>Job Execution Status</h6>
                    <p><strong>Running:</strong> ${data.is_running ? 'Yes' : 'No'}</p>
                    <p><strong>Last Status:</strong> ${data.last_status || 'N/A'}</p>
                `;
                
                if (data.retry_count > 0) {
                    statusHtml += `<p><strong>Retry Attempt:</strong> ${data.retry_count}/${data.max_retries}</p>`;
                }
                
                if (data.execution) {
                    statusHtml += `
                        <hr>
                        <h6>Current Execution</h6>
                        <p><strong>Started:</strong> ${new Date(data.execution.started_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${data.execution.status}</p>
                    `;
                    if (data.execution.error_message) {
                        statusHtml += `<p class="text-danger"><strong>Error:</strong> ${escapeHtml(data.execution.error_message)}</p>`;
                    }
                    if (data.execution.completed_at) {
                        statusHtml += `<p><strong>Completed:</strong> ${new Date(data.execution.completed_at).toLocaleString()}</p>`;
                        if (data.execution.duration_seconds) {
                            statusHtml += `<p><strong>Duration:</strong> ${data.execution.duration_seconds.toFixed(2)}s</p>`;
                        }
                    }
                }
                
                alert(statusHtml.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n'));
            } else {
                alert('Failed to get job status: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function pollJobStatus(jobId, executionId) {
    let attempts = 0;
    const maxAttempts = 60; // 1 minute
    
    const poll = () => {
        attempts++;
        if (attempts > maxAttempts) return;
        
        fetch(`/job-scheduler/api/jobs/${jobId}/status?execution_id=${executionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.execution) {
                    const status = data.execution.status;
                    if (status === 'success' || status === 'failed' || status === 'cancelled') {
                        loadJobs(); // Refresh job list
                    } else if (status === 'running') {
                        setTimeout(poll, 2000); // Poll every 2 seconds
                    }
                }
            })
            .catch(() => {
                // Ignore polling errors
            });
    };
    
    setTimeout(poll, 2000);
}

function deleteJob(jobId) {
    if (!confirm('Delete this job? This cannot be undone.')) return;
    
    fetch(`/job-scheduler/api/jobs/${jobId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadJobs();
            loadSchedulerStatus();
        } else {
            alert('Failed to delete job: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function viewExecutions(jobId) {
    // TODO: Implement execution history modal
    alert('Execution history feature coming soon');
}

// Reset form when modal is closed
document.getElementById('createJobModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('job-form').reset();
    document.getElementById('job-id').value = '';
    document.getElementById('jobModalTitle').textContent = 'Create Scheduled Job';
    currentJobId = null;
    updateExecutionMethod('function');
    updateScheduleType('manual');
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
