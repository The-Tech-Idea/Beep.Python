{% extends "base.html" %}

{% block title %}RAG Management{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-database-fill-gear me-2"></i>RAG Management</h2>
            <p class="text-muted mb-0">Manage RAG virtual environment and databases</p>
        </div>
        <div>
            <a href="{{ url_for('rag.rag_wizard') }}" class="btn btn-outline-primary">
                <i class="bi bi-magic me-2"></i>Setup Wizard
            </a>
        </div>
    </div>

    <!-- RAG Environment Status -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header border-secondary">
            <h5 class="mb-0"><i class="bi bi-hdd-stack me-2"></i>RAG Environment</h5>
        </div>
        <div class="card-body">
            {% if not env_status.installed %}
            <!-- Not Installed -->
            <div class="text-center py-4">
                <i class="bi bi-exclamation-circle display-1 text-warning mb-3"></i>
                <h4>RAG Environment Not Installed</h4>
                <p class="text-muted">Use the Setup Wizard to create a virtual environment and install RAG packages</p>
                <a href="{{ url_for('rag.rag_wizard') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-magic me-2"></i>Start Setup Wizard
                </a>
            </div>
            {% else %}
            <!-- Installed -->
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <i class="bi bi-check-circle display-4 text-success"></i>
                        <h5 class="mt-2">Installed</h5>
                        <p class="text-muted small mb-0">RAG venv ready</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <i class="bi bi-database display-4 text-primary"></i>
                        <h5 class="mt-2">{{ env_status.database_count or 0 }}</h5>
                        <p class="text-muted small mb-0">Databases</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <i class="bi bi-box-seam display-4 text-info"></i>
                        <h5 class="mt-2">{{ env_status.packages|selectattr('installed')|list|length }}</h5>
                        <p class="text-muted small mb-0">Packages Installed</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Active Database Selector -->
    <div class="card bg-dark border-primary mb-4" id="database-selector" style="display: none;">
        <div class="card-header border-primary">
            <h5 class="mb-0"><i class="bi bi-database me-2"></i>Active Database</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label class="form-label">Select Active Database:</label>
                    <select class="form-select bg-dark text-light border-secondary" id="active-database-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div id="active-db-info" class="mt-3 mt-md-0">
                        <p class="mb-1"><strong>Provider:</strong> <span id="db-provider">-</span></p>
                        <p class="mb-0"><strong>Documents:</strong> <span id="db-doc-count">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Providers (in RAG venv) -->
    <div class="card bg-dark border-success mb-4" id="providers-card" style="display: none;">
        <div class="card-header border-success">
            <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Installed Providers</h5>
        </div>
        <div class="card-body">
            <div class="row" id="providers-container">
                <!-- Providers will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Databases List -->
    <div class="card bg-dark border-info mb-4" id="databases-card" style="display: none;">
        <div class="card-header border-info d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Databases</h5>
            <button class="btn btn-sm btn-outline-success" onclick="createDatabase()">
                <i class="bi bi-plus-circle me-1"></i>Create New
            </button>
        </div>
        <div class="card-body">
            <div id="databases-container">
                <!-- Databases will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card bg-dark mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <a href="{{ url_for('rag.rag_manage_collections') }}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="bi bi-collection me-1"></i>Manage Collections
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('rag.rag_test') }}" class="btn btn-outline-success w-100 mb-2">
                        <i class="bi bi-search me-1"></i>Test Query
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('rag.rag_pipeline') }}" class="btn btn-outline-info w-100 mb-2">
                        <i class="bi bi-diagram-3 me-1"></i>Pipeline APIs
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('rag.rag_configure') }}" class="btn btn-outline-secondary w-100 mb-2">
                        <i class="bi bi-gear me-1"></i>Configure
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Integration -->
    <div class="card bg-dark">
        <div class="card-header border-warning">
            <h5 class="mb-0"><i class="bi bi-database-gear me-2 text-warning"></i>Data Integration</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-secondary h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-database-add display-4 text-info mb-3"></i>
                            <h5>Data Sources</h5>
                            <p class="text-muted small">Connect to databases, REST APIs, and file systems to populate your RAG collections.</p>
                            <a href="{{ url_for('rag.data_sources_page') }}" class="btn btn-info">
                                <i class="bi bi-plug me-1"></i>Manage Data Sources
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-secondary h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-clock-history display-4 text-warning mb-3"></i>
                            <h5>Sync Scheduler</h5>
                            <p class="text-muted small">Schedule automatic document refresh from your data sources on interval or cron schedule.</p>
                            <a href="{{ url_for('rag.sync_jobs_page') }}" class="btn btn-warning">
                                <i class="bi bi-calendar-check me-1"></i>Manage Sync Jobs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Setup Progress Modal -->
<div class="modal fade" id="setupModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Setting Up RAG Environment</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="setup-progress"
                        style="width: 0%">0%</div>
                </div>
                <p id="setup-status" class="text-muted mb-0">Initializing...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let envStatus = null;

    // Load environment status on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadEnvironmentStatus();
    });

    async function loadEnvironmentStatus() {
        try {
            const response = await fetch('/rag/api/env/status');
            envStatus = await response.json();
            renderEnvironmentStatus();

            if (envStatus.installed) {
                loadDatabases();
                loadProviders();
            }
        } catch (error) {
            console.error('Error loading environment status:', error);
            document.getElementById('env-status-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Failed to load environment status
            </div>
        `;
        }
    }

    function renderEnvironmentStatus() {
        const container = document.getElementById('env-status-container');

        if (!envStatus.installed) {
            // Not installed - show setup button
            container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-exclamation-circle display-1 text-warning mb-3"></i>
                <h4>RAG Environment Not Installed</h4>
                <p class="text-muted">Click below to create a virtual environment and install RAG packages</p>
                <button class="btn btn-primary btn-lg" onclick="setupEnvironment()">
                    <i class="bi bi-download me-2"></i>Setup RAG Environment
                </button>
            </div>
        `;
        } else {
            // Installed - show status
            container.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <i class="bi bi-check-circle display-4 text-success"></i>
                        <h5 class="mt-2">Installed</h5>
                        <p class="text-muted small mb-0">RAG venv ready</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <i class="bi bi-database display-4 text-primary"></i>
                        <h5 class="mt-2">${envStatus.database_count || 0}</h5>
                        <p class="text-muted small mb-0">Databases</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <i class="bi bi-box-seam display-4 text-info"></i>
                        <h5 class="mt-2">${envStatus.packages?.filter(p => p.installed).length || 0}</h5>
                        <p class="text-muted small mb-0">Packages Installed</p>
                    </div>
                </div>
            </div>
        `;

            // Show other sections
            document.getElementById('database-selector').style.display = 'block';
            document.getElementById('providers-card').style.display = 'block';
            document.getElementById('databases-card').style.display = 'block';
        }
    }

    async function setupEnvironment() {
        const modal = new bootstrap.Modal(document.getElementById('setupModal'));
        modal.show();

        const progressBar = document.getElementById('setup-progress');
        const statusText = document.getElementById('setup-status');

        try {
            statusText.textContent = 'Creating virtual environment...';
            progressBar.style.width = '25%';
            progressBar.textContent = '25%';

            const response = await fetch('/rag/api/env/setup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (result.success) {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                statusText.textContent = 'Setup complete!';

                setTimeout(() => {
                    modal.hide();
                    location.reload();
                }, 1500);
            } else {
                throw new Error(result.error || 'Setup failed');
            }
        } catch (error) {
            progressBar.classList.add('bg-danger');
            statusText.textContent = 'Error: ' + error.message;
        }
    }

    async function loadDatabases() {
        try {
            const response = await fetch('/rag/api/databases');
            const data = await response.json();

            if (data.success) {
                renderDatabases(data.databases, data.active);
            }
        } catch (error) {
            console.error('Error loading databases:', error);
        }
    }

    function renderDatabases(databases, activeDb) {
        const select = document.getElementById('active-database-select');
        const container = document.getElementById('databases-container');

        // Update selector
        select.innerHTML = databases.map(db => `
        <option value="${db.name}" ${db.name === activeDb ? 'selected' : ''}>
            ${db.name} (${db.provider.toUpperCase()})
        </option>
    `).join('');

        // Update active DB info
        const active = databases.find(db => db.name === activeDb);
        if (active) {
            document.getElementById('db-provider').textContent = active.provider.toUpperCase();
            document.getElementById('db-doc-count').textContent = active.document_count || 0;
        }

        // Render database cards
        if (databases.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No databases created yet</p>';
        } else {
            container.innerHTML = databases.map(db => `
            <div class="card bg-secondary mb-2 ${db.is_active ? 'border-success' : ''}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                ${db.is_active ? '<i class="bi bi-check-circle text-success me-2"></i>' : ''}
                                ${db.name}
                            </h6>
                            <small class="text-muted">
                                Provider: ${db.provider.toUpperCase()} | 
                                Documents: ${db.document_count || 0}
                            </small>
                        </div>
                        ${!db.is_active ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="switchDatabase('${db.name}')">
                                Switch
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        }

        // Handle selector change
        select.onchange = function () {
            switchDatabase(this.value);
        };
    }

    async function switchDatabase(dbName) {
        try {
            const response = await fetch('/rag/api/database/switch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ database: dbName })
            });

            const result = await response.json();

            if (result.success) {
                location.reload();
            } else {
                alert('Failed to switch database: ' + result.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function loadProviders() {
        if (!envStatus || !envStatus.packages) return;

        const container = document.getElementById('providers-container');

        container.innerHTML = envStatus.packages.map(pkg => `
        <div class="col-md-3 mb-3">
            <div class="card bg-secondary h-100">
                <div class="card-body text-center">
                    <i class="bi bi-box-seam fs-1 ${pkg.installed ? 'text-success' : 'text-muted'} mb-2"></i>
                    <h6>${pkg.display}</h6>
                    ${pkg.installed ? `
                        <span class="badge bg-success">Installed</span>
                        <p class="text-muted small mb-0 mt-1">v${pkg.version}</p>
                    ` : `
                        <span class="badge bg-secondary">Not Installed</span>
                    `}
                </div>
            </div>
        </div>
    `).join('');
    }

    function createDatabase() {
        const name = prompt('Enter database name:');
        if (!name) return;

        const provider = prompt('Enter provider (faiss or chromadb):');
        if (!provider || !['faiss', 'chromadb'].includes(provider.toLowerCase())) {
            alert('Invalid provider. Use "faiss" or "chromadb"');
            return;
        }

        // TODO: Implement database creation API
        alert('Database creation will be implemented in the next update');
    }
</script>
{% endblock %}