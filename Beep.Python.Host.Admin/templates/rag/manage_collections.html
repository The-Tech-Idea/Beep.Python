{% extends "base.html" %}

{% block title %}Collections & Documents{% endblock %}

{% block extra_css %}
<style>
    /* Drag and Drop Zone Styles */
    #drop-zone {
        border-style: dashed !important;
        transition: all 0.3s ease;
    }
    
    #drop-zone:hover {
        border-color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    #drop-zone.drag-over {
        border-color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.1);
        transform: scale(1.02);
    }
    
    #file-items .list-group-item {
        transition: all 0.2s ease;
    }
    
    #file-items .list-group-item:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="fas fa-folder-open me-2"></i>Collections & Documents</h1>
        <p class="text-muted mb-0">Manage RAG collections, documents, and access control</p>
    </div>
    <div>
        <a href="{{ url_for('rag.dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to RAG Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <i class="fas fa-layer-group fa-2x text-primary mb-2"></i>
                <h3 class="mb-0" id="stat-collections">{{ stats.collections }}</h3>
                <small class="text-muted">Collections</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <i class="fas fa-file-alt fa-2x text-success mb-2"></i>
                <h3 class="mb-0" id="stat-documents">{{ stats.documents }}</h3>
                <small class="text-muted">Documents</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x text-info mb-2"></i>
                <h3 class="mb-0" id="stat-users">{{ stats.users }}</h3>
                <small class="text-muted">Users</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <i class="fas fa-users-cog fa-2x text-warning mb-2"></i>
                <h3 class="mb-0" id="stat-groups">{{ stats.groups }}</h3>
                <small class="text-muted">Groups</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Collections Panel -->
    <div class="col-lg-4 mb-4">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Collections</h5>
                <button class="btn btn-sm btn-primary" onclick="showCreateCollectionModal()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                <div id="collections-list" class="list-group list-group-flush">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 small mb-0">Loading collections...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Panel -->
    <div class="col-lg-8 mb-4">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Documents
                        <span id="selected-collection-name" class="text-muted small ms-2"></span>
                    </h5>
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-1" id="btn-add-doc" onclick="showAddDocumentModal()" disabled>
                        <i class="fas fa-plus me-1"></i>Add
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="btn-refresh-docs" onclick="loadDocuments()" disabled>
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="documents-content">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-arrow-left fa-2x mb-3"></i>
                        <p>Select a collection to view documents</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Collection Details & Access Control -->
<div class="row" id="collection-details-row" style="display: none;">
    <div class="col-lg-6 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Collection Details</h5>
            </div>
            <div class="card-body" id="collection-details-content">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Access Control</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="showGrantAccessModal()">
                    <i class="fas fa-plus me-1"></i>Grant Access
                </button>
            </div>
            <div class="card-body" id="access-control-content">
                <p class="text-muted text-center small">No access rules configured</p>
            </div>
        </div>
    </div>
</div>

<!-- Create Collection Modal -->
<div class="modal fade" id="createCollectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Create Collection</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-collection-form">
                    <div class="mb-3">
                        <label class="form-label">Collection Name *</label>
                        <input type="text" class="form-control bg-secondary border-0 text-white" 
                               id="collection-name" required placeholder="e.g., documents, knowledge_base">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control bg-secondary border-0 text-white" 
                                  id="collection-description" rows="2" 
                                  placeholder="Optional description"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="collection-public">
                            <label class="form-check-label" for="collection-public">
                                Public (accessible by all users)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCollection()">
                    <i class="fas fa-plus me-1"></i>Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Document Modal -->
<div class="modal fade" id="addDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-file-upload me-2"></i>Add Document</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="addDocTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-files">
                            <i class="fas fa-file-upload me-1"></i>Upload Files
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-text">
                            <i class="fas fa-keyboard me-1"></i>Text
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-json">
                            <i class="fas fa-code me-1"></i>JSON
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- File Upload Tab (New Default) -->
                    <div class="tab-pane fade show active" id="tab-files">
                        <!-- Drag and Drop Zone -->
                        <div id="drop-zone" class="border border-2 border-dashed border-secondary rounded p-5 text-center mb-3"
                             style="min-height: 200px; cursor: pointer; transition: all 0.3s;">
                            <div id="drop-zone-content">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                <h5>Drag & Drop Files Here</h5>
                                <p class="text-muted mb-3">or click to browse</p>
                                <input type="file" id="file-input" multiple hidden 
                                       accept=".txt,.md,.pdf,.json,.csv,.html,.xml,.py,.js,.ts,.css,.yaml,.yml">
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('file-input').click()">
                                    <i class="fas fa-folder-open me-1"></i>Browse Files
                                </button>
                                <p class="small text-muted mt-3 mb-0">
                                    Supported: TXT, MD, PDF, JSON, CSV, HTML, XML, PY, JS, TS, CSS, YAML
                                </p>
                            </div>
                        </div>
                        
                        <!-- File List -->
                        <div id="file-list" class="mb-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="fas fa-list me-1"></i>Selected Files</h6>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFileList()">
                                    <i class="fas fa-times me-1"></i>Clear All
                                </button>
                            </div>
                            <div id="file-items" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                                <!-- Files will be listed here -->
                            </div>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="upload-progress" style="display: none;">
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%;" id="upload-progress-bar">0%</div>
                            </div>
                            <p class="text-center text-muted small" id="upload-status">Uploading...</p>
                        </div>
                    </div>
                    
                    <!-- Text Tab -->
                    <div class="tab-pane fade" id="tab-text">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control bg-secondary border-0 text-white" 
                                   id="doc-title" placeholder="Document title">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content *</label>
                            <textarea class="form-control bg-secondary border-0 text-white" 
                                      id="doc-content" rows="8" 
                                      placeholder="Enter document content..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source</label>
                            <input type="text" class="form-control bg-secondary border-0 text-white" 
                                   id="doc-source" placeholder="e.g., manual_input, file.txt">
                        </div>
                    </div>

                    <!-- JSON Tab -->
                    <div class="tab-pane fade" id="tab-json">
                        <div class="mb-3">
                            <label class="form-label">Documents (JSON Array)</label>
                            <textarea class="form-control bg-secondary border-0 text-white font-monospace" 
                                      id="doc-json" rows="12" 
                                      placeholder='[
  {"content": "First document text...", "source": "doc1.txt"},
  {"content": "Second document text...", "source": "doc2.txt"}
]'></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btn-add-document" onclick="addDocument()">
                    <i class="fas fa-plus me-1"></i>Add Document
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Collection Modal -->
<div class="modal fade" id="editCollectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Collection</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-collection-form">
                    <input type="hidden" id="edit-collection-id">
                    <div class="mb-3">
                        <label class="form-label">Collection Name *</label>
                        <input type="text" class="form-control bg-secondary border-0 text-white" 
                               id="edit-collection-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control bg-secondary border-0 text-white" 
                                  id="edit-collection-description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit-collection-public">
                            <label class="form-check-label" for="edit-collection-public">
                                Public (accessible by all users)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCollection()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Grant Access Modal -->
<div class="modal fade" id="grantAccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Grant Access</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Grant To</label>
                    <select class="form-select bg-secondary border-0 text-white" id="access-target-type">
                        <option value="user">User</option>
                        <option value="group">Group</option>
                    </select>
                </div>
                <div class="mb-3" id="user-select-container">
                    <label class="form-label">Select User</label>
                    <select class="form-select bg-secondary border-0 text-white" id="access-user">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="mb-3" id="group-select-container" style="display: none;">
                    <label class="form-label">Select Group</label>
                    <select class="form-select bg-secondary border-0 text-white" id="access-group">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Access Level</label>
                    <select class="form-select bg-secondary border-0 text-white" id="access-level">
                        <option value="read">Read - Can query collection</option>
                        <option value="write">Write - Can add/edit documents</option>
                        <option value="admin">Admin - Full control</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="grantAccess()">
                    <i class="fas fa-check me-1"></i>Grant Access
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedCollection = null;
let selectedCollectionName = null;
let createCollectionModal = null;
let addDocumentModal = null;
let grantAccessModal = null;
let editCollectionModal = null;

document.addEventListener('DOMContentLoaded', function() {
    createCollectionModal = new bootstrap.Modal(document.getElementById('createCollectionModal'));
    addDocumentModal = new bootstrap.Modal(document.getElementById('addDocumentModal'));
    grantAccessModal = new bootstrap.Modal(document.getElementById('grantAccessModal'));
    editCollectionModal = new bootstrap.Modal(document.getElementById('editCollectionModal'));
    
    loadCollections();
    setupAccessTargetSwitch();
    setupFileUpload();
});

function loadCollections() {
    fetch('/rag/api/collections')
        .then(response => response.json())
        .then(data => {
            const collections = data.collections || [];
            const listEl = document.getElementById('collections-list');
            
            document.getElementById('stat-collections').textContent = collections.length;
            
            if (collections.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                        <p class="small mb-2">No collections yet</p>
                        <button class="btn btn-sm btn-primary" onclick="showCreateCollectionModal()">
                            <i class="fas fa-plus me-1"></i>Create First Collection
                        </button>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = collections.map(c => `
                <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-secondary collection-item" 
                   data-collection-id="${c.id || c.collection_id}" onclick="selectCollection('${c.id || c.collection_id}', '${c.name}'); return false;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${c.name}</strong>
                            <small class="d-block text-muted">${c.description || ''}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-info">${c.doc_count || c.document_count || 0}</span>
                            ${c.is_public ? '<i class="fas fa-globe text-success ms-1" title="Public"></i>' : ''}
                        </div>
                    </div>
                </a>
            `).join('');
        })
        .catch(err => {
            document.getElementById('collections-list').innerHTML = 
                '<div class="text-danger p-3">Failed to load collections</div>';
        });
}

function selectCollection(collectionId, name) {
    selectedCollection = collectionId;
    selectedCollectionName = name;
    
    // Update UI
    document.querySelectorAll('.collection-item').forEach(el => {
        el.classList.remove('active');
    });
    document.querySelector(`[data-collection-id="${collectionId}"]`)?.classList.add('active');
    
    document.getElementById('selected-collection-name').textContent = `(${name})`;
    document.getElementById('btn-add-doc').disabled = false;
    document.getElementById('btn-refresh-docs').disabled = false;
    document.getElementById('collection-details-row').style.display = 'flex';
    
    loadDocuments();
    loadCollectionDetails();
    loadAccessControl();
}

function loadDocuments() {
    if (!selectedCollection) return;
    
    const content = document.getElementById('documents-content');
    content.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';
    
    // For now, get documents from the collection info or RAG service
    fetch(`/rag/api/collections/${selectedCollection}`)
        .then(response => response.json())
        .then(data => {
            const docs = data.documents || [];
            const docCount = data.collection?.doc_count || data.collection?.document_count || docs.length || 0;
            
            if (docCount === 0 && docs.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <p class="mb-2">No documents in this collection</p>
                        <button class="btn btn-sm btn-primary" onclick="showAddDocumentModal()">
                            <i class="fas fa-plus me-1"></i>Add First Document
                        </button>
                    </div>
                `;
                return;
            }
            
            if (docs.length > 0) {
                content.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Title/Source</th>
                                    <th>Added</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${docs.map(doc => `
                                    <tr>
                                        <td>
                                            <strong>${doc.title || 'Untitled'}</strong>
                                            <small class="d-block text-muted">${doc.source || '-'}</small>
                                        </td>
                                        <td><small>${formatDate(doc.created_at)}</small></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument('${doc.document_id || doc.id}')" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                // Just show count if individual documents not returned
                content.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h4>${docCount} document(s)</h4>
                        <p class="text-muted">Use the RAG query to search these documents</p>
                        <button class="btn btn-primary" onclick="showAddDocumentModal()">
                            <i class="fas fa-plus me-1"></i>Add More Documents
                        </button>
                    </div>
                `;
            }
        })
        .catch(err => {
            content.innerHTML = '<div class="text-danger">Failed to load documents</div>';
        });
}

function loadCollectionDetails() {
    if (!selectedCollection) return;
    
    fetch(`/rag/api/collections/${selectedCollection}`)
        .then(response => response.json())
        .then(data => {
            const c = data.collection || data;
            document.getElementById('collection-details-content').innerHTML = `
                <table class="table table-dark table-sm mb-3">
                    <tr><th width="30%">ID</th><td><code>${c.id || selectedCollection}</code></td></tr>
                    <tr><th>Name</th><td>${c.name || selectedCollectionName}</td></tr>
                    <tr><th>Description</th><td>${c.description || '-'}</td></tr>
                    <tr><th>Documents</th><td>${c.doc_count || c.document_count || 0}</td></tr>
                    <tr><th>Public</th><td>${c.is_public ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td></tr>
                </table>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="showEditCollectionModal('${c.id || selectedCollection}', '${escapeQuotes(c.name)}', '${escapeQuotes(c.description || '')}', ${c.is_public || false})">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCollection()">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            `;
        })
        .catch(err => {
            document.getElementById('collection-details-content').innerHTML = 
                '<div class="text-danger">Failed to load details</div>';
        });
}

function escapeQuotes(str) {
    return str ? str.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
}

function loadAccessControl() {
    if (!selectedCollection) return;
    
    fetch(`/rag/api/collections/${selectedCollection}/access`)
        .then(response => response.json())
        .then(data => {
            const access = data.access || [];
            const content = document.getElementById('access-control-content');
            
            if (access.length === 0) {
                content.innerHTML = '<p class="text-muted text-center small mb-0">No access rules configured. Collection uses default access.</p>';
                return;
            }
            
            content.innerHTML = access.map(a => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-secondary rounded">
                    <div>
                        <i class="fas fa-${a.username ? 'user' : 'users'} me-2"></i>
                        <strong>${a.username || a.group_name}</strong>
                        <span class="badge bg-${getAccessLevelColor(a.access_level)} ms-2">${a.access_level}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="revokeAccess(${a.user_id || 'null'}, ${a.group_id || 'null'})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        })
        .catch(err => {
            document.getElementById('access-control-content').innerHTML = 
                '<div class="text-danger small">Failed to load access control</div>';
        });
}

function showCreateCollectionModal() {
    document.getElementById('collection-name').value = '';
    document.getElementById('collection-description').value = '';
    document.getElementById('collection-public').checked = false;
    createCollectionModal.show();
}

function createCollection() {
    const name = document.getElementById('collection-name').value.trim();
    const description = document.getElementById('collection-description').value.trim();
    const isPublic = document.getElementById('collection-public').checked;
    
    if (!name) {
        showToast('Collection name is required', 'error');
        return;
    }
    
    fetch('/rag/api/collections', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, is_public: isPublic })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success || data.collection) {
                showToast('Collection created successfully', 'success');
                createCollectionModal.hide();
                loadCollections();
            } else {
                showToast(data.error || 'Failed to create collection', 'error');
            }
        })
        .catch(err => showToast('Error creating collection', 'error'));
}

function deleteCollection() {
    if (!selectedCollection) return;
    if (!confirm(`Delete collection "${selectedCollectionName}"? This cannot be undone.`)) return;
    
    fetch(`/rag/api/collections/${selectedCollection}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Collection deleted', 'success');
                selectedCollection = null;
                document.getElementById('collection-details-row').style.display = 'none';
                document.getElementById('selected-collection-name').textContent = '';
                document.getElementById('btn-add-doc').disabled = true;
                document.getElementById('documents-content').innerHTML = 
                    '<div class="text-center py-5 text-muted"><i class="fas fa-arrow-left fa-2x mb-3"></i><p>Select a collection</p></div>';
                loadCollections();
            } else {
                showToast(data.error || 'Failed to delete collection', 'error');
            }
        })
        .catch(err => showToast('Error deleting collection', 'error'));
}

function showEditCollectionModal(id, name, description, isPublic) {
    document.getElementById('edit-collection-id').value = id;
    document.getElementById('edit-collection-name').value = name;
    document.getElementById('edit-collection-description').value = description;
    document.getElementById('edit-collection-public').checked = isPublic;
    editCollectionModal.show();
}

function updateCollection() {
    const collectionId = document.getElementById('edit-collection-id').value;
    const data = {
        name: document.getElementById('edit-collection-name').value.trim(),
        description: document.getElementById('edit-collection-description').value.trim(),
        is_public: document.getElementById('edit-collection-public').checked
    };
    
    if (!data.name) {
        showToast('Collection name is required', 'error');
        return;
    }
    
    fetch(`/rag/api/collections/${collectionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast('Collection updated', 'success');
                editCollectionModal.hide();
                loadCollections();
                loadCollectionDetails();
            } else {
                showToast(result.error || 'Failed to update collection', 'error');
            }
        })
        .catch(err => showToast('Error updating collection', 'error'));
}

// =====================
// File Upload Handling
// =====================

let selectedFiles = [];

function setupFileUpload() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    
    if (!dropZone || !fileInput) return;
    
    // Drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Highlight on drag
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('border-primary', 'bg-primary');
            dropZone.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('border-primary', 'bg-primary');
            dropZone.style.backgroundColor = '';
        }, false);
    });
    
    // Handle drop
    dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        handleFiles(files);
    }, false);
    
    // Click to browse
    dropZone.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
            fileInput.click();
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
}

function handleFiles(files) {
    const allowedExtensions = ['.txt', '.md', '.pdf', '.json', '.csv', '.html', '.xml', '.py', '.js', '.ts', '.css', '.yaml', '.yml', '.docx'];
    const maxFileSize = 50 * 1024 * 1024; // 50MB
    
    for (let file of files) {
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(ext)) {
            showToast(`File type ${ext} not supported: ${file.name}`, 'warning');
            continue;
        }
        
        if (file.size > maxFileSize) {
            showToast(`File too large (max 50MB): ${file.name}`, 'warning');
            continue;
        }
        
        // Check for duplicates
        if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push(file);
        }
    }
    
    updateFileList();
}

function updateFileList() {
    const fileList = document.getElementById('file-list');
    const fileItems = document.getElementById('file-items');
    
    if (selectedFiles.length === 0) {
        fileList.style.display = 'none';
        return;
    }
    
    fileList.style.display = 'block';
    fileItems.innerHTML = selectedFiles.map((file, index) => `
        <div class="list-group-item bg-secondary border-0 d-flex justify-content-between align-items-center py-2">
            <div>
                <i class="fas fa-file-alt text-primary me-2"></i>
                <span>${escapeHtml(file.name)}</span>
                <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

function clearFileList() {
    selectedFiles = [];
    document.getElementById('file-input').value = '';
    updateFileList();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function uploadFiles() {
    if (!selectedCollection) {
        showToast('No collection selected', 'error');
        return false;
    }
    
    if (selectedFiles.length === 0) {
        showToast('No files selected', 'error');
        return false;
    }
    
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('upload-progress-bar');
    const statusText = document.getElementById('upload-status');
    const addBtn = document.getElementById('btn-add-document');
    
    progressDiv.style.display = 'block';
    addBtn.disabled = true;
    
    let uploaded = 0;
    let failed = 0;
    const total = selectedFiles.length;
    
    for (let file of selectedFiles) {
        statusText.textContent = `Uploading ${file.name}...`;
        
        const formData = new FormData();
        formData.append('files', file);
        formData.append('collection_id', selectedCollection);
        
        try {
            const response = await fetch('/rag/api/documents/upload', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                uploaded++;
            } else {
                failed++;
                console.error('Upload failed:', data.error);
            }
        } catch (err) {
            failed++;
            console.error('Upload error:', err);
        }
        
        const percent = Math.round(((uploaded + failed) / total) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
    }
    
    progressDiv.style.display = 'none';
    addBtn.disabled = false;
    
    if (uploaded > 0) {
        showToast(`${uploaded} file(s) uploaded successfully`, 'success');
        clearFileList();
        return true;
    } else {
        showToast('All uploads failed', 'error');
        return false;
    }
}

function showAddDocumentModal() {
    if (!selectedCollection) return;
    document.getElementById('doc-title').value = '';
    document.getElementById('doc-content').value = '';
    document.getElementById('doc-source').value = '';
    document.getElementById('doc-json').value = '';
    clearFileList();
    
    // Reset to Files tab
    const filesTab = document.querySelector('#addDocTabs .nav-link[data-bs-target="#tab-files"]');
    if (filesTab) {
        new bootstrap.Tab(filesTab).show();
    }
    
    document.getElementById('upload-progress').style.display = 'none';
    addDocumentModal.show();
}

async function addDocument() {
    if (!selectedCollection) return;
    
    const activeTab = document.querySelector('#addDocTabs .nav-link.active').getAttribute('data-bs-target');
    
    // Handle file upload tab
    if (activeTab === '#tab-files') {
        const success = await uploadFiles();
        if (success) {
            addDocumentModal.hide();
            loadDocuments();
            loadCollections();
        }
        return;
    }
    
    // Handle text and JSON tabs
    let documents = [];
    
    if (activeTab === '#tab-text') {
        const content = document.getElementById('doc-content').value.trim();
        if (!content) {
            showToast('Content is required', 'error');
            return;
        }
        documents = [{
            content: content,
            source: document.getElementById('doc-source').value.trim() || 'manual_input',
            title: document.getElementById('doc-title').value.trim()
        }];
    } else if (activeTab === '#tab-json') {
        try {
            const json = document.getElementById('doc-json').value.trim();
            if (!json) {
                showToast('JSON content is required', 'error');
                return;
            }
            const parsed = JSON.parse(json);
            documents = Array.isArray(parsed) ? parsed : [parsed];
        } catch (e) {
            showToast('Invalid JSON format', 'error');
            return;
        }
    }
    
    fetch('/rag/api/documents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            collection_id: selectedCollection,
            documents: documents
        })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`${data.added || documents.length} document(s) added`, 'success');
                addDocumentModal.hide();
                loadDocuments();
                loadCollections();
            } else {
                showToast(data.error || 'Failed to add document', 'error');
            }
        })
        .catch(err => showToast('Error adding document', 'error'));
}

function deleteDocument(docId) {
    if (!confirm('Delete this document?')) return;
    
    fetch(`/rag/api/documents/${docId}?collection_id=${selectedCollection}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Document deleted', 'success');
                loadDocuments();
                loadCollections();
            } else {
                showToast(data.error || 'Failed to delete document', 'error');
            }
        })
        .catch(err => showToast('Error deleting document', 'error'));
}

function setupAccessTargetSwitch() {
    document.getElementById('access-target-type').addEventListener('change', function() {
        document.getElementById('user-select-container').style.display = this.value === 'user' ? 'block' : 'none';
        document.getElementById('group-select-container').style.display = this.value === 'group' ? 'block' : 'none';
    });
}

function showGrantAccessModal() {
    // Load users and groups
    fetch('/rag/api/metadata/users')
        .then(response => response.json())
        .then(data => {
            const users = data.users || [];
            document.getElementById('access-user').innerHTML = 
                users.map(u => `<option value="${u.id}">${u.username} (${u.display_name || u.username})</option>`).join('');
        });
    
    fetch('/rag/api/metadata/groups')
        .then(response => response.json())
        .then(data => {
            const groups = data.groups || [];
            document.getElementById('access-group').innerHTML = 
                groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        });
    
    grantAccessModal.show();
}

function grantAccess() {
    if (!selectedCollection) return;
    
    const targetType = document.getElementById('access-target-type').value;
    const userId = targetType === 'user' ? document.getElementById('access-user').value : null;
    const groupId = targetType === 'group' ? document.getElementById('access-group').value : null;
    const level = document.getElementById('access-level').value;
    
    fetch(`/rag/api/collections/${selectedCollection}/access`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, group_id: groupId, access_level: level })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Access granted', 'success');
                grantAccessModal.hide();
                loadAccessControl();
            } else {
                showToast(data.error || 'Failed to grant access', 'error');
            }
        })
        .catch(err => showToast('Error granting access', 'error'));
}

function revokeAccess(userId, groupId) {
    if (!confirm('Revoke this access?')) return;
    
    fetch(`/rag/api/collections/${selectedCollection}/access`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, group_id: groupId })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Access revoked', 'success');
                loadAccessControl();
            } else {
                showToast(data.error || 'Failed to revoke access', 'error');
            }
        })
        .catch(err => showToast('Error revoking access', 'error'));
}

function getAccessLevelColor(level) {
    switch(level) {
        case 'admin': return 'danger';
        case 'write': return 'warning';
        case 'read': return 'info';
        default: return 'secondary';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    try {
        return new Date(dateStr).toLocaleDateString();
    } catch {
        return dateStr;
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
