{% extends "base.html" %}

{% block title %}RAG Environment Setup Wizard{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-magic me-2"></i>RAG Environment Setup Wizard</h2>
            <p class="text-muted mb-0">Set up a single environment for ChromaDB and FAISS vector databases</p>
        </div>
        <a href="{{ url_for('rag.rag_dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to RAG
        </a>
    </div>

    <!-- Wizard Steps -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between mb-4">
                <div class="wizard-step text-center flex-fill" id="step-indicator-1">
                    <div class="wizard-step-circle bg-primary mx-auto">1</div>
                    <small class="d-block mt-2">Welcome</small>
                </div>
                <div class="wizard-step text-center flex-fill" id="step-indicator-2">
                    <div class="wizard-step-circle bg-secondary mx-auto">2</div>
                    <small class="d-block mt-2">Provider Selection</small>
                </div>
                <div class="wizard-step text-center flex-fill" id="step-indicator-3">
                    <div class="wizard-step-circle bg-secondary mx-auto">3</div>
                    <small class="d-block mt-2">Installation</small>
                </div>
                <div class="wizard-step text-center flex-fill" id="step-indicator-4">
                    <div class="wizard-step-circle bg-secondary mx-auto">4</div>
                    <small class="d-block mt-2">Complete</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 1: Welcome -->
    <div class="wizard-content" id="step-1">
        <div class="card bg-dark border-primary">
            <div class="card-body text-center py-5">
                <i class="bi bi-database-fill-gear display-1 text-primary mb-4"></i>
                <h3>Welcome to RAG Environment Setup</h3>
                <p class="text-muted mb-4">
                    This wizard will help you set up a single Python virtual environment for 
                    <strong>RAG (Retrieval-Augmented Generation)</strong> with support for both 
                    <span class="text-info">ChromaDB</span> and <span class="text-warning">FAISS</span> vector databases.
                </p>
                
                <div class="row justify-content-center mb-4">
                    <div class="col-md-8">
                        <div class="alert alert-info text-start">
                            <h6><i class="bi bi-info-circle me-2"></i>What will be installed:</h6>
                            <ul class="mb-0">
                                <li><strong>ChromaDB</strong> - Modern embedding database with built-in persistence</li>
                                <li><strong>FAISS</strong> - Facebook AI Similarity Search for fast vector retrieval</li>
                                <li><strong>Sentence Transformers</strong> - For generating text embeddings</li>
                                <li><strong>LangChain</strong> - For document processing and RAG pipelines</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center mb-4">
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body">
                                <i class="bi bi-hdd-stack fs-1 text-info mb-2"></i>
                                <h6>Single Environment</h6>
                                <small class="text-muted">One venv for all RAG providers</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body">
                                <i class="bi bi-arrow-left-right fs-1 text-warning mb-2"></i>
                                <h6>Easy Switching</h6>
                                <small class="text-muted">Switch between ChromaDB & FAISS</small>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary btn-lg" onclick="nextStep(2)">
                    <i class="bi bi-arrow-right me-2"></i>Get Started
                </button>
            </div>
        </div>
    </div>

    <!-- Step 2: Provider Selection -->
    <div class="wizard-content d-none" id="step-2">
        <div class="card bg-dark border-info">
            <div class="card-header border-info">
                <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Select Providers to Install</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">Choose which vector database providers to install. You can always add more later.</p>
                
                <div class="row g-4 mb-4">
                    <!-- ChromaDB -->
                    <div class="col-md-6">
                        <div class="card bg-secondary h-100 provider-card" id="provider-chromadb">
                            <div class="card-body">
                                <div class="form-check form-check-lg mb-3">
                                    <input class="form-check-input" type="checkbox" id="check-chromadb" checked>
                                    <label class="form-check-label" for="check-chromadb">
                                        <h5 class="mb-0"><i class="bi bi-database me-2 text-info"></i>ChromaDB</h5>
                                    </label>
                                </div>
                                <p class="text-muted">
                                    Modern, open-source embedding database with:
                                </p>
                                <ul class="text-muted small">
                                    <li>Built-in persistence</li>
                                    <li>Automatic embedding generation</li>
                                    <li>Simple Python API</li>
                                    <li>Metadata filtering</li>
                                </ul>
                                <span class="badge bg-info">Recommended for beginners</span>
                            </div>
                        </div>
                    </div>

                    <!-- FAISS -->
                    <div class="col-md-6">
                        <div class="card bg-secondary h-100 provider-card" id="provider-faiss">
                            <div class="card-body">
                                <div class="form-check form-check-lg mb-3">
                                    <input class="form-check-input" type="checkbox" id="check-faiss" checked>
                                    <label class="form-check-label" for="check-faiss">
                                        <h5 class="mb-0"><i class="bi bi-lightning me-2 text-warning"></i>FAISS</h5>
                                    </label>
                                </div>
                                <p class="text-muted">
                                    Facebook AI Similarity Search with:
                                </p>
                                <ul class="text-muted small">
                                    <li>Extremely fast vector search</li>
                                    <li>GPU acceleration support</li>
                                    <li>Billion-scale indexing</li>
                                    <li>Multiple index types</li>
                                </ul>
                                <span class="badge bg-warning text-dark">Best for performance</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Packages -->
                <div class="card bg-secondary-subtle mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Additional Packages (Always Installed)</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="badge bg-success me-2">✓</span> sentence-transformers
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-success me-2">✓</span> langchain
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-success me-2">✓</span> langchain-community
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-success me-2">✓</span> numpy
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="nextStep(1)">
                        <i class="bi bi-arrow-left me-2"></i>Back
                    </button>
                    <button class="btn btn-primary" onclick="startInstallation()">
                        <i class="bi bi-download me-2"></i>Install Selected Packages
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Installation Progress -->
    <div class="wizard-content d-none" id="step-3">
        <div class="card bg-dark border-warning">
            <div class="card-header border-warning">
                <h5 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Installing RAG Environment</h5>
            </div>
            <div class="card-body py-5">
                <div class="text-center mb-4">
                    <div class="spinner-border text-primary mb-3" role="status" id="install-spinner">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4 id="install-title">Setting up environment...</h4>
                </div>

                <!-- Progress Bar -->
                <div class="row justify-content-center mb-4">
                    <div class="col-md-8">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" id="install-progress" style="width: 0%">
                                0%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Log -->
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card bg-secondary">
                            <div class="card-header">
                                <small class="text-muted">Installation Log</small>
                            </div>
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;" id="install-log">
                                <div class="text-muted">Waiting to start...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Complete -->
    <div class="wizard-content d-none" id="step-4">
        <div class="card bg-dark border-success">
            <div class="card-body text-center py-5">
                <i class="bi bi-check-circle display-1 text-success mb-4"></i>
                <h3>RAG Environment Ready!</h3>
                <p class="text-muted mb-4">
                    Your RAG environment has been set up successfully. You can now create databases 
                    and start using ChromaDB or FAISS for your vector search needs.
                </p>

                <!-- Installed Summary -->
                <div class="row justify-content-center mb-4">
                    <div class="col-md-8">
                        <div class="card bg-secondary">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-check2-all me-2"></i>Installed Packages</h6>
                            </div>
                            <div class="card-body" id="installed-summary">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-3">
                    <a href="{{ url_for('rag.rag_dashboard') }}" class="btn btn-success btn-lg">
                        <i class="bi bi-house me-2"></i>Go to RAG Dashboard
                    </a>
                    <a href="{{ url_for('rag.rag_manage_collections') }}" class="btn btn-outline-primary btn-lg">
                        <i class="bi bi-collection me-2"></i>Create Collection
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.wizard-step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.3s ease;
}

.wizard-step.active .wizard-step-circle {
    background-color: var(--bs-primary) !important;
    transform: scale(1.1);
}

.wizard-step.completed .wizard-step-circle {
    background-color: var(--bs-success) !important;
}

.provider-card {
    transition: all 0.2s ease;
    cursor: pointer;
}

.provider-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.provider-card.selected {
    border: 2px solid var(--bs-primary);
}

.form-check-lg .form-check-input {
    width: 1.5em;
    height: 1.5em;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
let installInterval = null;

// Check if already installed on load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/rag/api/env/status');
        const status = await response.json();
        
        if (status.installed) {
            // Already installed, show completion
            showAlreadyInstalled(status);
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
    
    // Provider card click handlers
    document.querySelectorAll('.provider-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
            }
        });
    });
});

function showAlreadyInstalled(status) {
    // Skip to step 4
    currentStep = 4;
    updateStepIndicators();
    showStep(4);
    
    // Show installed packages
    const summary = document.getElementById('installed-summary');
    if (status.packages && status.packages.length > 0) {
        summary.innerHTML = status.packages.map(pkg => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span><code>${pkg.name}</code></span>
                <span class="badge ${pkg.installed ? 'bg-success' : 'bg-danger'}">
                    ${pkg.installed ? 'Installed' : 'Not Installed'}
                </span>
            </div>
        `).join('');
    } else {
        summary.innerHTML = '<p class="text-muted mb-0">All core packages installed</p>';
    }
}

function nextStep(step) {
    console.log('nextStep called with step:', step);
    currentStep = step;
    updateStepIndicators();
    showStep(step);
}

function updateStepIndicators() {
    console.log('updateStepIndicators called, currentStep:', currentStep);
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step-indicator-${i}`);
        if (!indicator) {
            console.error('Missing indicator for step', i);
            continue;
        }
        const circle = indicator.querySelector('.wizard-step-circle');
        
        indicator.classList.remove('active', 'completed');
        circle.classList.remove('bg-primary', 'bg-success', 'bg-secondary');
        
        if (i < currentStep) {
            indicator.classList.add('completed');
            circle.classList.add('bg-success');
            circle.innerHTML = '<i class="bi bi-check"></i>';
        } else if (i === currentStep) {
            indicator.classList.add('active');
            circle.classList.add('bg-primary');
            circle.textContent = i;
        } else {
            circle.classList.add('bg-secondary');
            circle.textContent = i;
        }
    }
}

function showStep(step) {
    console.log('showStep called with step:', step);
    document.querySelectorAll('.wizard-content').forEach(el => {
        console.log('Hiding element:', el.id);
        el.classList.add('d-none');
    });
    const stepEl = document.getElementById('step-' + step);
    console.log('Target element:', stepEl);
    if (stepEl) {
        stepEl.classList.remove('d-none');
        console.log('Step', step, 'is now visible');
    } else {
        console.error('Could not find step-' + step);
    }
}

async function startInstallation() {
    const installChroma = document.getElementById('check-chromadb').checked;
    const installFaiss = document.getElementById('check-faiss').checked;
    
    if (!installChroma && !installFaiss) {
        alert('Please select at least one provider to install.');
        return;
    }
    
    nextStep(3);
    
    const progressBar = document.getElementById('install-progress');
    const logContainer = document.getElementById('install-log');
    const titleEl = document.getElementById('install-title');
    
    logContainer.innerHTML = '';
    
    function addLog(message, type = 'info') {
        const colors = {
            'info': 'text-info',
            'success': 'text-success',
            'error': 'text-danger',
            'warning': 'text-warning'
        };
        const entry = document.createElement('div');
        entry.className = colors[type] || 'text-muted';
        entry.innerHTML = `<small>${new Date().toLocaleTimeString()}</small> ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    try {
        addLog('Starting RAG environment setup...', 'info');
        titleEl.textContent = 'Creating virtual environment...';
        progressBar.style.width = '10%';
        progressBar.textContent = '10%';
        
        const response = await fetch('/rag/api/env/setup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                install_chromadb: installChroma,
                install_faiss: installFaiss
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Poll for progress
            pollProgress(addLog, progressBar, titleEl);
        } else {
            throw new Error(result.error || 'Setup failed');
        }
    } catch (error) {
        addLog(`Error: ${error.message}`, 'error');
        progressBar.classList.add('bg-danger');
        titleEl.textContent = 'Installation Failed';
        document.getElementById('install-spinner').classList.add('d-none');
    }
}

async function pollProgress(addLog, progressBar, titleEl) {
    try {
        const response = await fetch('/rag/api/env/progress');
        const progress = await response.json();
        
        progressBar.style.width = `${progress.percent || 0}%`;
        progressBar.textContent = `${progress.percent || 0}%`;
        
        if (progress.message) {
            titleEl.textContent = progress.message;
            addLog(progress.message, 'info');
        }
        
        if (progress.complete) {
            if (progress.success) {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                addLog('Installation complete!', 'success');
                
                // Show installed packages
                const summary = document.getElementById('installed-summary');
                if (progress.packages) {
                    summary.innerHTML = progress.packages.map(pkg => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span><code>${pkg.name}</code></span>
                            <span class="badge bg-success">Installed</span>
                        </div>
                    `).join('');
                }
                
                setTimeout(() => nextStep(4), 1500);
            } else {
                throw new Error(progress.error || 'Installation failed');
            }
        } else {
            setTimeout(() => pollProgress(addLog, progressBar, titleEl), 1000);
        }
    } catch (error) {
        addLog(`Error: ${error.message}`, 'error');
        progressBar.classList.add('bg-danger');
        titleEl.textContent = 'Installation Failed';
        document.getElementById('install-spinner').classList.add('d-none');
    }
}
</script>
{% endblock %}
