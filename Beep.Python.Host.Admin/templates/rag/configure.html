{% extends "base.html" %}

{% block title %}Configure RAG - Python Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-gear me-2"></i>Configure RAG</h2>
    <a href="{{ url_for('rag.rag_dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back
    </a>
</div>

<!-- Status Alert -->
<div id="statusAlert" class="alert d-none mb-3"></div>

<!-- Enable/Disable -->
<div class="card bg-dark mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-power me-2"></i>RAG Status</h5>
    </div>
    <div class="card-body">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="ragEnabled" 
                   {% if settings.enabled %}checked{% endif %}>
            <label class="form-check-label" for="ragEnabled">
                Enable RAG (Retrieval-Augmented Generation)
            </label>
        </div>
        <small class="text-muted">When enabled, chat requests will be augmented with context from your RAG provider.</small>
    </div>
</div>

<!-- Provider Selection -->
<div class="card bg-dark mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-stack me-2"></i>RAG Provider</h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for provider_id, provider_info in providers.items() %}
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="provider" 
                           id="provider_{{ provider_id }}" value="{{ provider_id }}"
                           {% if settings.provider_type == provider_id %}checked{% endif %}
                           {% if not provider_info.available %}disabled{% endif %}>
                    <label class="form-check-label" for="provider_{{ provider_id }}">
                        {% if provider_id == 'external_api' %}
                        <i class="bi bi-cloud me-1"></i>External API
                        {% elif provider_id == 'faiss' %}
                        <i class="bi bi-cpu me-1"></i>FAISS
                        {% elif provider_id == 'chromadb' %}
                        <i class="bi bi-database me-1"></i>ChromaDB
                        {% endif %}
                        {% if not provider_info.available %}
                        <span class="badge bg-warning text-dark ms-1">Not Installed</span>
                        {% endif %}
                    </label>
                    <div class="text-muted small">
                        {% if provider_id == 'external_api' %}
                        Delegate to your external RAG API
                        {% elif provider_id == 'faiss' %}
                        Fast local vector database
                        {% elif provider_id == 'chromadb' %}
                        Feature-rich local database
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Local Provider Settings (FAISS/ChromaDB) -->
<div class="card bg-dark mb-4" id="localProviderSettings">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-hdd me-2"></i>Local Provider Settings</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Data Path</label>
                <input type="text" class="form-control bg-dark text-light" id="dataPath"
                       placeholder="Leave empty for default"
                       value="{{ settings.data_path or '' }}">
                <small class="text-muted">Where to store vector database files</small>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Embedding Model</label>
                <select class="form-select bg-dark text-light" id="embeddingModel">
                    <option value="all-MiniLM-L6-v2" {% if settings.embedding_model == 'all-MiniLM-L6-v2' %}selected{% endif %}>
                        all-MiniLM-L6-v2 (Fast, 384 dims)
                    </option>
                    <option value="all-mpnet-base-v2" {% if settings.embedding_model == 'all-mpnet-base-v2' %}selected{% endif %}>
                        all-mpnet-base-v2 (Better quality, 768 dims)
                    </option>
                    <option value="paraphrase-multilingual-MiniLM-L12-v2" {% if settings.embedding_model == 'paraphrase-multilingual-MiniLM-L12-v2' %}selected{% endif %}>
                        Multilingual MiniLM (Multi-language)
                    </option>
                </select>
                <small class="text-muted">Sentence-transformer model for embeddings</small>
            </div>
        </div>
    </div>
</div>

<!-- External API Configuration -->
<div class="card bg-dark mb-4" id="externalApiSettings">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-cloud me-2"></i>External API Connection</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8 mb-3">
                <label class="form-label">Base URL <span class="text-danger">*</span></label>
                <input type="url" class="form-control bg-dark text-light" id="baseUrl"
                       placeholder="https://your-rag-api.example.com"
                       value="{{ settings.external_api.base_url if settings.external_api else '' }}">
                <small class="text-muted">The base URL of your RAG API server</small>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Timeout (seconds)</label>
                <input type="number" class="form-control bg-dark text-light" id="timeout"
                       value="{{ settings.external_api.timeout if settings.external_api else 30 }}"
                       min="1" max="300">
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">API Key</label>
                <div class="input-group">
                    <input type="password" class="form-control bg-dark text-light" id="apiKey"
                           placeholder="Enter API key">
                    <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKey()">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
                <small class="text-muted">Leave empty to keep current key</small>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Auth Header</label>
                <input type="text" class="form-control bg-dark text-light" id="authHeader"
                       value="{{ settings.external_api.auth_header if settings.external_api else 'Authorization' }}">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Auth Prefix</label>
                <input type="text" class="form-control bg-dark text-light" id="authPrefix"
                       value="{{ settings.external_api.auth_prefix if settings.external_api else 'Bearer' }}">
            </div>
        </div>
        
        <button type="button" class="btn btn-outline-info" onclick="testConnection()">
            <i class="bi bi-wifi me-1"></i>Test Connection
        </button>
    </div>
</div>

<!-- Context Settings -->
<div class="card bg-dark mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-text-paragraph me-2"></i>Context Settings</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Max Context Length (chars)</label>
                <input type="number" class="form-control bg-dark text-light" id="maxContextLength"
                       value="{{ settings.max_context_length }}" min="100" max="50000">
                <small class="text-muted">Maximum characters to inject into prompt</small>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Cache TTL (seconds)</label>
                <input type="number" class="form-control bg-dark text-light" id="cacheTtl"
                       value="{{ settings.cache_ttl_seconds }}" min="0" max="86400">
                <small class="text-muted">How long to cache context results</small>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Options</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cacheContexts"
                           {% if settings.cache_contexts %}checked{% endif %}>
                    <label class="form-check-label" for="cacheContexts">Enable Caching</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fallbackOnError"
                           {% if settings.fallback_on_api_error %}checked{% endif %}>
                    <label class="form-check-label" for="fallbackOnError">Fallback on API Error</label>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Context Template</label>
            <textarea class="form-control bg-dark text-light" id="contextTemplate" rows="6">{{ settings.context_template }}</textarea>
            <small class="text-muted">Use <code>{context}</code> as placeholder for retrieved content</small>
        </div>
    </div>
</div>

<!-- Pipeline API Settings: Auth API and Context API -->
<div class="card bg-dark mb-4" id="pipelineSettings">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>RAG Pipeline APIs</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">
            <strong>Pipeline Flow:</strong> User Query → Auth API → RAG Storage → Context API → LLM → Response
            <br>
            Enable these optional APIs to add authorization and context processing to your RAG pipeline.
        </p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card bg-secondary bg-opacity-25 p-3 h-100">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="useAuthApi"
                               {% if settings.use_auth_api %}checked{% endif %}>
                        <label class="form-check-label" for="useAuthApi">
                            <i class="bi bi-shield-check me-1"></i><strong>Step 1: Authorization API</strong>
                        </label>
                    </div>
                    <small class="text-muted d-block">
                        <strong>When:</strong> Before RAG retrieval<br>
                        <strong>Purpose:</strong> Validate user has access to query RAG<br>
                        <strong>Endpoint:</strong> <code>POST /api/rag/authorize</code>
                    </small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-secondary bg-opacity-25 p-3 h-100">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="useContextApi"
                               {% if settings.use_context_api %}checked{% endif %}>
                        <label class="form-check-label" for="useContextApi">
                            <i class="bi bi-funnel me-1"></i><strong>Step 3: Context Processing API</strong>
                        </label>
                    </div>
                    <small class="text-muted d-block">
                        <strong>When:</strong> After RAG retrieval, before LLM<br>
                        <strong>Purpose:</strong> Filter, rerank, summarize, enrich contexts<br>
                        <strong>Endpoint:</strong> <code>POST /api/rag/process-context</code>
                    </small>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3" id="pipelineApiWarning" style="display: none;">
            <i class="bi bi-info-circle me-2"></i>
            To use Pipeline APIs, configure the External API Connection settings above.
        </div>
    </div>
</div>

<!-- Save Button -->
<div class="card bg-dark mb-4">
    <div class="card-body">
        <button type="button" class="btn btn-primary btn-lg w-100" onclick="saveConfiguration()">
            <i class="bi bi-save me-2"></i>Save Configuration
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showStatus(message, type) {
    const alert = document.getElementById('statusAlert');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alert.classList.remove('d-none');
    
    if (type === 'success') {
        setTimeout(() => alert.classList.add('d-none'), 3000);
    }
}

function toggleApiKey() {
    const input = document.getElementById('apiKey');
    input.type = input.type === 'password' ? 'text' : 'password';
}

function updateProviderUI() {
    const provider = document.querySelector('input[name="provider"]:checked')?.value || 'faiss';
    const externalSettings = document.getElementById('externalApiSettings');
    const localSettings = document.getElementById('localProviderSettings');
    const pipelineSettings = document.getElementById('pipelineSettings');
    
    if (provider === 'external_api') {
        externalSettings.style.display = 'block';
        localSettings.style.display = 'none';
    } else {
        externalSettings.style.display = 'block';  // Always show for pipeline API config
        localSettings.style.display = 'block';
    }
    
    // Always show pipeline settings (works with any provider)
    pipelineSettings.style.display = 'block';
    
    // Show warning if pipeline APIs are enabled but no API URL configured
    updatePipelineWarning();
}

function updatePipelineWarning() {
    const useAuthApi = document.getElementById('useAuthApi')?.checked || false;
    const useContextApi = document.getElementById('useContextApi')?.checked || false;
    const baseUrl = document.getElementById('baseUrl').value;
    const pipelineApiWarning = document.getElementById('pipelineApiWarning');
    
    if ((useAuthApi || useContextApi) && !baseUrl) {
        pipelineApiWarning.style.display = 'block';
    } else {
        pipelineApiWarning.style.display = 'none';
    }
}

// Update UI on provider change
document.querySelectorAll('input[name="provider"]').forEach(radio => {
    radio.addEventListener('change', updateProviderUI);
});

// Update warning when pipeline options change
document.getElementById('useAuthApi')?.addEventListener('change', updatePipelineWarning);
document.getElementById('useContextApi')?.addEventListener('change', updatePipelineWarning);
document.getElementById('baseUrl')?.addEventListener('input', updatePipelineWarning);

// Initial UI update
updateProviderUI();

function testConnection() {
    const baseUrl = document.getElementById('baseUrl').value;
    if (!baseUrl) {
        showStatus('Please enter a Base URL first', 'warning');
        return;
    }
    
    showStatus('Testing connection...', 'info');
    
    fetch('/rag/api/test-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            base_url: baseUrl,
            api_key: document.getElementById('apiKey').value || undefined,
            auth_header: document.getElementById('authHeader').value,
            auth_prefix: document.getElementById('authPrefix').value,
            status_endpoint: '/api/rag/status'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Connection successful!', 'success');
        } else {
            showStatus('Connection failed: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showStatus('Error: ' + error, 'danger');
    });
}

function saveConfiguration() {
    const provider = document.querySelector('input[name="provider"]:checked')?.value || 'faiss';
    
    const config = {
        enabled: document.getElementById('ragEnabled').checked,
        provider_type: provider,
        max_context_length: parseInt(document.getElementById('maxContextLength').value),
        cache_ttl_seconds: parseInt(document.getElementById('cacheTtl').value),
        cache_contexts: document.getElementById('cacheContexts').checked,
        fallback_on_api_error: document.getElementById('fallbackOnError').checked,
        context_template: document.getElementById('contextTemplate').value,
        // Pipeline API settings
        use_auth_api: document.getElementById('useAuthApi')?.checked || false,
        use_context_api: document.getElementById('useContextApi')?.checked || false
    };
    
    // Add local provider settings
    if (provider !== 'external_api') {
        config.data_path = document.getElementById('dataPath').value || null;
        config.embedding_model = document.getElementById('embeddingModel').value;
    }
    
    // Add external API settings (needed for external_api provider OR for pipeline APIs)
    const baseUrl = document.getElementById('baseUrl').value;
    if (baseUrl) {
        config.base_url = baseUrl;
        const apiKey = document.getElementById('apiKey').value;
        if (apiKey) config.api_key = apiKey;
        config.timeout = parseFloat(document.getElementById('timeout').value);
        config.auth_header = document.getElementById('authHeader').value;
        config.auth_prefix = document.getElementById('authPrefix').value;
    }
    
    showStatus('Saving configuration...', 'info');
    
    fetch('/rag/api/configure', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Configuration saved!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showStatus('Error: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showStatus('Error: ' + error, 'danger');
    });
}
</script>
{% endblock %}
