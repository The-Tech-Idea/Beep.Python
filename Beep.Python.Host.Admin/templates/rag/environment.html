{% extends "base.html" %}

{% block title %}RAG Environment Management{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="fas fa-server me-2"></i>RAG Environment Management</h1>
        <p class="text-muted mb-0">Create, configure, and manage RAG virtual environment</p>
    </div>
    <div>
        <a href="{{ url_for('rag.dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to RAG Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Environment Status Panel -->
    <div class="col-lg-4 mb-4">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Environment Status</h5>
            </div>
            <div class="card-body">
                <div id="env-status-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Checking environment...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Provider Setup Panel -->
    <div class="col-lg-8 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Provider Setup</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-secondary h-100 provider-card" id="faiss-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-database me-2 text-info"></i>FAISS
                                    </h5>
                                    <span class="badge bg-warning" id="faiss-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted">
                                    Facebook AI Similarity Search - Efficient similarity search with GPU support
                                </p>
                                <ul class="small mb-3">
                                    <li>Fast vector similarity search</li>
                                    <li>GPU acceleration available</li>
                                    <li>Optimized for large datasets</li>
                                </ul>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="faiss-gpu">
                                    <label class="form-check-label small" for="faiss-gpu">
                                        Enable GPU Support (CUDA required)
                                    </label>
                                </div>
                                <button class="btn btn-primary w-100" id="btn-setup-faiss" onclick="setupProvider('faiss')">
                                    <i class="fas fa-download me-1"></i>Install FAISS
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-secondary h-100 provider-card" id="chromadb-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-layer-group me-2 text-success"></i>ChromaDB
                                    </h5>
                                    <span class="badge bg-warning" id="chromadb-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted">
                                    AI-native open-source embedding database with built-in persistence
                                </p>
                                <ul class="small mb-3">
                                    <li>Simple API</li>
                                    <li>Built-in persistence</li>
                                    <li>Metadata filtering</li>
                                </ul>
                                <div class="mb-3" style="height: 30px;">
                                    <!-- Spacer to align with FAISS card -->
                                </div>
                                <button class="btn btn-primary w-100" id="btn-setup-chromadb" onclick="setupProvider('chromadb')">
                                    <i class="fas fa-download me-1"></i>Install ChromaDB
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Packages (APScheduler, etc) -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-muted mb-3"><i class="fas fa-puzzle-piece me-2"></i>Additional Components</h6>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-clock me-2 text-warning"></i>APScheduler
                                    </h6>
                                    <span class="badge bg-warning" id="apscheduler-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted mb-2">
                                    Required for sync job scheduling (Windows/Mac/Linux)
                                </p>
                                <button class="btn btn-sm btn-warning w-100" id="btn-install-apscheduler" onclick="installPackage('apscheduler')">
                                    <i class="fas fa-download me-1"></i>Install
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-database me-2 text-info"></i>SQLAlchemy
                                    </h6>
                                    <span class="badge bg-warning" id="sqlalchemy-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted mb-2">
                                    Database toolkit for data source connectors
                                </p>
                                <button class="btn btn-sm btn-info w-100" id="btn-install-sqlalchemy" onclick="installPackage('sqlalchemy')">
                                    <i class="fas fa-download me-1"></i>Install
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-file-pdf me-2 text-danger"></i>PyPDF
                                    </h6>
                                    <span class="badge bg-secondary" id="pypdf-badge">Optional</span>
                                </div>
                                <p class="card-text small text-muted mb-2">
                                    PDF processing for document ingestion
                                </p>
                                <button class="btn btn-sm btn-outline-secondary w-100" id="btn-install-pypdf" onclick="installPackage('pypdf')">
                                    <i class="fas fa-download me-1"></i>Install
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Provider Info -->
                <div class="alert alert-info mt-4" id="active-provider-info" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Active Provider:</strong> <span id="active-provider-name"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Environment Actions Row -->
<div class="row">
    <!-- Create/Manage Environment -->
    <div class="col-lg-6 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>Environment Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" id="btn-create-env" onclick="createEnvironment()">
                        <i class="fas fa-plus-circle me-2"></i>Create RAG Environment
                    </button>
                    <button class="btn btn-outline-info" id="btn-refresh-status" onclick="loadEnvStatus()">
                        <i class="fas fa-sync me-2"></i>Refresh Status
                    </button>
                    <button class="btn btn-outline-warning" id="btn-recreate-env" onclick="recreateEnvironment()">
                        <i class="fas fa-redo me-2"></i>Recreate Environment
                    </button>
                    <button class="btn btn-outline-danger" id="btn-delete-env" onclick="deleteEnvironment()">
                        <i class="fas fa-trash me-2"></i>Delete Environment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup & Restore -->
    <div class="col-lg-6 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-archive me-2"></i>Backup & Restore</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadBackups()">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-primary" onclick="createBackup()">
                        <i class="fas fa-save me-2"></i>Create Backup
                    </button>
                </div>
                
                <div id="backups-list">
                    <p class="text-muted text-center small">Loading backups...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Installed Packages -->
<div class="row">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-cubes me-2"></i>Installed Packages</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadPackages()">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="packages-list">
                    <p class="text-muted text-center">Loading packages...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Setup Progress Modal -->
<div class="modal fade" id="setupProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-cog fa-spin me-2"></i>Setting Up Provider</h5>
            </div>
            <div class="modal-body">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="setup-progress-text" class="mb-0">Installing packages...</p>
                    <p class="text-muted small mt-2">This may take several minutes</p>
                </div>
                <div class="progress mt-3">
                    <div id="setup-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let setupModal = null;

document.addEventListener('DOMContentLoaded', function() {
    setupModal = new bootstrap.Modal(document.getElementById('setupProgressModal'));
    loadEnvStatus();
    loadBackups();
});

function loadEnvStatus() {
    fetch('/rag/api/env/status')
        .then(response => response.json())
        .then(data => {
            updateStatusPanel(data);
            updateProviderCards(data);
            loadPackages();
        })
        .catch(err => {
            document.getElementById('env-status-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Failed to load status
                </div>
            `;
        });
}

function updateStatusPanel(data) {
    const statusHtml = `
        <div class="mb-3">
            <strong class="d-block mb-2">Environment:</strong>
            ${data.exists ? 
                '<span class="badge bg-success fs-6"><i class="fas fa-check me-1"></i>Created</span>' :
                '<span class="badge bg-warning fs-6"><i class="fas fa-times me-1"></i>Not Created</span>'
            }
        </div>
        <div class="mb-3">
            <strong class="d-block mb-2">Current Provider:</strong>
            <span class="badge bg-info fs-6">${data.current_provider || 'None'}</span>
        </div>
        <div class="mb-3">
            <strong class="d-block mb-2">Status:</strong>
            <span class="badge ${getStatusBadgeClass(data.status)} fs-6">${data.status || 'Unknown'}</span>
        </div>
        ${data.path ? `
            <div class="mb-0">
                <strong class="d-block mb-2">Path:</strong>
                <code class="small">${data.path}</code>
            </div>
        ` : ''}
    `;
    document.getElementById('env-status-content').innerHTML = statusHtml;
    
    // Update button states
    document.getElementById('btn-create-env').disabled = data.exists;
    document.getElementById('btn-delete-env').disabled = !data.exists;
    document.getElementById('btn-recreate-env').disabled = !data.exists;
}

function updateProviderCards(data) {
    const installedPkgs = data.installed_packages || [];
    
    // Check FAISS
    const faissInstalled = installedPkgs.some(p => p.toLowerCase().includes('faiss'));
    document.getElementById('faiss-badge').className = faissInstalled ? 'badge bg-success' : 'badge bg-warning';
    document.getElementById('faiss-badge').textContent = faissInstalled ? 'Installed' : 'Not Installed';
    document.getElementById('btn-setup-faiss').innerHTML = faissInstalled ? 
        '<i class="fas fa-check me-1"></i>FAISS Installed' : 
        '<i class="fas fa-download me-1"></i>Install FAISS';
    
    // Check ChromaDB
    const chromaInstalled = installedPkgs.some(p => p.toLowerCase().includes('chromadb'));
    document.getElementById('chromadb-badge').className = chromaInstalled ? 'badge bg-success' : 'badge bg-warning';
    document.getElementById('chromadb-badge').textContent = chromaInstalled ? 'Installed' : 'Not Installed';
    document.getElementById('btn-setup-chromadb').innerHTML = chromaInstalled ? 
        '<i class="fas fa-check me-1"></i>ChromaDB Installed' : 
        '<i class="fas fa-download me-1"></i>Install ChromaDB';
    
    // Active provider
    if (data.current_provider) {
        document.getElementById('active-provider-info').style.display = 'block';
        document.getElementById('active-provider-name').textContent = data.current_provider.toUpperCase();
    } else {
        document.getElementById('active-provider-info').style.display = 'none';
    }
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'ready': return 'bg-success';
        case 'created': return 'bg-info';
        case 'creating': return 'bg-warning';
        case 'error': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function createEnvironment() {
    if (!confirm('Create RAG virtual environment?')) return;
    
    const btn = document.getElementById('btn-create-env');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
    
    fetch('/rag/api/env/create', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Environment created successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to create environment', 'error');
            }
        })
        .catch(err => showToast('Error creating environment', 'error'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Create RAG Environment';
        });
}

function recreateEnvironment() {
    if (!confirm('Recreate RAG environment? This will delete and recreate the environment. All installed packages will be removed.')) return;
    
    const btn = document.getElementById('btn-recreate-env');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Recreating...';
    
    fetch('/rag/api/env/recreate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Environment recreated successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to recreate environment', 'error');
            }
        })
        .catch(err => showToast('Error recreating environment', 'error'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-redo me-2"></i>Recreate Environment';
        });
}

function deleteEnvironment() {
    if (!confirm('Delete RAG environment? This will remove all installed packages and RAG data.')) return;
    
    const btn = document.getElementById('btn-delete-env');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
    
    fetch('/rag/api/env/delete', { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Environment deleted successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to delete environment', 'error');
            }
        })
        .catch(err => showToast('Error deleting environment', 'error'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Environment';
        });
}

function setupProvider(provider) {
    const useGpu = provider === 'faiss' ? document.getElementById('faiss-gpu').checked : false;
    
    setupModal.show();
    let progress = 0;
    const progressBar = document.getElementById('setup-progress-bar');
    const progressText = document.getElementById('setup-progress-text');
    
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 10;
            progressBar.style.width = Math.min(progress, 90) + '%';
        }
    }, 1000);
    
    progressText.textContent = `Installing ${provider.toUpperCase()} packages...`;
    
    fetch('/rag/api/env/setup-provider', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider: provider, use_gpu: useGpu })
    })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                setupModal.hide();
                if (data.success) {
                    showToast(`${provider.toUpperCase()} installed successfully`, 'success');
                    loadEnvStatus();
                } else {
                    showToast(data.error || 'Failed to setup provider', 'error');
                }
            }, 500);
        })
        .catch(err => {
            clearInterval(progressInterval);
            setupModal.hide();
            showToast('Error setting up provider', 'error');
        });
}

function loadPackages() {
    fetch('/rag/api/env/packages')
        .then(response => response.json())
        .then(data => {
            const packages = data.packages || [];
            
            // Update additional component badges
            updatePackageBadges(packages);
            
            if (packages.length === 0) {
                document.getElementById('packages-list').innerHTML = 
                    '<p class="text-muted text-center">No packages installed</p>';
                return;
            }
            
            const html = `
                <div class="table-responsive">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Package</th>
                                <th>Version</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${packages.map(pkg => `
                                <tr>
                                    <td><code>${pkg.name || pkg}</code></td>
                                    <td>${pkg.version || '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-warning" onclick="reinstallPackage('${pkg.name || pkg}')" title="Reinstall">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('packages-list').innerHTML = html;
        })
        .catch(err => {
            document.getElementById('packages-list').innerHTML = 
                '<p class="text-danger">Failed to load packages</p>';
        });
}

function updatePackageBadges(packages) {
    const packageNames = packages.map(p => (p.name || p).toLowerCase());
    
    // APScheduler
    const apschedulerBadge = document.getElementById('apscheduler-badge');
    const apschedulerBtn = document.getElementById('btn-install-apscheduler');
    if (packageNames.includes('apscheduler')) {
        apschedulerBadge.className = 'badge bg-success';
        apschedulerBadge.textContent = 'Installed';
        apschedulerBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Reinstall';
        apschedulerBtn.className = 'btn btn-sm btn-outline-warning w-100';
    }
    
    // SQLAlchemy
    const sqlalchemyBadge = document.getElementById('sqlalchemy-badge');
    const sqlalchemyBtn = document.getElementById('btn-install-sqlalchemy');
    if (packageNames.includes('sqlalchemy')) {
        sqlalchemyBadge.className = 'badge bg-success';
        sqlalchemyBadge.textContent = 'Installed';
        sqlalchemyBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Reinstall';
        sqlalchemyBtn.className = 'btn btn-sm btn-outline-info w-100';
    }
    
    // PyPDF
    const pypdfBadge = document.getElementById('pypdf-badge');
    const pypdfBtn = document.getElementById('btn-install-pypdf');
    if (packageNames.includes('pypdf')) {
        pypdfBadge.className = 'badge bg-success';
        pypdfBadge.textContent = 'Installed';
        pypdfBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Reinstall';
    }
}

async function installPackage(packageName) {
    const btn = document.querySelector(`[onclick="installPackage('${packageName}')"]`);
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
        const response = await fetch(`/rag/api/env/install/${packageName}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            showToast(`${packageName} installed successfully`, 'success');
            loadPackages();
        } else {
            showToast(data.error || `Failed to install ${packageName}`, 'error');
        }
    } catch (err) {
        showToast(`Error installing ${packageName}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

async function reinstallPackage(packageName) {
    if (!confirm(`Reinstall ${packageName}?`)) return;
    
    try {
        const response = await fetch(`/rag/api/env/reinstall/${packageName}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            showToast(`${packageName} reinstalled successfully`, 'success');
            loadPackages();
        } else {
            showToast(data.error || `Failed to reinstall ${packageName}`, 'error');
        }
    } catch (err) {
        showToast(`Error reinstalling ${packageName}`, 'error');
    }
}

function loadBackups() {
    fetch('/rag/api/backup/list')
        .then(response => response.json())
        .then(data => {
            const backups = data.backups || [];
            if (backups.length === 0) {
                document.getElementById('backups-list').innerHTML = 
                    '<p class="text-muted text-center small">No backups found</p>';
                return;
            }
            
            const html = backups.slice(0, 5).map(backup => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-secondary rounded">
                    <div>
                        <small class="d-block">${backup.name}</small>
                        <small class="text-muted">${formatSize(backup.size)}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="restoreBackup('${backup.name}')" title="Restore">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backup.name}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('backups-list').innerHTML = html;
        })
        .catch(err => {
            document.getElementById('backups-list').innerHTML = 
                '<p class="text-danger small">Failed to load backups</p>';
        });
}

function createBackup() {
    fetch('/rag/api/backup/create', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Backup created: ' + data.backup_name, 'success');
                loadBackups();
            } else {
                showToast(data.error || 'Failed to create backup', 'error');
            }
        })
        .catch(err => showToast('Error creating backup', 'error'));
}

function restoreBackup(name) {
    if (!confirm(`Restore backup: ${name}? Current data will be overwritten.`)) return;
    
    fetch('/rag/api/backup/restore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ backup_name: name })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Backup restored successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to restore backup', 'error');
            }
        })
        .catch(err => showToast('Error restoring backup', 'error'));
}

function deleteBackup(name) {
    if (!confirm(`Delete backup: ${name}?`)) return;
    
    fetch('/rag/api/backup/delete', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ backup_name: name })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Backup deleted', 'success');
                loadBackups();
            } else {
                showToast(data.error || 'Failed to delete backup', 'error');
            }
        })
        .catch(err => showToast('Error deleting backup', 'error'));
}

function formatSize(bytes) {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
    }
    return bytes.toFixed(1) + ' ' + units[i];
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
