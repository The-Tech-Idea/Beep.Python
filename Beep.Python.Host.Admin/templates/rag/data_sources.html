{% extends "base.html" %}

{% block title %}Data Sources{% endblock %}

{% block extra_css %}
<style>
    .source-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .source-card:hover {
        border-color: #0d6efd !important;
    }
    .source-card.selected {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }
    .source-type-icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    .status-badge {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="fas fa-database me-2"></i>Data Sources</h1>
        <p class="text-muted mb-0">Connect databases, file systems, and APIs for RAG document sync</p>
    </div>
    <div>
        <a href="{{ url_for('rag.sync_jobs_page') }}" class="btn btn-outline-info me-2">
            <i class="fas fa-sync me-1"></i>Sync Jobs
        </a>
        <a href="{{ url_for('rag.dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to RAG
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Data Sources List -->
    <div class="col-lg-5 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-plug me-2"></i>Data Sources</h5>
                <button class="btn btn-sm btn-primary" onclick="showAddSourceModal()">
                    <i class="fas fa-plus me-1"></i>Add
                </button>
            </div>
            <div class="card-body p-0">
                <div id="sources-list" class="list-group list-group-flush">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 small mb-0">Loading data sources...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Source Details -->
    <div class="col-lg-7 mb-4">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Source Details
                    <span id="selected-source-name" class="text-muted small ms-2"></span>
                </h5>
                <div id="source-actions" style="display: none;">
                    <button class="btn btn-sm btn-success me-1" onclick="testSelectedSource()" title="Test Connection">
                        <i class="fas fa-plug"></i> Test
                    </button>
                    <button class="btn btn-sm btn-info me-1" onclick="previewSelectedSource()" title="Preview Documents">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button class="btn btn-sm btn-primary me-1" onclick="editSelectedSource()" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedSource()" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="source-details-content">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-arrow-left fa-2x mb-3"></i>
                        <p>Select a data source to view details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Data Source Modal -->
<div class="modal fade" id="sourceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="sourceModalTitle">
                    <i class="fas fa-plus-circle me-2"></i>Add Data Source
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="source-form">
                    <input type="hidden" id="source-id">
                    
                    <!-- Basic Info -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control bg-secondary border-0 text-white" 
                                   id="source-name" required placeholder="My Database">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Type *</label>
                            <select class="form-select bg-secondary border-0 text-white" id="source-type" 
                                    onchange="updateSourceTypeFields()">
                                <option value="">-- Select Type --</option>
                                <option value="sqlite">SQLite Database</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="mssql">SQL Server</option>
                                <option value="file_system">File System</option>
                                <option value="api">REST API</option>
                                <option value="csv">CSV Files</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control bg-secondary border-0 text-white" 
                               id="source-description" placeholder="Optional description">
                    </div>
                    
                    <!-- Database Fields -->
                    <div id="db-fields" style="display: none;">
                        <hr class="border-secondary">
                        <h6 class="text-muted mb-3"><i class="fas fa-database me-1"></i>Database Connection</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Host</label>
                                <input type="text" class="form-control bg-secondary border-0 text-white" 
                                       id="source-host" placeholder="localhost">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-control bg-secondary border-0 text-white" 
                                       id="source-port" placeholder="5432">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Database</label>
                                <input type="text" class="form-control bg-secondary border-0 text-white" 
                                       id="source-database" placeholder="database_name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control bg-secondary border-0 text-white" 
                                       id="source-username" placeholder="username">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control bg-secondary border-0 text-white" 
                                   id="source-password" placeholder="password">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">SQL Query *</label>
                            <textarea class="form-control bg-secondary border-0 text-white font-monospace" 
                                      id="source-query" rows="3" 
                                      placeholder="SELECT id, title, content FROM documents WHERE active = 1"></textarea>
                            <small class="text-muted">Query to fetch documents. Use column mapping below.</small>
                        </div>
                    </div>
                    
                    <!-- SQLite Fields -->
                    <div id="sqlite-fields" style="display: none;">
                        <hr class="border-secondary">
                        <h6 class="text-muted mb-3"><i class="fas fa-database me-1"></i>SQLite Database</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Database File Path *</label>
                            <input type="text" class="form-control bg-secondary border-0 text-white" 
                                   id="source-sqlite-path" placeholder="/path/to/database.db">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">SQL Query *</label>
                            <textarea class="form-control bg-secondary border-0 text-white font-monospace" 
                                      id="source-sqlite-query" rows="3" 
                                      placeholder="SELECT id, title, content FROM documents"></textarea>
                        </div>
                    </div>
                    
                    <!-- File System Fields -->
                    <div id="fs-fields" style="display: none;">
                        <hr class="border-secondary">
                        <h6 class="text-muted mb-3"><i class="fas fa-folder-open me-1"></i>File System</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Base Path *</label>
                            <input type="text" class="form-control bg-secondary border-0 text-white" 
                                   id="source-base-path" placeholder="/path/to/documents">
                            <small class="text-muted">Use forward slashes (/) for cross-platform compatibility</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">File Patterns</label>
                            <input type="text" class="form-control bg-secondary border-0 text-white" 
                                   id="source-patterns" placeholder="*.txt, *.md, *.pdf">
                            <small class="text-muted">Comma-separated glob patterns</small>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="source-recursive" checked>
                            <label class="form-check-label" for="source-recursive">
                                Include subdirectories (recursive)
                            </label>
                        </div>
                    </div>
                    
                    <!-- API Fields -->
                    <div id="api-fields" style="display: none;">
                        <hr class="border-secondary">
                        <h6 class="text-muted mb-3"><i class="fas fa-globe me-1"></i>REST API</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-9">
                                <label class="form-label">API URL *</label>
                                <input type="url" class="form-control bg-secondary border-0 text-white" 
                                       id="source-api-url" placeholder="https://api.example.com/documents">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Method</label>
                                <select class="form-select bg-secondary border-0 text-white" id="source-api-method">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Auth Type</label>
                                <select class="form-select bg-secondary border-0 text-white" id="source-api-auth">
                                    <option value="none">None</option>
                                    <option value="bearer">Bearer Token</option>
                                    <option value="api_key">API Key</option>
                                    <option value="basic">Basic Auth</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Auth Value</label>
                                <input type="password" class="form-control bg-secondary border-0 text-white" 
                                       id="source-api-auth-value" placeholder="Token or key">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Column Mapping (for DB and API) -->
                    <div id="column-mapping" style="display: none;">
                        <hr class="border-secondary">
                        <h6 class="text-muted mb-3"><i class="fas fa-columns me-1"></i>Column/Field Mapping</h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">ID Column</label>
                                <input type="text" class="form-control bg-secondary border-0 text-white" 
                                       id="source-id-column" placeholder="id">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Title Column</label>
                                <input type="text" class="form-control bg-secondary border-0 text-white" 
                                       id="source-title-column" placeholder="title">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Content Column *</label>
                                <input type="text" class="form-control bg-secondary border-0 text-white" 
                                       id="source-content-column" placeholder="content">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Target Collection -->
                    <hr class="border-secondary">
                    <h6 class="text-muted mb-3"><i class="fas fa-layer-group me-1"></i>Target Collection</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Collection</label>
                            <select class="form-select bg-secondary border-0 text-white" id="source-collection">
                                <option value="">-- Create New --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="source-auto-create" checked>
                                <label class="form-check-label" for="source-auto-create">Auto-create</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-info" onclick="testSourceFromForm()">
                    <i class="fas fa-plug me-1"></i>Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSource()">
                    <i class="fas fa-save me-1"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Document Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2">Loading preview...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedSourceId = null;
let sourceModal = null;
let previewModal = null;
let collections = [];

document.addEventListener('DOMContentLoaded', function() {
    sourceModal = new bootstrap.Modal(document.getElementById('sourceModal'));
    previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    loadDataSources();
    loadCollections();
});

function loadDataSources() {
    fetch('/rag/api/data-sources')
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('sources-list');
            
            if (!data.data_sources || data.data_sources.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-database fa-2x mb-2"></i>
                        <p class="mb-2">No data sources configured</p>
                        <button class="btn btn-sm btn-primary" onclick="showAddSourceModal()">
                            <i class="fas fa-plus me-1"></i>Add First Data Source
                        </button>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = data.data_sources.map(source => `
                <a href="#" class="list-group-item list-group-item-action bg-dark text-white border-secondary source-card"
                   onclick="selectSource(${source.id})" data-id="${source.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="${getSourceTypeIcon(source.source_type)} me-2"></i>
                            <strong>${source.name}</strong>
                            <small class="text-muted ms-2">${source.source_type}</small>
                        </div>
                        <span class="badge ${source.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${source.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    ${source.description ? `<small class="text-muted d-block mt-1">${source.description}</small>` : ''}
                </a>
            `).join('');
        })
        .catch(err => {
            document.getElementById('sources-list').innerHTML = 
                '<div class="text-danger p-3">Failed to load data sources</div>';
        });
}

function loadCollections() {
    fetch('/rag/api/collections')
        .then(response => response.json())
        .then(data => {
            collections = data.collections || [];
            updateCollectionDropdown();
        });
}

function updateCollectionDropdown() {
    const select = document.getElementById('source-collection');
    select.innerHTML = '<option value="">-- Create New --</option>' +
        collections.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function getSourceTypeIcon(type) {
    const icons = {
        'sqlite': 'fas fa-database text-info',
        'postgresql': 'fas fa-database text-primary',
        'mysql': 'fas fa-database text-warning',
        'mssql': 'fas fa-database text-danger',
        'file_system': 'fas fa-folder-open text-success',
        'api': 'fas fa-globe text-purple',
        'csv': 'fas fa-file-csv text-info'
    };
    return icons[type] || 'fas fa-plug';
}

function selectSource(sourceId) {
    selectedSourceId = sourceId;
    
    // Update selection UI
    document.querySelectorAll('.source-card').forEach(el => el.classList.remove('selected'));
    document.querySelector(`.source-card[data-id="${sourceId}"]`)?.classList.add('selected');
    
    document.getElementById('source-actions').style.display = 'block';
    
    loadSourceDetails(sourceId);
}

function loadSourceDetails(sourceId) {
    const content = document.getElementById('source-details-content');
    content.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>';
    
    fetch(`/rag/api/data-sources/${sourceId}`)
        .then(response => response.json())
        .then(data => {
            const source = data.data_source;
            document.getElementById('selected-source-name').textContent = `(${source.name})`;
            
            let detailsHtml = `
                <table class="table table-dark table-sm">
                    <tr><th width="30%">Name</th><td>${source.name}</td></tr>
                    <tr><th>Type</th><td><i class="${getSourceTypeIcon(source.source_type)} me-1"></i>${source.source_type}</td></tr>
                    <tr><th>Description</th><td>${source.description || '-'}</td></tr>
                    <tr><th>Status</th><td><span class="badge ${source.is_active ? 'bg-success' : 'bg-secondary'}">${source.is_active ? 'Active' : 'Inactive'}</span></td></tr>
            `;
            
            if (['postgresql', 'mysql', 'mssql'].includes(source.source_type)) {
                detailsHtml += `
                    <tr><th>Host</th><td>${source.host || 'localhost'}:${source.port || 'default'}</td></tr>
                    <tr><th>Database</th><td>${source.database || '-'}</td></tr>
                `;
            }
            
            if (source.source_type === 'sqlite') {
                detailsHtml += `
                    <tr><th>Database Path</th><td><code>${source.database || '-'}</code></td></tr>
                `;
            }
            
            if (source.source_type === 'file_system') {
                detailsHtml += `
                    <tr><th>Base Path</th><td><code>${source.base_path || '-'}</code></td></tr>
                    <tr><th>Patterns</th><td>${(source.file_patterns || []).join(', ') || '*.*'}</td></tr>
                    <tr><th>Recursive</th><td>${source.recursive ? 'Yes' : 'No'}</td></tr>
                `;
            }
            
            if (source.source_type === 'api') {
                detailsHtml += `
                    <tr><th>API URL</th><td><code>${source.api_url || '-'}</code></td></tr>
                    <tr><th>Method</th><td>${source.api_method || 'GET'}</td></tr>
                    <tr><th>Auth</th><td>${source.api_auth_type || 'None'}</td></tr>
                `;
            }
            
            if (source.query) {
                detailsHtml += `
                    <tr><th>Query</th><td><pre class="bg-secondary p-2 rounded mb-0 small">${source.query}</pre></td></tr>
                `;
            }
            
            if (source.content_column) {
                detailsHtml += `
                    <tr><th>Column Mapping</th><td>ID: ${source.id_column || '-'}, Title: ${source.title_column || '-'}, Content: ${source.content_column}</td></tr>
                `;
            }
            
            detailsHtml += `
                    <tr><th>Target Collection</th><td>${source.target_collection_id || 'Auto-create'}</td></tr>
                    <tr><th>Created</th><td>${formatDate(source.created_at)}</td></tr>
                </table>
            `;
            
            // Add quick actions
            detailsHtml += `
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="createSyncJobFromSource(${sourceId})">
                        <i class="fas fa-sync me-1"></i>Create Sync Job
                    </button>
                </div>
            `;
            
            content.innerHTML = detailsHtml;
        })
        .catch(err => {
            content.innerHTML = '<div class="text-danger">Failed to load source details</div>';
        });
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleString();
}

function showAddSourceModal() {
    document.getElementById('sourceModalTitle').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add Data Source';
    document.getElementById('source-form').reset();
    document.getElementById('source-id').value = '';
    updateSourceTypeFields();
    sourceModal.show();
}

function editSelectedSource() {
    if (!selectedSourceId) return;
    
    fetch(`/rag/api/data-sources/${selectedSourceId}`)
        .then(response => response.json())
        .then(data => {
            const source = data.data_source;
            
            document.getElementById('sourceModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Data Source';
            document.getElementById('source-id').value = source.id;
            document.getElementById('source-name').value = source.name;
            document.getElementById('source-type').value = source.source_type;
            document.getElementById('source-description').value = source.description || '';
            
            updateSourceTypeFields();
            
            // Fill in type-specific fields
            if (['postgresql', 'mysql', 'mssql'].includes(source.source_type)) {
                document.getElementById('source-host').value = source.host || '';
                document.getElementById('source-port').value = source.port || '';
                document.getElementById('source-database').value = source.database || '';
                document.getElementById('source-username').value = source.username || '';
                document.getElementById('source-query').value = source.query || '';
            }
            
            if (source.source_type === 'sqlite') {
                document.getElementById('source-sqlite-path').value = source.database || '';
                document.getElementById('source-sqlite-query').value = source.query || '';
            }
            
            if (source.source_type === 'file_system' || source.source_type === 'csv') {
                document.getElementById('source-base-path').value = source.base_path || '';
                document.getElementById('source-patterns').value = (source.file_patterns || []).join(', ');
                document.getElementById('source-recursive').checked = source.recursive !== false;
            }
            
            if (source.source_type === 'api') {
                document.getElementById('source-api-url').value = source.api_url || '';
                document.getElementById('source-api-method').value = source.api_method || 'GET';
                document.getElementById('source-api-auth').value = source.api_auth_type || 'none';
            }
            
            document.getElementById('source-id-column').value = source.id_column || '';
            document.getElementById('source-title-column').value = source.title_column || '';
            document.getElementById('source-content-column').value = source.content_column || '';
            document.getElementById('source-collection').value = source.target_collection_id || '';
            document.getElementById('source-auto-create').checked = source.auto_create_collection !== false;
            
            sourceModal.show();
        });
}

function updateSourceTypeFields() {
    const type = document.getElementById('source-type').value;
    
    // Hide all type-specific fields
    document.getElementById('db-fields').style.display = 'none';
    document.getElementById('sqlite-fields').style.display = 'none';
    document.getElementById('fs-fields').style.display = 'none';
    document.getElementById('api-fields').style.display = 'none';
    document.getElementById('column-mapping').style.display = 'none';
    
    // Show relevant fields
    if (['postgresql', 'mysql', 'mssql'].includes(type)) {
        document.getElementById('db-fields').style.display = 'block';
        document.getElementById('column-mapping').style.display = 'block';
    } else if (type === 'sqlite') {
        document.getElementById('sqlite-fields').style.display = 'block';
        document.getElementById('column-mapping').style.display = 'block';
    } else if (type === 'file_system' || type === 'csv') {
        document.getElementById('fs-fields').style.display = 'block';
        if (type === 'csv') {
            document.getElementById('column-mapping').style.display = 'block';
        }
    } else if (type === 'api') {
        document.getElementById('api-fields').style.display = 'block';
        document.getElementById('column-mapping').style.display = 'block';
    }
}

function saveSource() {
    const sourceId = document.getElementById('source-id').value;
    const type = document.getElementById('source-type').value;
    
    if (!document.getElementById('source-name').value || !type) {
        alert('Name and type are required');
        return;
    }
    
    const data = {
        name: document.getElementById('source-name').value,
        source_type: type,
        description: document.getElementById('source-description').value,
        target_collection_id: document.getElementById('source-collection').value || null,
        auto_create_collection: document.getElementById('source-auto-create').checked,
        id_column: document.getElementById('source-id-column').value || null,
        title_column: document.getElementById('source-title-column').value || null,
        content_column: document.getElementById('source-content-column').value || null
    };
    
    // Type-specific fields
    if (['postgresql', 'mysql', 'mssql'].includes(type)) {
        data.host = document.getElementById('source-host').value;
        data.port = parseInt(document.getElementById('source-port').value) || null;
        data.database = document.getElementById('source-database').value;
        data.username = document.getElementById('source-username').value;
        data.password = document.getElementById('source-password').value;
        data.query = document.getElementById('source-query').value;
    } else if (type === 'sqlite') {
        data.database = document.getElementById('source-sqlite-path').value;
        data.query = document.getElementById('source-sqlite-query').value;
    } else if (type === 'file_system' || type === 'csv') {
        data.base_path = document.getElementById('source-base-path').value;
        data.file_patterns = document.getElementById('source-patterns').value
            .split(',').map(p => p.trim()).filter(p => p);
        data.recursive = document.getElementById('source-recursive').checked;
    } else if (type === 'api') {
        data.api_url = document.getElementById('source-api-url').value;
        data.api_method = document.getElementById('source-api-method').value;
        data.api_auth_type = document.getElementById('source-api-auth').value;
        data.api_auth_value = document.getElementById('source-api-auth-value').value;
    }
    
    const url = sourceId ? `/rag/api/data-sources/${sourceId}` : '/rag/api/data-sources';
    const method = sourceId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            sourceModal.hide();
            loadDataSources();
            if (result.id) {
                selectSource(result.id);
            }
        } else {
            alert('Error: ' + (result.error || 'Failed to save'));
        }
    })
    .catch(err => alert('Error: ' + err.message));
}

function deleteSelectedSource() {
    if (!selectedSourceId) return;
    
    if (!confirm('Delete this data source? This will also delete associated sync jobs.')) return;
    
    fetch(`/rag/api/data-sources/${selectedSourceId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                selectedSourceId = null;
                document.getElementById('source-actions').style.display = 'none';
                document.getElementById('source-details-content').innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-arrow-left fa-2x mb-3"></i>
                        <p>Select a data source to view details</p>
                    </div>
                `;
                loadDataSources();
            } else {
                alert('Error: ' + (result.error || 'Failed to delete'));
            }
        });
}

function testSelectedSource() {
    if (!selectedSourceId) return;
    
    const content = document.getElementById('source-details-content');
    const originalContent = content.innerHTML;
    content.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Testing connection...</p></div>';
    
    fetch(`/rag/api/data-sources/${selectedSourceId}/test`, { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            const alertClass = result.success ? 'alert-success' : 'alert-danger';
            const icon = result.success ? 'check-circle' : 'exclamation-triangle';
            
            content.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas fa-${icon} me-2"></i>
                    <strong>${result.success ? 'Connection Successful!' : 'Connection Failed'}</strong>
                    <p class="mb-0 mt-1">${result.result?.message || ''}</p>
                </div>
            ` + originalContent;
        })
        .catch(err => {
            content.innerHTML = `<div class="alert alert-danger">Test failed: ${err.message}</div>` + originalContent;
        });
}

function previewSelectedSource() {
    if (!selectedSourceId) return;
    
    document.getElementById('preview-content').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Loading preview...</p>
        </div>
    `;
    previewModal.show();
    
    fetch(`/rag/api/data-sources/${selectedSourceId}/preview`, { method: 'POST' })
        .then(response => response.json())
        .then(result => {
            if (!result.success) {
                document.getElementById('preview-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>${result.error || 'Preview failed'}
                    </div>
                `;
                return;
            }
            
            if (result.documents.length === 0) {
                document.getElementById('preview-content').innerHTML = `
                    <div class="alert alert-warning">No documents found from this source.</div>
                `;
                return;
            }
            
            document.getElementById('preview-content').innerHTML = `
                <p class="text-muted">Showing ${result.count} of total documents</p>
                <div class="accordion" id="previewAccordion">
                    ${result.documents.map((doc, i) => `
                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button ${i > 0 ? 'collapsed' : ''} bg-dark text-white" 
                                        type="button" data-bs-toggle="collapse" data-bs-target="#doc${i}">
                                    <strong>${doc.title || 'Untitled'}</strong>
                                    <small class="text-muted ms-2">${doc.source || ''}</small>
                                </button>
                            </h2>
                            <div id="doc${i}" class="accordion-collapse collapse ${i === 0 ? 'show' : ''}" 
                                 data-bs-parent="#previewAccordion">
                                <div class="accordion-body">
                                    <pre class="bg-secondary p-3 rounded small" style="white-space: pre-wrap;">${doc.content_preview}</pre>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        })
        .catch(err => {
            document.getElementById('preview-content').innerHTML = `
                <div class="alert alert-danger">Error: ${err.message}</div>
            `;
        });
}

function createSyncJobFromSource(sourceId) {
    // Redirect to sync jobs page with source pre-selected
    window.location.href = `/rag/sync-jobs?source=${sourceId}`;
}

function testSourceFromForm() {
    // This would test the connection using form values before saving
    alert('Please save the data source first, then use the Test button.');
}
</script>
{% endblock %}
