{% extends "base.html" %}

{% block title %}Test RAG Query - Python Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-search me-2"></i>Test RAG Query</h2>
    <a href="{{ url_for('rag.rag_dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back
    </a>
</div>

{% if not settings.enabled or not settings.external_api %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>RAG is not configured.
    <a href="{{ url_for('rag.rag_configure') }}" class="alert-link">Configure RAG first</a>
</div>
{% endif %}

<!-- Query Form -->
<div class="card bg-dark mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-chat-text me-2"></i>Query Context</h5>
    </div>
    <div class="card-body">
        <form id="queryForm">
            <div class="mb-3">
                <label class="form-label">Query</label>
                <textarea class="form-control bg-dark text-light" id="query" rows="3"
                          placeholder="Enter a question or query to retrieve relevant context..."></textarea>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Collection</label>
                    <select class="form-select bg-dark text-light" id="collectionId">
                        <option value="">All Collections</option>
                        {% for coll in collections %}
                        <option value="{{ coll.id }}">{{ coll.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Max Results</label>
                    <input type="number" class="form-control bg-dark text-light" id="maxResults"
                           value="5" min="1" max="20">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">User ID (for auth test)</label>
                    <input type="text" class="form-control bg-dark text-light" id="userId"
                           placeholder="Optional">
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search me-1"></i>Search Context
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearResults()">
                    <i class="bi bi-x-circle me-1"></i>Clear
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results -->
<div id="resultsSection" class="d-none">
    <!-- Stats -->
    <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        Found <strong id="resultCount">0</strong> relevant context(s)
    </div>
    
    <!-- Context Cards -->
    <div id="contextCards" class="mb-4"></div>
    
    <!-- Formatted Prompt -->
    <div class="card bg-dark mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Formatted Prompt</h5>
            <button class="btn btn-sm btn-outline-light" onclick="copyPrompt()">
                <i class="bi bi-clipboard me-1"></i>Copy
            </button>
        </div>
        <div class="card-body">
            <pre id="formattedPrompt" class="bg-black p-3 rounded text-light" style="white-space: pre-wrap;"></pre>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loadingSection" class="d-none text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Searching...</span>
    </div>
    <p class="mt-2 text-muted">Retrieving context from external API...</p>
</div>

<!-- Error -->
<div id="errorSection" class="d-none">
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span id="errorMessage"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('queryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const query = document.getElementById('query').value.trim();
    if (!query) {
        alert('Please enter a query');
        return;
    }
    
    // Show loading
    document.getElementById('resultsSection').classList.add('d-none');
    document.getElementById('errorSection').classList.add('d-none');
    document.getElementById('loadingSection').classList.remove('d-none');
    
    const payload = {
        query: query,
        max_results: parseInt(document.getElementById('maxResults').value)
    };
    
    const collectionId = document.getElementById('collectionId').value;
    if (collectionId) {
        payload.collection_ids = [collectionId];
    }
    
    const userId = document.getElementById('userId').value.trim();
    if (userId) {
        payload.user_id = userId;
    }
    
    fetch('/rag/api/query', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || data.reason || 'Request failed');
            });
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('loadingSection').classList.add('d-none');
        displayResults(data);
    })
    .catch(error => {
        document.getElementById('loadingSection').classList.add('d-none');
        document.getElementById('errorSection').classList.remove('d-none');
        document.getElementById('errorMessage').textContent = error.message;
    });
});

function displayResults(data) {
    const resultsSection = document.getElementById('resultsSection');
    const contextCards = document.getElementById('contextCards');
    
    // Update count
    document.getElementById('resultCount').textContent = data.count || 0;
    
    // Build context cards
    contextCards.innerHTML = '';
    
    if (data.contexts && data.contexts.length > 0) {
        data.contexts.forEach((ctx, idx) => {
            const card = document.createElement('div');
            card.className = 'card bg-dark mb-3';
            card.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-file-earmark-text text-primary me-2"></i>
                        <strong>${ctx.source}</strong>
                    </span>
                    <span class="badge bg-success">Score: ${(ctx.relevance_score * 100).toFixed(1)}%</span>
                </div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">${escapeHtml(ctx.content)}</p>
                    ${ctx.metadata && Object.keys(ctx.metadata).length > 0 ? 
                        `<small class="text-muted d-block mt-2">Metadata: ${JSON.stringify(ctx.metadata)}</small>` : ''}
                </div>
            `;
            contextCards.appendChild(card);
        });
    } else {
        contextCards.innerHTML = '<div class="text-center text-muted py-4">No relevant context found</div>';
    }
    
    // Display formatted prompt
    document.getElementById('formattedPrompt').textContent = data.formatted_prompt || '(No context to inject)';
    
    resultsSection.classList.remove('d-none');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearResults() {
    document.getElementById('query').value = '';
    document.getElementById('resultsSection').classList.add('d-none');
    document.getElementById('errorSection').classList.add('d-none');
}

function copyPrompt() {
    const text = document.getElementById('formattedPrompt').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
    });
}

// Check URL params for collection
const urlParams = new URLSearchParams(window.location.search);
const collParam = urlParams.get('collection');
if (collParam) {
    document.getElementById('collectionId').value = collParam;
}
</script>
{% endblock %}
