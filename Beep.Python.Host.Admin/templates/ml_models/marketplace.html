{% extends "base.html" %}

{% block title %}Model Marketplace - Beep AI Server{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' or category == 'danger' else 'info-circle' if category == 'info' else 'check-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('ml_models.index') }}">ML Models</a></li>
                    <li class="breadcrumb-item active">Marketplace</li>
                </ol>
            </nav>
            <h1><i class="bi bi-shop me-3"></i>Model Marketplace</h1>
            <p class="text-muted mb-0">Discover and use public ML models shared by the community</p>
        </div>
        <a href="{{ url_for('ml_models.index') }}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left me-2"></i>Back
        </a>
    </div>
</div>

<!-- Search and Filters -->
<div class="card mb-4 animate-fade-in">
    <div class="card-body">
        <form method="GET" action="{{ url_for('ml_models.marketplace') }}" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search_term }}" placeholder="Search models...">
            </div>
            <div class="col-md-3">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" name="category">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat == current_category %}selected{% endif %}>{{ cat|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="sort" class="form-label">Sort By</label>
                <select class="form-select" id="sort" name="sort">
                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Newest</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                    <option value="popularity" {% if sort_by == 'popularity' %}selected{% endif %}>Popularity</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>Search
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Models Grid -->
{% if models %}
<div class="row g-4">
    {% for model in models %}
    <div class="col-md-6 col-lg-4 animate-fade-in">
        <div class="card h-100 model-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">
                        <a href="{{ url_for('ml_models.model_detail', model_id=model.id) }}" class="text-decoration-none">
                            {{ model.name }}
                        </a>
                    </h5>
                    {% if model.validation_status == 'passed' %}
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> Validated
                    </span>
                    {% endif %}
                </div>
                
                <p class="text-muted small mb-2">
                    {{ model.description[:100] if model.description else 'No description' }}{% if model.description and model.description|length > 100 %}...{% endif %}
                </p>
                
                <div class="mb-2">
                    <span class="badge bg-secondary">{{ model.model_type }}</span>
                    {% if model.framework %}
                    <span class="badge bg-info">{{ model.framework }}</span>
                    {% endif %}
                    {% if model.category %}
                    <span class="badge bg-primary">{{ model.category|title }}</span>
                    {% endif %}
                </div>
                
                {% if model.tags_list %}
                <div class="mb-2">
                    {% for tag in model.tags_list[:3] %}
                    <span class="badge bg-outline-secondary me-1">{{ tag }}</span>
                    {% endfor %}
                    {% if model.tags_list|length > 3 %}
                    <span class="text-muted small">+{{ model.tags_list|length - 3 }} more</span>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center mt-auto">
                    <small class="text-muted">
                        <i class="bi bi-person me-1"></i>{{ model.owner.username if model.owner else 'Unknown' }}
                    </small>
                    <small class="text-muted">
                        <i class="bi bi-calendar me-1"></i>{{ model.created_at[:10] if model.created_at else 'N/A' }}
                    </small>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="{{ url_for('ml_models.model_detail', model_id=model.id) }}" class="btn btn-sm btn-primary w-100">
                    <i class="bi bi-eye me-1"></i>View Details
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card animate-fade-in">
    <div class="card-body text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: rgba(255,255,255,0.3);"></i>
        <p class="text-muted mt-3">
            {% if search_term or current_category %}
            No models found matching your criteria. Try adjusting your search or filters.
            {% else %}
            No public models available yet. Be the first to share a model!
            {% endif %}
        </p>
        <a href="{{ url_for('ml_models.upload_page') }}" class="btn btn-primary">
            <i class="bi bi-upload me-2"></i>Upload Your First Model
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

