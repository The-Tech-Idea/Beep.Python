{% extends "base.html" %}

{% block title %}ML Environment Management - Beep AI Server{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' or category == 'danger' else 'info-circle' if category == 'info' else 'check-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('ml_models.index') }}">ML Models</a></li>
                    <li class="breadcrumb-item active">Environment</li>
                </ol>
            </nav>
            <h1><i class="bi bi-box-seam me-3"></i>ML Environment Management</h1>
            <p class="text-muted mb-0">Create, configure, and manage ML virtual environment (uses EnvironmentManager)</p>
        </div>
        <a href="{{ url_for('ml_models.index') }}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left me-2"></i>Back to ML Models
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- Environment Status Panel -->
    <div class="col-lg-4">
        <div class="card animate-fade-in h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Environment Status</h5>
            </div>
            <div class="card-body" id="env-status-content">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Checking environment...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Framework Setup Panel -->
    <div class="col-lg-8">
        <div class="card animate-fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>ML Framework Setup</h5>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-4">
                    <!-- Scikit-Learn -->
                    <div class="col-md-6">
                        <div class="card bg-dark h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-diagram-3 me-2 text-info"></i>Scikit-Learn
                                    </h6>
                                    <span class="badge bg-warning" id="sklearn-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted">
                                    Machine learning library for classification, regression, clustering
                                </p>
                                <button class="btn btn-primary w-100" id="btn-setup-sklearn" onclick="installFramework('sklearn')">
                                    <i class="bi bi-download me-1"></i>Install Scikit-Learn
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- XGBoost -->
                    <div class="col-md-6">
                        <div class="card bg-dark h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-tree me-2 text-success"></i>XGBoost
                                    </h6>
                                    <span class="badge bg-warning" id="xgboost-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted">
                                    Gradient boosting framework for high-performance ML
                                </p>
                                <button class="btn btn-primary w-100" id="btn-setup-xgboost" onclick="installFramework('xgboost')">
                                    <i class="bi bi-download me-1"></i>Install XGBoost
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TensorFlow -->
                    <div class="col-md-6">
                        <div class="card bg-dark h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-cpu me-2 text-warning"></i>TensorFlow
                                    </h6>
                                    <span class="badge bg-warning" id="tensorflow-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted">
                                    Deep learning framework by Google
                                </p>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="tensorflow-gpu">
                                    <label class="form-check-label small" for="tensorflow-gpu">
                                        Enable GPU Support (CUDA required)
                                    </label>
                                </div>
                                <button class="btn btn-primary w-100" id="btn-setup-tensorflow" onclick="installFramework('tensorflow')">
                                    <i class="bi bi-download me-1"></i>Install TensorFlow
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PyTorch -->
                    <div class="col-md-6">
                        <div class="card bg-dark h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-fire me-2 text-danger"></i>PyTorch
                                    </h6>
                                    <span class="badge bg-warning" id="pytorch-badge">Not Installed</span>
                                </div>
                                <p class="card-text small text-muted">
                                    Deep learning framework by Meta
                                </p>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="pytorch-gpu">
                                    <label class="form-check-label small" for="pytorch-gpu">
                                        Enable GPU Support (CUDA required)
                                    </label>
                                </div>
                                <button class="btn btn-primary w-100" id="btn-setup-pytorch" onclick="installFramework('pytorch')">
                                    <i class="bi bi-download me-1"></i>Install PyTorch
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Components -->
                <h6 class="text-muted mb-3"><i class="bi bi-puzzle me-2"></i>Additional Components</h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 small">
                                        <i class="bi bi-calculator me-2 text-info"></i>ONNX Runtime
                                    </h6>
                                    <span class="badge bg-warning" id="onnx-badge">Not Installed</span>
                                </div>
                                <button class="btn btn-sm btn-outline-info w-100" onclick="installFramework('onnxruntime')">
                                    <i class="bi bi-download me-1"></i>Install
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 small">
                                        <i class="bi bi-lightning me-2 text-warning"></i>LightGBM
                                    </h6>
                                    <span class="badge bg-warning" id="lightgbm-badge">Not Installed</span>
                                </div>
                                <button class="btn btn-sm btn-outline-warning w-100" onclick="installFramework('lightgbm')">
                                    <i class="bi bi-download me-1"></i>Install
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 small">
                                        <i class="bi bi-archive me-2 text-success"></i>Joblib
                                    </h6>
                                    <span class="badge bg-warning" id="joblib-badge">Not Installed</span>
                                </div>
                                <button class="btn btn-sm btn-outline-success w-100" onclick="installFramework('joblib')">
                                    <i class="bi bi-download me-1"></i>Install
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Environment Actions Row -->
<div class="row g-4 mt-2">
    <div class="col-lg-6">
        <div class="card animate-fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>Environment Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" id="btn-create-env" onclick="createEnvironment()">
                        <i class="bi bi-plus-circle me-2"></i>Create ML Environment
                    </button>
                    <button class="btn btn-primary" id="btn-install-all" onclick="installAllRequired()">
                        <i class="bi bi-download me-2"></i>Install All Required Packages
                    </button>
                    <button class="btn btn-outline-info" id="btn-refresh-status" onclick="loadEnvStatus()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh Status
                    </button>
                    <button class="btn btn-outline-warning" id="btn-recreate-env" onclick="recreateEnvironment()">
                        <i class="bi bi-arrow-repeat me-2"></i>Recreate Environment
                    </button>
                    <button class="btn btn-outline-danger" id="btn-delete-env" onclick="deleteEnvironment()">
                        <i class="bi bi-trash me-2"></i>Delete Environment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Installed Packages -->
    <div class="col-lg-6">
        <div class="card animate-fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-boxes me-2"></i>Installed Packages</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadPackages()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="packages-list">
                    <p class="text-muted text-center">Loading packages...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Setup Progress Modal -->
<div class="modal fade" id="setupProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear-wide-connected me-2 spin-animation"></i>Setting Up</h5>
            </div>
            <div class="modal-body">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="setup-progress-text" class="mb-0">Installing packages...</p>
                    <p class="text-muted small mt-2">This may take several minutes</p>
                </div>
                <div class="progress mt-3">
                    <div id="setup-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.spin-animation {
    animation: spin 2s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let setupModal = null;

document.addEventListener('DOMContentLoaded', function() {
    setupModal = new bootstrap.Modal(document.getElementById('setupProgressModal'));
    loadEnvStatus();
});

function loadEnvStatus() {
    fetch('/api/v1/ml-models/env/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatusPanel(data.data);
                updateFrameworkBadges(data.data);
                loadPackages();
            } else {
                document.getElementById('env-status-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>${data.error || 'Failed to load status'}
                    </div>
                `;
            }
        })
        .catch(err => {
            document.getElementById('env-status-content').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Failed to load status
                </div>
            `;
        });
}

function updateStatusPanel(data) {
    const statusHtml = `
        <div class="mb-3">
            <strong class="d-block mb-2">Environment:</strong>
            ${data.exists ? 
                '<span class="badge bg-success fs-6"><i class="bi bi-check me-1"></i>Created</span>' :
                '<span class="badge bg-warning fs-6"><i class="bi bi-x me-1"></i>Not Created</span>'
            }
        </div>
        <div class="mb-3">
            <strong class="d-block mb-2">Status:</strong>
            <span class="badge ${getStatusBadgeClass(data.status)} fs-6">${data.status || 'Unknown'}</span>
        </div>
        ${data.env_path ? `
            <div class="mb-3">
                <strong class="d-block mb-2">Environment Name:</strong>
                <code class="small">${data.env_name || 'ml_models_env'}</code>
            </div>
            <div class="mb-0">
                <strong class="d-block mb-2">Path:</strong>
                <code class="small text-break">${data.env_path}</code>
            </div>
        ` : ''}
        ${data.error ? `
            <div class="alert alert-danger mt-3 mb-0">
                <small><strong>Error:</strong> ${data.error}</small>
            </div>
        ` : ''}
    `;
    document.getElementById('env-status-content').innerHTML = statusHtml;
    
    // Update button states
    document.getElementById('btn-create-env').disabled = data.exists;
    document.getElementById('btn-delete-env').disabled = !data.exists;
    document.getElementById('btn-recreate-env').disabled = !data.exists;
    document.getElementById('btn-install-all').disabled = !data.exists;
}

function updateFrameworkBadges(data) {
    const packages = data.installed_packages || [];
    const packageNames = packages.map(p => p.toLowerCase().split('>=')[0].split('==')[0]);
    
    // Check each framework
    const frameworks = {
        'sklearn': ['scikit-learn', 'sklearn'],
        'xgboost': ['xgboost'],
        'tensorflow': ['tensorflow', 'tensorflow-gpu'],
        'pytorch': ['torch', 'pytorch'],
        'onnx': ['onnxruntime', 'onnx'],
        'lightgbm': ['lightgbm'],
        'joblib': ['joblib']
    };
    
    for (const [id, names] of Object.entries(frameworks)) {
        const badge = document.getElementById(`${id}-badge`);
        const btn = document.getElementById(`btn-setup-${id}`);
        const installed = names.some(name => packageNames.some(p => p.includes(name)));
        
        if (badge) {
            badge.className = installed ? 'badge bg-success' : 'badge bg-warning';
            badge.textContent = installed ? 'Installed' : 'Not Installed';
        }
        if (btn) {
            btn.innerHTML = installed ? 
                `<i class="bi bi-check me-1"></i>${id.charAt(0).toUpperCase() + id.slice(1)} Installed` : 
                `<i class="bi bi-download me-1"></i>Install ${id.charAt(0).toUpperCase() + id.slice(1)}`;
        }
    }
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'ready': return 'bg-success';
        case 'created': return 'bg-info';
        case 'creating': return 'bg-warning';
        case 'error': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function createEnvironment() {
    if (!confirm('Create ML virtual environment?')) return;
    
    const btn = document.getElementById('btn-create-env');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
    
    fetch('/api/v1/ml-models/env/create', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Environment created successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to create environment', 'danger');
            }
        })
        .catch(err => showToast('Error creating environment', 'danger'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Create ML Environment';
        });
}

function recreateEnvironment() {
    if (!confirm('Recreate ML environment? This will delete and recreate the environment. All installed packages will be removed.')) return;
    
    const btn = document.getElementById('btn-recreate-env');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Recreating...';
    
    fetch('/api/v1/ml-models/env/recreate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Environment recreated successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to recreate environment', 'danger');
            }
        })
        .catch(err => showToast('Error recreating environment', 'danger'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Recreate Environment';
        });
}

function deleteEnvironment() {
    if (!confirm('Delete ML environment? This will remove all installed packages.')) return;
    
    const btn = document.getElementById('btn-delete-env');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
    
    fetch('/api/v1/ml-models/env/delete', { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Environment deleted successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to delete environment', 'danger');
            }
        })
        .catch(err => showToast('Error deleting environment', 'danger'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash me-2"></i>Delete Environment';
        });
}

function installAllRequired() {
    if (!confirm('Install all required ML packages (numpy, scipy, pandas, scikit-learn, joblib)? This may take several minutes.')) return;
    
    showProgress('Installing required packages...');
    
    fetch('/api/v1/ml-models/env/install-required', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
        .then(response => response.json())
        .then(data => {
            hideProgress();
            if (data.success) {
                showToast('Required packages installed successfully', 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || 'Failed to install packages', 'danger');
            }
        })
        .catch(err => {
            hideProgress();
            showToast('Error installing packages', 'danger');
        });
}

function installFramework(framework) {
    const useGpu = (framework === 'tensorflow' && document.getElementById('tensorflow-gpu')?.checked) ||
                   (framework === 'pytorch' && document.getElementById('pytorch-gpu')?.checked);
    
    showProgress(`Installing ${framework}...`);
    
    fetch('/api/v1/ml-models/env/install-framework', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ framework: framework, use_gpu: useGpu })
    })
        .then(response => response.json())
        .then(data => {
            hideProgress();
            if (data.success) {
                showToast(`${framework} installed successfully`, 'success');
                loadEnvStatus();
            } else {
                showToast(data.error || `Failed to install ${framework}`, 'danger');
            }
        })
        .catch(err => {
            hideProgress();
            showToast(`Error installing ${framework}`, 'danger');
        });
}

function loadPackages() {
    fetch('/api/v1/ml-models/env/packages')
        .then(response => response.json())
        .then(data => {
            const packages = data.packages || data.data?.installed_packages || [];
            
            if (packages.length === 0) {
                document.getElementById('packages-list').innerHTML = 
                    '<p class="text-muted text-center">No packages installed</p>';
                return;
            }
            
            const html = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Package</th>
                                <th>Version</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${packages.map(pkg => {
                                const parts = (typeof pkg === 'string') ? pkg.split('==') : [pkg.name, pkg.version];
                                return `
                                    <tr>
                                        <td><code>${parts[0]}</code></td>
                                        <td><small class="text-muted">${parts[1] || '-'}</small></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('packages-list').innerHTML = html;
        })
        .catch(err => {
            document.getElementById('packages-list').innerHTML = 
                '<p class="text-danger">Failed to load packages</p>';
        });
}

function showProgress(message) {
    document.getElementById('setup-progress-text').textContent = message;
    document.getElementById('setup-progress-bar').style.width = '0%';
    setupModal.show();
    
    // Animate progress
    let progress = 0;
    window.progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 10;
            document.getElementById('setup-progress-bar').style.width = Math.min(progress, 90) + '%';
        }
    }, 1000);
}

function hideProgress() {
    clearInterval(window.progressInterval);
    document.getElementById('setup-progress-bar').style.width = '100%';
    setTimeout(() => setupModal.hide(), 500);
}

function showToast(message, type = 'info') {
    // Create toast container if not exists
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}
</script>
{% endblock %}

