<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Management - Beep.Python.DataManagement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="../assets/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="bi bi-sun-fill" id="theme-icon"></i>
    </button>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Navigation will be loaded dynamically by navigation.js -->
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div class="content-wrapper">
                <!-- Breadcrumb Navigation -->
                <div class="breadcrumb-nav">
                    <a href="../index.html">Home</a>
                    <span>?</span>
                    <a href="../index.html#configuration">Configuration</a>
                    <span>?</span>
                    <span>Session Management</span>
                </div>

                <!-- Page Header -->
                <div class="page-header">
                    <h1><i class="bi bi-people"></i> Session Management</h1>
                    <p class="page-subtitle">Comprehensive guide to multi-user session isolation, virtual environment management, and enterprise-grade security</p>
                </div>

                <!-- Overview -->
                <section class="section" id="overview">
                    <h2>?? Overview</h2>
                    <p>
                        Session management is a core feature of PythonPandasManager that enables <strong>multi-user isolation</strong>, 
                        <strong>resource separation</strong>, and <strong>enterprise-grade security</strong>. Each session provides 
                        an isolated Python environment where users can work with DataFrames without interference.
                    </p>

                    <div class="note">
                        <strong>?? Key Benefits</strong>
                        <ul>
                            <li><strong>Multi-User Isolation:</strong> Each user gets their own Python environment</li>
                            <li><strong>Resource Management:</strong> Automatic cleanup and memory management</li>
                            <li><strong>Security:</strong> Data separation between users and sessions</li>
                            <li><strong>Scalability:</strong> Support for concurrent data operations</li>
                            <li><strong>Virtual Environment Support:</strong> Isolated package dependencies</li>
                        </ul>
                    </div>
                </section>

                <!-- Architecture -->
                <section class="section" id="architecture">
                    <h2>??? Session Architecture</h2>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4><i class="bi bi-person-circle"></i> User Sessions</h4>
                            <p>Each user gets a dedicated session with isolated Python context and DataFrame storage</p>
                        </div>
                        
                        <div class="feature-card">
                            <h4><i class="bi bi-layers"></i> Virtual Environments</h4>
                            <p>Sessions can use different virtual environments with specific package versions</p>
                        </div>
                        
                        <div class="feature-card">
                            <h4><i class="bi bi-shield-check"></i> Security Isolation</h4>
                            <p>Complete data separation prevents cross-user access and data leakage</p>
                        </div>
                        
                        <div class="feature-card">
                            <h4><i class="bi bi-arrow-clockwise"></i> Automatic Cleanup</h4>
                            <p>Idle sessions and DataFrames are automatically cleaned up to preserve resources</p>
                        </div>
                    </div>
                </section>

                <!-- Basic Configuration -->
                <section class="section" id="basic-configuration">
                    <h2>?? Basic Session Configuration</h2>
                    
                    <div class="code-example">
                        <h4>1. Simple User-Based Configuration (Recommended)</h4>
                        <pre><code class="language-csharp">// Simplest approach - let the system handle session creation
var pandasManager = new PythonPandasManager(beepService, runtimeManager, executeManager);

// Configure for a specific user - system creates session automatically
bool configured = pandasManager.ConfigureSessionForUser("alice.smith");

if (configured)
{
    Console.WriteLine("? Session configured for alice.smith");
    
    // Verify session is ready
    if (pandasManager.IsSessionConfigured())
    {
        Console.WriteLine("?? Ready to perform DataFrame operations");
    }
}
else
{
    Console.WriteLine("? Failed to configure session");
}</code></pre>
                    </div>

                    <div class="code-example">
                        <h4>2. Configuration with Specific Environment</h4>
                        <pre><code class="language-csharp">// Configure user with a specific virtual environment
bool configured = pandasManager.ConfigureSessionForUser(
    username: "data.scientist", 
    environmentId: "ml-environment"
);

if (configured)
{
    // Get session information
    var session = pandasManager.GetConfiguredSession();
    var environment = pandasManager.GetConfiguredVirtualEnvironment();
    
    Console.WriteLine($"Session ID: {session?.SessionId}");
    Console.WriteLine($"Environment: {environment?.Name}");
    Console.WriteLine($"Python Version: {environment?.PythonVersion}");
}</code></pre>
                    </div>

                    <div class="code-example">
                        <h4>3. Check Session Status</h4>
                        <pre><code class="language-csharp">// Always check session status before operations
if (!pandasManager.IsSessionConfigured())
{
    Console.WriteLine("?? No session configured, configuring default session...");
    pandasManager.ConfigureSessionForUser("default-user");
}

// Now safe to perform operations
pandasManager.ReadCsv("data", @"C:\Data\sample.csv");
string summary = pandasManager.Describe("data");
Console.WriteLine(summary);</code></pre>
                    </div>
                </section>

                <!-- Advanced Configuration -->
                <section class="section" id="advanced-configuration">
                    <h2>?? Advanced Session Configuration</h2>
                    
                    <div class="code-example">
                        <h4>Manual Session and Environment Creation</h4>
                        <pre><code class="language-csharp">// Get session and environment managers
var sessionManager = runtimeManager.SessionManager;
var envManager = runtimeManager.VirtualEnvmanager;

try
{
    // Create or get virtual environment
    var environment = envManager.GetEnvironmentById("analytics-env");
    if (environment == null)
    {
        // Create new environment for analytics
        environment = envManager.CreateEnvironmentForUser(
            pythonConfig: pythonConfig,
            envBasePath: @"C:\Environments",
            userName: "analytics.team",
            environmentName: "analytics-env"
        );
        
        if (environment == null)
        {
            throw new InvalidOperationException("Failed to create environment");
        }
        
        Console.WriteLine($"? Created environment: {environment.Name}");
    }

    // Create session for specific user
    var session = sessionManager.CreateSession("analytics.team", environment.ID);
    if (session == null)
    {
        throw new InvalidOperationException("Failed to create session");
    }

    // Configure pandas manager with created session
    bool configured = pandasManager.ConfigureSession(session, environment);
    if (configured)
    {
        Console.WriteLine($"? Advanced session configured");
        Console.WriteLine($"   Session ID: {session.SessionId}");
        Console.WriteLine($"   User: {session.Username}");
        Console.WriteLine($"   Environment: {environment.Name}");
    }
}
catch (Exception ex)
{
    Console.WriteLine($"? Advanced configuration failed: {ex.Message}");
}</code></pre>
                    </div>
                </section>

                <!-- Multi-User Scenarios -->
                <section class="section" id="multi-user-scenarios">
                    <h2>?? Multi-User Scenarios</h2>
                    
                    <div class="code-example">
                        <h4>1. Web Application with User-Specific Sessions</h4>
                        <pre><code class="language-csharp">[ApiController]
[Route("api/[controller]")]
public class DataAnalysisController : ControllerBase
{
    private readonly IPythonPandasManager _pandasManager;
    
    public DataAnalysisController(IPythonPandasManager pandasManager)
    {
        _pandasManager = pandasManager;
    }

    [HttpPost("analyze")]
    [Authorize]
    public async Task&lt;IActionResult&gt; AnalyzeUserData([FromBody] AnalysisRequest request)
    {
        try
        {
            // Get current user from authentication context
            string userId = User.Identity.Name ?? "anonymous";
            
            // Configure session for this specific user
            bool configured = _pandasManager.ConfigureSessionForUser(userId, "web-analytics-env");
            if (!configured)
            {
                return StatusCode(500, "Failed to configure user session");
            }

            // Load user's data (each user sees only their data)
            await _pandasManager.ReadCsvAsync("user_data", request.DataPath);
            
            // Perform analysis in isolated session
            string results = _pandasManager.Describe("user_data");
            
            return Ok(new { userId, results });
        }
        catch (Exception ex)
        {
            return StatusCode(500, $"Analysis failed: {ex.Message}");
        }
        finally
        {
            // Cleanup happens automatically, but can be explicit
            _pandasManager.CleanupIdleDataFrames();
        }
    }
}</code></pre>
                    </div>

                    <div class="code-example">
                        <h4>2. Background Service with Session Management</h4>
                        <pre><code class="language-csharp">public class DataProcessingService : BackgroundService
{
    private readonly IServiceProvider _serviceProvider;
    private readonly ILogger&lt;DataProcessingService&gt; _logger;

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            await ProcessUserDataBatches(stoppingToken);
            await Task.Delay(TimeSpan.FromMinutes(10), stoppingToken);
        }
    }

    private async Task ProcessUserDataBatches(CancellationToken cancellationToken)
    {
        using var scope = _serviceProvider.CreateScope();
        var pandasManager = scope.ServiceProvider.GetRequiredService&lt;IPythonPandasManager&gt;();
        
        // Get list of users who need data processing
        var usersToProcess = await GetUsersNeedingProcessing();

        foreach (var user in usersToProcess)
        {
            if (cancellationToken.IsCancellationRequested) break;

            try
            {
                _logger.LogInformation("Processing data for user: {UserId}", user.Id);
                
                // Configure session for this user
                bool configured = pandasManager.ConfigureSessionForUser(
                    user.Id, 
                    user.PreferredEnvironment ?? "batch-processing-env"
                );

                if (!configured)
                {
                    _logger.LogError("Failed to configure session for user: {UserId}", user.Id);
                    continue;
                }

                // Process this user's data in isolated session
                await ProcessSingleUserData(pandasManager, user, cancellationToken);
                
                _logger.LogInformation("Completed processing for user: {UserId}", user.Id);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error processing data for user: {UserId}", user.Id);
            }
            finally
            {
                // Clean up this user's session resources
                pandasManager.CleanupIdleDataFrames(1); // Clean DataFrames older than 1 minute
            }
        }
    }

    private async Task ProcessSingleUserData(IPythonPandasManager pandasManager, User user, CancellationToken cancellationToken)
    {
        // Load user's raw data
        await pandasManager.ReadCsvAsync("raw_data", user.DataPath, cancellationToken);
        
        // Clean and process data
        pandasManager.DropNA("raw_data", "clean_data");
        pandasManager.DropDuplicates("clean_data", "processed_data");
        
        // Generate user-specific analytics
        pandasManager.GroupBy("processed_data", "user_analytics", "category", "sum");
        
        // Save results to user-specific location
        string outputPath = Path.Combine(user.OutputDirectory, $"analytics_{DateTime.Now:yyyyMMdd}.csv");
        await pandasManager.ToCsvAsync("user_analytics", outputPath, cancellationToken);
    }
}</code></pre>
                    </div>
                </section>

                <!-- Session Lifecycle -->
                <section class="section" id="session-lifecycle">
                    <h2>?? Session Lifecycle Management</h2>
                    
                    <div class="code-example">
                        <h4>1. Session Creation and Validation</h4>
                        <pre><code class="language-csharp">public class SessionLifecycleManager
{
    private readonly IPythonPandasManager _pandasManager;
    private readonly ILogger&lt;SessionLifecycleManager&gt; _logger;

    public async Task&lt;bool&gt; EnsureUserSession(string userId, string? environmentId = null)
    {
        try
        {
            // Check if session is already configured
            if (_pandasManager.IsSessionConfigured())
            {
                var currentSession = _pandasManager.GetConfiguredSession();
                if (currentSession?.Username == userId)
                {
                    _logger.LogDebug("Session already configured for user: {UserId}", userId);
                    return true;
                }
                
                // Different user - need to reconfigure
                _logger.LogInformation("Switching session from {CurrentUser} to {NewUser}", 
                    currentSession?.Username, userId);
            }

            // Configure session for the user
            bool configured = _pandasManager.ConfigureSessionForUser(userId, environmentId);
            
            if (configured)
            {
                _logger.LogInformation("Session configured successfully for user: {UserId}", userId);
                
                // Validate session
                return await ValidateSession();
            }
            else
            {
                _logger.LogError("Failed to configure session for user: {UserId}", userId);
                return false;
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error ensuring session for user: {UserId}", userId);
            return false;
        }
    }

    private async Task&lt;bool&gt; ValidateSession()
    {
        try
        {
            // Test basic pandas operation to validate session
            _pandasManager.CreateDataFrame("test_df", "pd.DataFrame({'test': [1, 2, 3]})");
            
            // Verify we can access the DataFrame
            string testResult = _pandasManager.Describe("test_df");
            
            if (!string.IsNullOrEmpty(testResult))
            {
                _logger.LogDebug("Session validation successful");
                return true;
            }
            else
            {
                _logger.LogWarning("Session validation failed - no data returned");
                return false;
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Session validation failed");
            return false;
        }
    }

    public void CleanupSession()
    {
        try
        {
            // Get memory usage before cleanup
            string memoryBefore = _pandasManager.GetMemoryUsageReport();
            _logger.LogDebug("Memory usage before cleanup: {MemoryUsage}", memoryBefore);

            // Cleanup idle DataFrames
            _pandasManager.CleanupIdleDataFrames(15); // Clean DataFrames older than 15 minutes

            // Get memory usage after cleanup
            string memoryAfter = _pandasManager.GetMemoryUsageReport();
            _logger.LogInformation("Memory usage after cleanup: {MemoryUsage}", memoryAfter);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error during session cleanup");
        }
    }
}</code></pre>
                    </div>
                </section>

                <!-- Security Considerations -->
                <section class="section" id="security">
                    <h2>??? Security Considerations</h2>
                    
                    <div class="warning">
                        <h4>?? Security Best Practices</h4>
                        <ul>
                            <li><strong>User Isolation:</strong> Always use user-specific sessions in multi-user environments</li>
                            <li><strong>Authentication:</strong> Verify user identity before configuring sessions</li>
                            <li><strong>Authorization:</strong> Check user permissions for data access operations</li>
                            <li><strong>Session Timeout:</strong> Implement automatic session timeout for inactive users</li>
                            <li><strong>Data Validation:</strong> Validate all file paths and data sources</li>
                            <li><strong>Resource Limits:</strong> Set memory and processing limits per session</li>
                        </ul>
                    </div>

                    <div class="code-example">
                        <h4>Secure Session Configuration</h4>
                        <pre><code class="language-csharp">public class SecureSessionManager
{
    private readonly IPythonPandasManager _pandasManager;
    private readonly IUserAuthenticationService _authService;
    private readonly ILogger&lt;SecureSessionManager&gt; _logger;

    public async Task&lt;bool&gt; ConfigureSecureSession(string userToken, string requestedEnvironment)
    {
        try
        {
            // 1. Validate user authentication
            var user = await _authService.ValidateTokenAsync(userToken);
            if (user == null)
            {
                _logger.LogWarning("Invalid user token provided");
                return false;
            }

            // 2. Check user permissions for requested environment
            if (!await _authService.HasEnvironmentAccessAsync(user.Id, requestedEnvironment))
            {
                _logger.LogWarning("User {UserId} does not have access to environment {Environment}", 
                    user.Id, requestedEnvironment);
                return false;
            }

            // 3. Validate environment exists and is accessible
            var environment = _pandasManager.GetConfiguredVirtualEnvironment();
            if (environment?.ID != requestedEnvironment)
            {
                // Configure the requested environment
                bool configured = _pandasManager.ConfigureSessionForUser(user.Id, requestedEnvironment);
                if (!configured)
                {
                    _logger.LogError("Failed to configure environment {Environment} for user {UserId}", 
                        requestedEnvironment, user.Id);
                    return false;
                }
            }

            // 4. Set up session monitoring
            await SetupSessionMonitoring(user.Id);

            _logger.LogInformation("Secure session configured for user {UserId} in environment {Environment}", 
                user.Id, requestedEnvironment);
            
            return true;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error configuring secure session");
            return false;
        }
    }

    private async Task SetupSessionMonitoring(string userId)
    {
        // Set up monitoring for this session
        // This could include resource usage tracking, operation logging, etc.
        _logger.LogDebug("Session monitoring setup for user: {UserId}", userId);
    }
}</code></pre>
                    </div>
                </section>

                <!-- Troubleshooting -->
                <section class="section" id="troubleshooting">
                    <h2>?? Troubleshooting Sessions</h2>
                    
                    <div class="tip">
                        <h4>?? Common Issues and Solutions</h4>
                        
                        <h5>? Session Configuration Fails</h5>
                        <ul>
                            <li><strong>Check Python Runtime:</strong> Ensure Python runtime is properly initialized</li>
                            <li><strong>Verify Environment:</strong> Make sure the virtual environment exists and is accessible</li>
                            <li><strong>User Permissions:</strong> Verify the user has necessary file system permissions</li>
                            <li><strong>Resource Availability:</strong> Check if system has sufficient memory</li>
                        </ul>

                        <h5>?? Session Becomes Unresponsive</h5>
                        <ul>
                            <li><strong>Memory Issues:</strong> Use <code>GetMemoryUsageReport()</code> to check usage</li>
                            <li><strong>Cleanup DataFrames:</strong> Call <code>CleanupIdleDataFrames()</code></li>
                            <li><strong>Restart Session:</strong> Reconfigure the session if needed</li>
                            <li><strong>Check Logs:</strong> Review application logs for Python errors</li>
                        </ul>

                        <h5>?? Cross-User Data Access</h5>
                        <ul>
                            <li><strong>Session Isolation:</strong> Ensure each user has their own session</li>
                            <li><strong>DataFrame Naming:</strong> Use user-specific DataFrame names</li>
                            <li><strong>File Permissions:</strong> Verify file system security</li>
                            <li><strong>Audit Logging:</strong> Implement operation logging for security</li>
                        </ul>
                    </div>

                    <div class="code-example">
                        <h4>Session Diagnostic Tools</h4>
                        <pre><code class="language-csharp">public class SessionDiagnostics
{
    public static void DiagnoseSession(IPythonPandasManager pandasManager)
    {
        Console.WriteLine("?? Session Diagnostics");
        Console.WriteLine("===================");

        // Check session configuration
        bool isConfigured = pandasManager.IsSessionConfigured();
        Console.WriteLine($"Session Configured: {(isConfigured ? "?" : "?")}");

        if (isConfigured)
        {
            // Get session information
            var session = pandasManager.GetConfiguredSession();
            var environment = pandasManager.GetConfiguredVirtualEnvironment();

            Console.WriteLine($"Session ID: {session?.SessionId ?? "Unknown"}");
            Console.WriteLine($"Username: {session?.Username ?? "Unknown"}");
            Console.WriteLine($"Environment: {environment?.Name ?? "Unknown"}");
            Console.WriteLine($"Python Version: {environment?.PythonVersion ?? "Unknown"}");

            // Check memory usage
            try
            {
                string memoryReport = pandasManager.GetMemoryUsageReport();
                Console.WriteLine($"Memory Usage:\n{memoryReport}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"? Failed to get memory report: {ex.Message}");
            }

            // Test basic operation
            try
            {
                pandasManager.CreateDataFrame("diagnostic_test", "pd.DataFrame({'test': [1]})");
                string result = pandasManager.Describe("diagnostic_test");
                Console.WriteLine("? Basic operations working");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"? Basic operations failing: {ex.Message}");
            }
        }
        else
        {
            Console.WriteLine("? Session not configured - unable to perform diagnostics");
        }
    }
}</code></pre>
                    </div>
                </section>

                <!-- Navigation Links -->
                <div class="nav-links">
                    <a href="../index.html" class="btn-beep">
                        <i class="bi bi-arrow-left"></i> Back to Home
                    </a>
                    <a href="virtual-environments.html" class="btn-beep">
                        <i class="bi bi-arrow-right"></i> Virtual Environments
                    </a>
                </div>

                <!-- Footer -->
                <footer class="documentation-footer">
                    <div class="footer-content">
                        <div class="footer-copyright">
                            <p>&copy; 2024 The Tech Idea - Beep.Python.DataManagement Documentation</p>
                        </div>
                        <div class="footer-links">
                            <a href="../index.html">Home</a>
                            <a href="../getting-started.html">Getting Started</a>
                            <a href="../api/PythonPandasManager.html">API Reference</a>
                        </div>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="../assets/navigation.js"></script>
</body>
</html>