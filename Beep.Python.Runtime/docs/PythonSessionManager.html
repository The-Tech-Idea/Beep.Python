<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PythonSessionManager - Beep.Python.Runtime.PythonNet</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="bi bi-sun-fill" id="theme-icon"></i>
    </button>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Navigation will be loaded dynamically by navigation.js -->
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div class="content-wrapper">
                <!-- Keep existing content structure -->
                <!-- Navigation Links -->
                <div class="nav-links">
                    <a href="PythonNetRunTimeManager.html">
                        <i class="bi bi-arrow-left"></i> PythonNetRunTimeManager
                    </a>
                    <a href="PythonCodeExecuteManager.html">
                        <i class="bi bi-arrow-right"></i> PythonCodeExecuteManager
                    </a>
                </div>

                <h1>PythonSessionManager</h1>
    
                <div class="class-info">
                  <div class="class-namespace">namespace <strong>Beep.Python.RuntimeEngine</strong></div>
                  <p>Manages Python sessions for multiple users, providing isolation, concurrency support, and load balancing across Python environments.</p>
                  <div class="class-implements">
                    Implements: <code>IPythonSessionManager</code>, <code>IDisposable</code>
                  </div>
                </div>
                
                <div class="section">
                  <h2>Overview</h2>
                  <p>
                    The <code>PythonSessionManager</code> provides comprehensive session management for Python.NET integration. 
                    It enables multiple users to work with isolated Python environments, manages resources efficiently, 
                    implements concurrency controls, and handles cleanup of inactive or terminated sessions.
                  </p>
                  
                  <p>
                    This class is thread-safe and designed for multi-user environments, ensuring that Python operations 
                    from different users don't interfere with each other.
                  </p>
                </div>
                
                <div class="section">
                  <h2>Properties</h2>
                  <ul class="member-list">
                    <li>
                      <div class="member-name">Sessions</div>
                      <div class="member-type">ObservableBindingList&lt;PythonSessionInfo&gt;</div>
                      <div class="member-desc">Collection of all active and recently terminated sessions.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">SessionCount</div>
                      <div class="member-type">int</div>
                      <div class="member-desc">Gets the current total session count.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">ActiveSessionCount</div>
                      <div class="member-type">int</div>
                      <div class="member-desc">Gets the number of active sessions.</div>
                    </li>
                  </ul>
                </div>
                
                <div class="section">
                  <h2>Methods</h2>
                  <h3>Session Creation and Management</h3>
                  <ul class="member-list">
                    <li>
                      <div class="member-name">CreateSession(string username, string environmentId)</div>
                      <div class="member-type">PythonSessionInfo</div>
                      <div class="member-desc">
                        Creates a new Python session associated with a specific user and environment. 
                        Uses load balancing to determine the best environment when multiple are available.
                      </div>
                    </li>
                    
                    <li>
                      <div class="member-name">GetSession(string sessionId)</div>
                      <div class="member-type">PythonSessionInfo</div>
                      <div class="member-desc">Gets a session by its ID.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">HasSession(string sessionId)</div>
                      <div class="member-type">bool</div>
                      <div class="member-desc">Checks if a session with the specified ID exists.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">RegisterSession(PythonSessionInfo session)</div>
                      <div class="member-type">void</div>
                      <div class="member-desc">Registers a session with the session manager and the associated environment.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">UnregisterSession(string sessionId)</div>
                      <div class="member-type">void</div>
                      <div class="member-desc">Unregisters a session from the session manager and associated environment.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">AssociateWithEnvironment(string sessionId, string environmentId)</div>
                      <div class="member-type">bool</div>
                      <div class="member-desc">Associates a session with a virtual environment.</div>
                    </li>
                  </ul>
                  
                  <h3>Session Output Management</h3>
                  <ul class="member-list">
                    <li>
                      <div class="member-name">GetSessionOutput(string sessionId)</div>
                      <div class="member-type">Task&lt;string&gt;</div>
                      <div class="member-desc">Gets the captured output from a session.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">AppendSessionOutput(string sessionId, string output)</div>
                      <div class="member-type">void</div>
                      <div class="member-desc">Appends output to a session's captured output buffer.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">ClearSessionOutput(string sessionId)</div>
                      <div class="member-type">void</div>
                      <div class="member-desc">Clears a session's captured output buffer.</div>
                    </li>
                  </ul>
                  
                  <h3>Session Cleanup and Maintenance</h3>
                  <ul class="member-list">
                    <li>
                      <div class="member-name">CleanupSession(PythonSessionInfo session)</div>
                      <div class="member-type">void</div>
                      <div class="member-desc">Cleans up resources associated with a session without terminating it.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">TerminateSession(string sessionId)</div>
                      <div class="member-type">IErrorsInfo</div>
                      <div class="member-desc">Terminates a session, cleaning up all resources and marking it as terminated.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">PerformSessionCleanup(TimeSpan maxAge)</div>
                      <div class="member-type">void</div>
                      <div class="member-desc">Performs cleanup of sessions older than the specified maximum age.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">UpdateSessionActivity(string sessionId)</div>
                      <div class="member-type">void</div>
                      <div class="member-desc">Updates the last activity timestamp for a session.</div>
                    </li>
                  </ul>
                  
                  <h3>Concurrency and Scaling Support</h3>
                  <ul class="member-list">
                    <li>
                      <div class="member-name">GetMetrics()</div>
                      <div class="member-type">Dictionary&lt;string, object&gt;</div>
                      <div class="member-desc">Gets usage metrics for session management.</div>
                    </li>
                    
                    <li>
                      <div class="member-name">ExecuteWithConcurrencyControlAsync(string sessionId, Func&lt;Task&gt; action)</div>
                      <div class="member-type">Task&lt;bool&gt;</div>
                      <div class="member-desc">Executes the given action with proper concurrency control.</div>
                    </li>
                  </ul>
                </div>
                
                <div class="section">
                  <h2>Usage Examples</h2>
      
                  <h3>Basic Session Management</h3>
                  <div class="code-block">
                    <div class="code-header">C# Example</div>
<pre><code>// Assuming runtimeManager is already initialized
var sessionManager = runtimeManager.SessionManager;

// Create a new session for user "john"
var session = sessionManager.CreateSession("john", null); // null means auto-select environment

// Execute some code using this session
var result = await runtimeManager.ExecuteManager.ExecuteCodeAsync(
    "x = 42\nprint(f'The answer is {x}')", 
    session);

// Session output can be retrieved
string output = await sessionManager.GetSessionOutput(session.SessionId);
Console.WriteLine($"Session output: {output}");

// When done, terminate the session to free resources
sessionManager.TerminateSession(session.SessionId);</code></pre>
                  </div>
      
                  <h3>Working with Multiple Sessions</h3>
                  <div class="code-block">
                    <div class="code-header">C# Example</div>
<pre><code>// Create sessions for multiple users
var session1 = sessionManager.CreateSession("alice", null);
var session2 = sessionManager.CreateSession("bob", null);

// Execute code in separate sessions - variables won't interfere
await runtimeManager.ExecuteManager.ExecuteCodeAsync("x = 'Alice data'", session1);
await runtimeManager.ExecuteManager.ExecuteCodeAsync("x = 'Bob data'", session2);

// Verify session isolation
var result1 = await runtimeManager.ExecuteManager.ExecuteCommandAsync("x", session1);
var result2 = await runtimeManager.ExecuteManager.ExecuteCommandAsync("x", session2);

Console.WriteLine($"Session 1 value: {result1}"); // "Alice data"
Console.WriteLine($"Session 2 value: {result2}"); // "Bob data"

// Get metrics about current sessions
var metrics = sessionManager.GetMetrics();
Console.WriteLine($"Total sessions: {metrics["TotalSessionCount"]}");
Console.WriteLine($"Active sessions: {metrics["ActiveSessionCount"]}");

// Clean up
sessionManager.TerminateSession(session1.SessionId);
sessionManager.TerminateSession(session2.SessionId);</code></pre>
                  </div>
      
                  <h3>Advanced: Session Cleanup and Maintenance</h3>
                  <div class="code-block">
                    <div class="code-header">C# Example</div>
<pre><code>// Setup a periodic cleanup task for inactive sessions
async Task PerformPeriodicCleanup(CancellationToken cancellationToken)
{
    // Clean up sessions inactive for more than 30 minutes
    var inactivityTimeout = TimeSpan.FromMinutes(30);
    
    while (!cancellationToken.IsCancellationRequested)
    {
        try
        {
            // Perform the cleanup
            sessionManager.PerformSessionCleanup(inactivityTimeout);
            
            // Log metrics after cleanup
            var metrics = sessionManager.GetMetrics();
            Console.WriteLine($"Sessions after cleanup: {metrics["ActiveSessionCount"]}");
            
            // Wait before next cleanup
            await Task.Delay(TimeSpan.FromMinutes(5), cancellationToken);
        }
        catch (OperationCanceledException)
        {
            break;
        }
    }
}

// Start the cleanup task
var cts = new CancellationTokenSource();
var cleanupTask = PerformPeriodicCleanup(cts.Token);

// Later, when shutting down:
cts.Cancel();</code></pre>
                  </div>
                </div>

                <div class="section">
                  <h2>See Also</h2>
                  <ul>
                    <li><a href="PythonNetRunTimeManager.html">PythonNetRunTimeManager</a> - For managing the Python runtime</li>
                    <li><a href="PythonCodeExecuteManager.html">PythonCodeExecuteManager</a> - For executing Python code</li>
                    <li><a href="multi-user-sessions.html">Multi-User Sessions</a> - Advanced multi-user configuration</li>
                  </ul>
                </div>

                <!-- Footer -->
                <footer class="documentation-footer">
                    <div class="footer-content">
                        <div class="footer-copyright">
                            <p>&copy; 2024 The Tech Idea - Beep.Python.Runtime.PythonNet Documentation</p>
                        </div>
                        <div class="footer-links">
                            <a href="index.html">Home</a>
                            <a href="api-reference.html">API Reference</a>
                        </div>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="navigation.js"></script>
    <script>
        // Simplified navigation functionality for embedded sidebar
        document.addEventListener('DOMContentLoaded', function() {
            setupSubmenuToggles();
            initializeTheme();
            setupCodeCopy();
        });

        // Setup submenu toggle functionality
        function setupSubmenuToggles() {
            const submenuItems = document.querySelectorAll('.has-submenu > a');
            
            submenuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const parent = this.parentElement;
                    parent.classList.toggle('open');
                });
            });
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        // Search functionality
        function searchDocs(query) {
            const links = document.querySelectorAll('.nav-menu a');
            const lowerQuery = query.toLowerCase();
            
            links.forEach(link => {
                const text = link.textContent.toLowerCase();
                const listItem = link.closest('li');
                
                if (text.includes(lowerQuery) || lowerQuery === '') {
                    listItem.style.display = '';
                } else {
                    listItem.style.display = 'none';
                }
            });
        }

        // Theme toggle functionality
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme icon
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
            }
        }

        // Initialize theme from localStorage
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
            }
        }

        // Copy code functionality
        function setupCodeCopy() {
            const codeBlocks = document.querySelectorAll('pre code');
            
            codeBlocks.forEach(block => {
                const button = document.createElement('button');
                button.textContent = 'Copy';
                button.style.cssText = `
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: var(--color-brand-primary);
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 4px 8px;
                    font-size: 12px;
                    cursor: pointer;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                const pre = block.parentElement;
                pre.style.position = 'relative';
                pre.appendChild(button);
                
                pre.addEventListener('mouseenter', () => {
                    button.style.opacity = '1';
                });
                
                pre.addEventListener('mouseleave', () => {
                    button.style.opacity = '0';
                });
                
                button.addEventListener('click', () => {
                    navigator.clipboard.writeText(block.textContent).then(() => {
                        button.textContent = 'Copied!';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
            });
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
