<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaseTransformerPipeline API - Beep.Python.AI.Transformers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="../assets/styles.css" rel="stylesheet">
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="bi bi-sun-fill" id="theme-icon"></i>
    </button>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Navigation will be loaded dynamically by navigation.js -->
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div class="content-wrapper">
                <!-- Breadcrumb Navigation -->
                <div class="breadcrumb-nav">
                    <a href="../index.html">Home</a>
                    <span>‚Ä∫</span>
                    <a href="../index.html#core-api">Core API</a>
                    <span>‚Ä∫</span>
                    <span>BaseTransformerPipeline</span>
                </div>

                <!-- Page Header -->
                <div class="page-header">
                    <h1><i class="bi bi-layers"></i> BaseTransformerPipeline Class</h1>
                    <p class="page-subtitle">Abstract base class providing common functionality for all transformer pipeline
                        implementations</p>
                </div>

                <!-- Class Info -->
                <div class="class-info">
                    <div class="class-namespace">
                        <strong>Namespace:</strong> Beep.Python.AI.Transformers<br>
                        <strong>Assembly:</strong> Beep.Python.AI.Transformers.dll<br>
                        <strong>Type:</strong> Abstract Class
                    </div>
                    <div class="class-implements">
                        <strong>Implements:</strong> ITransformerPipeLine, IDisposable
                    </div>
                </div>

                <!-- Overview Section -->
                <section class="section" id="overview">
                    <h2>Overview</h2>
                    <p>
                        The <code>BaseTransformerPipeline</code> abstract class serves as the foundation for all transformer
                        pipeline implementations in the Beep.Python.AI.Transformers library. It provides comprehensive
                        shared functionality including session management, connection configuration, error handling,
                        and common inference operations.
                    </p>

                    <div class="highlight-box bg-light p-4 rounded">
                        <h5><i class="bi bi-lightbulb"></i> Key Responsibilities</h5>
                        <ul class="mb-0">
                            <li><strong>Session Management</strong> - Multi-user isolation with virtual environments</li>
                            <li><strong>Connection Configuration</strong> - Provider authentication and endpoint management
                            </li>
                            <li><strong>Common Operations</strong> - Shared inference methods and utilities</li>
                            <li><strong>Error Handling</strong> - Consistent error management and event firing</li>
                            <li><strong>Resource Management</strong> - Proper cleanup and disposal patterns</li>
                        </ul>
                    </div>
                </section>

                <!-- Class Declaration Section -->
                <section class="section" id="declaration">
                    <h2>Class Declaration</h2>
                    <div class="code-example">
                        <h4>Class Definition</h4>
                        <pre><code class="language-csharp">public abstract class BaseTransformerPipeline : ITransformerPipeLine
{
    // Protected Fields
    protected bool _isInitialized;
    protected bool _isModelLoaded;
    protected string? _modelName;
    protected TransformerModelSource _modelSource;
    protected TransformerTask _taskType;
    protected string? _device;
    protected Dictionary&lt;string, object&gt; _modelConfig;
    protected TransformerPipelineConfig? _pipelineConfig;
    protected bool _disposed;

    // Python runtime dependencies
    protected readonly IPythonRunTimeManager _pythonRunTimeManager;
    protected readonly IPythonCodeExecuteManager _executeManager;

    // Connection configuration
    protected TransformerConnectionConfig? _connectionConfig;
    protected static readonly TransformerConnectionManager _connectionManager = new();
}</code></pre>
                    </div>
                </section>

                <!-- Constructor Section -->
                <section class="section" id="constructor">
                    <h2>Constructor</h2>

                    <h3>BaseTransformerPipeline</h3>
                    <div class="api-signature">
                        <code>protected BaseTransformerPipeline(IPythonRunTimeManager pythonRunTimeManager, IPythonCodeExecuteManager executeManager)</code>
                    </div>
                    <p>Initializes a new instance of the BaseTransformerPipeline class.</p>

                    <div class="parameter-table">
                        <h5>Parameters</h5>
                        <table>
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>pythonRunTimeManager</code></td>
                                    <td><code>IPythonRunTimeManager</code></td>
                                    <td>Python runtime manager for execution context</td>
                                </tr>
                                <tr>
                                    <td><code>executeManager</code></td>
                                    <td><code>IPythonCodeExecuteManager</code></td>
                                    <td>Python code execution manager</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="warning">
                        <strong>‚ö†Ô∏è Exceptions</strong>
                        <p><code>ArgumentNullException</code> - Thrown when either parameter is null</p>
                    </div>
                </section>

                <!-- Abstract Methods Section -->
                <section class="section" id="abstract-methods">
                    <h2>Abstract Methods</h2>
                    <p>These methods must be implemented by derived classes to provide provider-specific functionality.</p>

                    <h3>InitializeAsync</h3>
                    <div class="api-signature">
                        <code>public abstract Task&lt;bool&gt; InitializeAsync(TransformerPipelineConfig config)</code>
                    </div>
                    <p>Initialize the pipeline with provider-specific configuration.</p>

                    <h3>LoadModelAsync</h3>
                    <div class="api-signature">
                        <code>public abstract Task&lt;bool&gt; LoadModelAsync(TransformerModelInfo modelInfo, TransformerTask taskType, Dictionary&lt;string, object&gt;? modelConfig = null)</code>
                    </div>
                    <p>Load a model based on the model information and configuration.</p>

                    <h3>GenerateTextAsync</h3>
                    <div class="api-signature">
                        <code>public abstract Task&lt;TransformerResult&lt;string&gt;&gt; GenerateTextAsync(string prompt, TextGenerationParameters? parameters = null)</code>
                    </div>
                    <p>Perform text generation with provider-specific implementation.</p>
                </section>

                <!-- Session Management Section -->
                <section class="section" id="session-management">
                    <h2>Session Management</h2>

                    <h3>ConfigureSession</h3>
                    <div class="api-signature">
                        <code>public virtual bool ConfigureSession(PythonSessionInfo session, PythonVirtualEnvironment virtualEnvironment)</code>
                    </div>
                    <p>Configure the pipeline to use a specific Python session and virtual environment. This is the recommended
                        approach for multi-user environments.</p>

                    <div class="code-example">
                        <h5>Example Usage</h5>
                        <pre><code class="language-csharp">// Create session for user
var session = sessionManager.CreateSession("alice", environmentId);
var environment = virtualEnvManager.GetEnvironmentById(environmentId);

// Configure pipeline to use this session
var success = pipeline.ConfigureSession(session, environment);

if (success)
{
    // Pipeline is now configured for user "alice"
    var result = await pipeline.GenerateTextAsync("Hello world");
}</code></pre>
                    </div>

                    <h3>GetConfiguredSession</h3>
                    <div class="api-signature">
                        <code>public virtual PythonSessionInfo? GetConfiguredSession()</code>
                    </div>
                    <p>Get the currently configured session, if any.</p>

                    <h3>GetConfiguredVirtualEnvironment</h3>
                    <div class="api-signature">
                        <code>public virtual PythonVirtualEnvironment? GetConfiguredVirtualEnvironment()</code>
                    </div>
                    <p>Get the currently configured virtual environment, if any.</p>
                </section>

                <!-- Connection Configuration Section -->
                <section class="section" id="connection-config">
                    <h2>Connection Configuration</h2>

                    <h3>ConfigureConnection</h3>
                    <div class="api-signature">
                        <code>public virtual bool ConfigureConnection(TransformerConnectionConfig connectionConfig)</code>
                    </div>
                    <p>Configure connection for the transformer service provider.</p>

                    <div class="code-example">
                        <h5>Example Usage</h5>
                        <pre><code class="language-csharp">// Configure OpenAI connection
var openAIConfig = new OpenAIConnectionConfig
{
    ApiKey = "sk-your-api-key",
    OrganizationId = "org-your-org",
    TimeoutSeconds = 60,
    MaxRetries = 3,
    RateLimit = new RateLimitConfig
    {
        RequestsPerMinute = 100
    }
};

var success = pipeline.ConfigureConnection(openAIConfig);
if (success)
{
    Console.WriteLine("Connection configured successfully");
}</code></pre>
                    </div>

                    <h3>GetConnectionConfig</h3>
                    <div class="api-signature">
                        <code>public virtual TransformerConnectionConfig? GetConnectionConfig()</code>
                    </div>
                    <p>Get the currently configured connection.</p>

                    <h3>IsConnectionConfigured</h3>
                    <div class="api-signature">
                        <code>public virtual bool IsConnectionConfigured()</code>
                    </div>
                    <p>Check if connection is configured and valid.</p>
                </section>

                <!-- Virtual Methods Section -->
                <section class="section" id="virtual-methods">
                    <h2>Virtual Methods</h2>
                    <p>These methods provide default implementations that can be overridden by derived classes.</p>

                    <h3>ClassifyTextAsync</h3>
                    <div class="api-signature">
                        <code>public virtual async Task&lt;TransformerResult&lt;ClassificationResult&gt;&gt; ClassifyTextAsync(string text, ClassificationParameters? parameters = null)</code>
                    </div>
                    <p>Perform text classification with base implementation.</p>

                    <h3>ExtractEntitiesAsync</h3>
                    <div class="api-signature">
                        <code>public virtual async Task&lt;TransformerResult&lt;List&lt;EntityResult&gt;&gt;&gt; ExtractEntitiesAsync(string text, NERParameters? parameters = null)</code>
                    </div>
                    <p>Perform named entity recognition with base implementation.</p>

                    <h3>GetEmbeddingsAsync</h3>
                    <div class="api-signature">
                        <code>public virtual async Task&lt;TransformerResult&lt;List&lt;float[]&gt;&gt;&gt; GetEmbeddingsAsync(List&lt;string&gt; texts, EmbeddingParameters? parameters = null)</code>
                    </div>
                    <p>Generate text embeddings with base implementation.</p>

                    <h3>WarmUpAsync</h3>
                    <div class="api-signature">
                        <code>public virtual async Task&lt;bool&gt; WarmUpAsync(string? sampleInput = null)</code>
                    </div>
                    <p>Warm up the model with a sample input to improve first-request performance.</p>

                    <div class="code-example">
                        <h5>Example Usage</h5>
                        <pre><code class="language-csharp">// Warm up the model after loading
await pipeline.LoadModelAsync(modelInfo, TransformerTask.TextGeneration);
await pipeline.WarmUpAsync("This is a warmup input.");

// First real request will now be faster
var result = await pipeline.GenerateTextAsync("Actual user prompt");</code></pre>
                    </div>
                </section>

                <!-- Protected Helper Methods Section -->
                <section class="section" id="protected-helpers">
                    <h2>Protected Helper Methods</h2>
                    <p>These methods are available to derived classes for implementing provider-specific functionality.</p>

                    <h3>ExecutePythonCodeAsync</h3>
                    <div class="api-signature">
                        <code>protected async Task&lt;(bool Success, string? Result, string? ErrorMessage)&gt; ExecutePythonCodeAsync(string pythonCode, PythonSessionInfo? session = null)</code>
                    </div>
                    <p>Execute Python code asynchronously using configured session or creating a temporary one.</p>

                    <h3>ParseInferenceResult&lt;T&gt;</h3>
                    <div class="api-signature">
                        <code>protected (bool success, T? data, string? error) ParseInferenceResult&lt;T&gt;(string jsonResult)</code>
                    </div>
                    <p>Parse inference result from JSON with proper error handling.</p>

                    <h3>GetHuggingFaceTaskName</h3>
                    <div class="api-signature">
                        <code>protected string GetHuggingFaceTaskName(TransformerTask taskType)</code>
                    </div>
                    <p>Get HuggingFace task name from TransformerTask enum.</p>

                    <h3>GetDeviceConfig</h3>
                    <div class="api-signature">
                        <code>protected string GetDeviceConfig()</code>
                    </div>
                    <p>Get device configuration string for Python execution.</p>

                    <h3>UpdateModelState</h3>
                    <div class="api-signature">
                        <code>protected virtual void UpdateModelState(string modelName, TransformerModelSource modelSource, TransformerTask taskType, Dictionary&lt;string, object&gt;? modelConfig)</code>
                    </div>
                    <p>Update internal model state after successful loading.</p>
                </section>

                <!-- Event Handling Section -->
                <section class="section" id="event-handling">
                    <h2>Event Handling</h2>

                    <div class="code-example">
                        <h4>Subscribe to Events</h4>
                        <pre><code class="language-csharp">// Subscribe to pipeline events
pipeline.ModelLoadingStarted += (sender, args) => 
    Console.WriteLine($"Loading model: {args.ModelName}");

pipeline.ModelLoadingCompleted += (sender, args) => 
    Console.WriteLine($"Model loaded: {args.ModelName}");

pipeline.InferenceStarted += (sender, args) => 
    Console.WriteLine($"Inference started for: {args.ModelName}");

pipeline.InferenceCompleted += (sender, args) => 
    Console.WriteLine($"Inference completed for: {args.ModelName}");

pipeline.ErrorOccurred += (sender, args) => 
    Console.WriteLine($"Error: {args.ErrorMessage}");

pipeline.ProgressUpdated += (sender, args) => 
    Console.WriteLine($"Progress: {args.ProgressPercentage}% - {args.Message}");</code></pre>
                    </div>

                    <h3>Protected Event Methods</h3>
                    <div class="parameter-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Method</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>OnModelLoadingStarted</code></td>
                                    <td>Fire model loading started event</td>
                                </tr>
                                <tr>
                                    <td><code>OnModelLoadingCompleted</code></td>
                                    <td>Fire model loading completed event</td>
                                </tr>
                                <tr>
                                    <td><code>OnInferenceStarted</code></td>
                                    <td>Fire inference started event</td>
                                </tr>
                                <tr>
                                    <td><code>OnInferenceCompleted</code></td>
                                    <td>Fire inference completed event</td>
                                </tr>
                                <tr>
                                    <td><code>OnErrorOccurred</code></td>
                                    <td>Fire error occurred event</td>
                                </tr>
                                <tr>
                                    <td><code>OnProgressUpdated</code></td>
                                    <td>Fire progress updated event</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Implementation Guide Section -->
                <section class="section" id="implementation-guide">
                    <h2>Implementation Guide</h2>

                    <h3>Creating a Custom Provider</h3>
                    <div class="code-example">
                        <h4>Custom Pipeline Implementation</h4>
                        <pre><code class="language-csharp">public class CustomTransformerPipeline : BaseTransformerPipeline
{
    public CustomTransformerPipeline(
        IPythonRunTimeManager pythonRunTimeManager,
        IPythonCodeExecuteManager executeManager)
        : base(pythonRunTimeManager, executeManager)
    {
    }

    public override async Task&lt;bool&gt; InitializeAsync(TransformerPipelineConfig config)
    {
        try
        {
            // Provider-specific initialization
            _pipelineConfig = config;
            _isInitialized = true;
            return true;
        }
        catch (Exception ex)
        {
            OnErrorOccurred("Initialization failed", ex);
            return false;
        }
    }

    public override async Task&lt;bool&gt; LoadModelAsync(
        TransformerModelInfo modelInfo, 
        TransformerTask taskType, 
        Dictionary&lt;string, object&gt;? modelConfig = null)
    {
        try
        {
            OnModelLoadingStarted(modelInfo.Name, taskType);
            
            // Provider-specific model loading logic
            // ...
            
            UpdateModelState(modelInfo.Name, modelInfo.Source, taskType, modelConfig);
            OnModelLoadingCompleted(modelInfo.Name, taskType);
            return true;
        }
        catch (Exception ex)
        {
            OnErrorOccurred($"Failed to load model {modelInfo.Name}", ex);
            return false;
        }
    }

    public override async Task&lt;TransformerResult&lt;string&gt;&gt; GenerateTextAsync(
        string prompt, 
        TextGenerationParameters? parameters = null)
    {
        try
        {
            OnInferenceStarted(_modelName ?? "", _taskType);
            
            // Generate Python code for this provider
            var pythonCode = GenerateProviderSpecificCode(prompt, parameters);
            
            // Execute using base class helper
            var (success, result, error) = await ExecutePythonCodeAsync(pythonCode);
            
            if (success)
            {
                var parsedResult = ParseInferenceResult&lt;string&gt;(result);
                OnInferenceCompleted(_modelName ?? "", _taskType);
                
                return new TransformerResult&lt;string&gt;
                {
                    Success = parsedResult.success,
                    Data = parsedResult.data ?? "",
                    ErrorMessage = parsedResult.error,
                    ModelName = _modelName ?? "",
                    TaskType = _taskType
                };
            }
            else
            {
                return new TransformerResult&lt;string&gt;
                {
                    Success = false,
                    ErrorMessage = error ?? "Unknown error",
                    ModelName = _modelName ?? "",
                    TaskType = _taskType
                };
            }
        }
        catch (Exception ex)
        {
            OnErrorOccurred("Text generation failed", ex);
            return new TransformerResult&lt;string&gt;
            {
                Success = false,
                ErrorMessage = ex.Message,
                ModelName = _modelName ?? "",
                TaskType = _taskType
            };
        }
    }

    private string GenerateProviderSpecificCode(string prompt, TextGenerationParameters? parameters)
    {
        // Implementation specific to your provider
        return $@"
import your_provider_library

# Your provider-specific code here
result = your_provider_library.generate('{prompt}')
print(result)
";
    }
}</code></pre>
                    </div>
                </section>

                <!-- Best Practices Section -->
                <section class="section" id="best-practices">
                    <h2>Best Practices</h2>

                    <div class="tip">
                        <strong>üí° Session Management</strong>
                        <p>Use ConfigureSession for multi-user environments and avoid relying on temporary sessions in production.
                        </p>
                    </div>

                    <div class="success">
                        <strong>‚úÖ Connection Configuration</strong>
                        <p>Configure connections before initializing and never hard-code API keys in source code.</p>
                    </div>

                    <div class="warning">
                        <strong>‚ö†Ô∏è Error Handling</strong>
                        <p>Always implement proper error handling and subscribe to error events for monitoring.</p>
                    </div>

                    <div class="note">
                        <strong>üìù Resource Management</strong>
                        <p>Always dispose pipeline instances properly to prevent resource leaks.</p>
                    </div>
                </section>

                <!-- See Also Section -->
                <section class="section" id="see-also">
                    <h2>See Also</h2>
                    <ul class="member-list">
                        <li>
                            <div class="member-name">ITransformerPipeLine</div>
                            <div class="member-type">Interface</div>
                            <div class="member-desc">Core interface definition</div>
                        </li>
                        <li>
                            <div class="member-name">TransformerPipelineFactory</div>
                            <div class="member-type">Static Class</div>
                            <div class="member-desc">Factory for creating pipelines</div>
                        </li>
                        <li>
                            <div class="member-name">TransformerConnectionConfig</div>
                            <div class="member-type">Abstract Class</div>
                            <div class="member-desc">Base configuration class for provider connections</div>
                        </li>
                    </ul>
                </section>

                <!-- Footer -->
                <footer class="documentation-footer">
                    <div class="footer-content">
                        <div class="footer-copyright">
                            <p>&copy; 2024 The Tech Idea - Beep.Python.AI.Transformers API Documentation</p>
                        </div>
                        <div class="footer-links">
                            <a href="../index.html">Home</a>
                            <a href="ITransformerPipeLine.html">ITransformerPipeLine</a>
                            <a href="TransformerPipelineFactory.html">TransformerPipelineFactory</a>
                        </div>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="../assets/navigation.js"></script>
</body>

</html>